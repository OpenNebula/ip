import $ from"jquery";import"jquery-ui/ui/core";import"jquery-ui/ui/widgets/dialog";let WMKS={};!function(){function e(e){const t=e.length,i=new Array(Math.ceil(t/8));let s,n;for(s=0,n=0;s<t;s+=8,n++)i[n]=String.fromCharCode(e[s],e[s+1],e[s+2],e[s+3],e[s+4],e[s+5],e[s+6],e[s+7]);return i.join("").substr(0,t)}function t(e,t){const i=e.length,s=t?new Uint8Array(i):new Array(i);let n;for(n=0;n+7<i;n+=8)s[n]=e.charCodeAt(n),s[n+1]=e.charCodeAt(n+1),s[n+2]=e.charCodeAt(n+2),s[n+3]=e.charCodeAt(n+3),s[n+4]=e.charCodeAt(n+4),s[n+5]=e.charCodeAt(n+5),s[n+6]=e.charCodeAt(n+6),s[n+7]=e.charCodeAt(n+7);for(;n<i;n++)s[n]=e.charCodeAt(n);return s}function i(e){"use strict";const t=e,i=[];this.getImage=function(){return i.length>0?i.shift():new Image},this.releaseImage=function(e){e&&function(e){e.onload=e.onerror=null;const s=[71,73,70,56,57,97,1,0,1,0,0,255,0,44,0,0,0,0,1,0,1,0,0,2,0,59];s.push32($.now()),e.src="data:image/gif;base64,"+o.encodeFromArray(s),i.length<=t?i.push(e):function(e){delete e[0],e[0]=null,e=null}([e])}(e)}}function s(){this._mediaSource=null,this._sourceBuffer=null,this._tempQueue=[],this._mediaPlayer=null,this._isError=!1,this._isErrorDoneCalled=!1,this._sendRequest=0,this._doneRequest=0,this._decodeDoneCb=null,this._decodeErrorCb=null,s.instanceNumber++,this._name="MP4Decoder"+s.instanceNumber}function n(i){WMKS.LOGGER.debug("adding uint8utf8 support");const s=i;s.hasOwnProperty("_legacyReceiveQueue")||(s._legacyReceiveQueue="",s._legacyReceiveQueueIndex=""),s.useLegacy=!1;var n={_receiveQueueBytesUnread:function(){return this._legacyReceiveQueue.length-this._legacyReceiveQueueIndex},_receiveQueueConsumeBytes:function(e){this._legacyReceiveQueueIndex+=e},_receiveQueueReset:function(){this._legacyReceiveQueue="",this._legacyReceiveQueueIndex=0},_readString:function(e){const t=this._legacyReceiveQueue.slice(this._legacyReceiveQueueIndex,this._legacyReceiveQueueIndex+e);return this._legacyReceiveQueueIndex+=e,t},_readStringUTF8:function(e){let t,i,s,n;const o=[];let r=this._legacyReceiveQueueIndex;for(;r<this._legacyReceiveQueueIndex+e;)(t=this._legacyReceiveQueue.charCodeAt(r))<128?(o.push(t),r++):t<224?(i=63&this._legacyReceiveQueue.charCodeAt(r+1),o.push((31&t)<<6|i),r+=2):t<240?(i=63&this._legacyReceiveQueue.charCodeAt(r+1),s=63&this._legacyReceiveQueue.charCodeAt(r+2),o.push((15&t)<<12|i<<6|s),r+=3):(i=63&this._legacyReceiveQueue.charCodeAt(r+1),s=63&this._legacyReceiveQueue.charCodeAt(r+2),n=63&this._legacyReceiveQueue.charCodeAt(r+3),o.push((7&t)<<18|i<<12|s<<6|n),r+=4);return this._legacyReceiveQueueIndex+=e,String.fromCharCode.apply(String,o)},_readByte:function(){const e=this._legacyReceiveQueue.charCodeAt(this._legacyReceiveQueueIndex);return this._legacyReceiveQueueIndex+=1,e},_readBytes:function(e){let t,i;for(t=new Array(e),i=0;i<e;i++)t[i]=this._legacyReceiveQueue.charCodeAt(i+this._legacyReceiveQueueIndex);return this._legacyReceiveQueueIndex+=e,t},_sendString:function(e){this._websocket&&this._websocket.send(e)},_sendBytes:function(t){this._sendString(e(t))},_sendClientEncodingsMsg:function(){let e,t=[this.encTightPNG,this.encDesktopSize,this.encVMWDefineCursor,this.encVMWCursorState,this.encVMWCursorPosition,this.encVMWTypematicInfo,this.encVMWLEDState,this.encVMWServerPush2,this.encVMWServerCaps,this.encTightJpegQuality10,this.encVMWFrameStamp,this.encUpdateCache];this.options.mediaPlayer&&t.unshift(this.encH264MP4),this._canvas[1]&&(t=[this.encOffscreenCopyRect].concat(t)),t=[this.encCopyRect].concat(t);const i=[];for(i.push8(this.msgClientEncodings),i.push8(0),i.push16(t.length),e=0;e<t.length;e+=1)i.push32(t[e]);this._sendBytes(i)},_readTightData:function(e){const i=e.subEncoding===this.subEncPNG?"image/png":"image/jpeg";let s=this._readString(this.nextBytes);const n=window.URL||window.webkitURL,r=this;this._useImageBitmaps?(s=t(s,!0),createImageBitmap(new Blob([s],{type:i})).then(function(t){e.image=t,r.onDecodeComplete()})):(e.image=this._imageManager.getImage(),e.image.width=e.width,e.image.height=e.height,e.image.destX=e.x,e.image.destY=e.y,n?(s=t(s,!0),e.image.onload=this.onDecodeObjectURLComplete,e.image.src=n.createObjectURL(new Blob([s],{type:i}))):(s=o.encodeFromString(s),e.image.onload=this.onDecodeComplete,e.image.src="data:"+i+";base64,"+s)),this._nextRect()},_peekFirstMessage:function(){this.usedVNCHandshake=12==this._receiveQueueBytesUnread(),this.usedVNCHandshake?this._setReadCB(12,this._handleProtocolVersionMsg):this._setReadCB(24,this._handleServerInitializedMsg)}};s.wsOpen=function(e){if(s._state=s.VNC_ACTIVE_STATE,"uint8utf8"!==this.protocol&&"binary"!==this.protocol&&"vmware-vvc"!==this.protocol)return s.fail("no agreement on protocol");"vmware-vvc"===this.protocol&&(s._setupVVC(),WMKS.LOGGER.log("WebSocket is using VMware Virtual Channels"),this.protocol="binary"),"binary"===this.protocol&&(this.binaryType="arraybuffer",WMKS.LOGGER.log("WebSocket HAS binary support")),s.useLegacy="uint8utf8"===this.protocol,s.useLegacy?function(e){WMKS.LOGGER.trace("uint8utf8: replacing functions"),e._originalFunctions=e._originalFunctions||{};for(const t in n)n.hasOwnProperty(t)&&(e._originalFunctions[t]||(e._originalFunctions[t]=e[t]),e[t]=n[t])}(s):function(e){if(WMKS.LOGGER.trace("restoreFunctions"),e._originalFunctions)for(const t in e._originalFunctions)e._originalFunctions.hasOwnProperty(t)&&(e[t]=e._originalFunctions[t])}(s),s.options.onConnecting(s.vvc,s.vvcSession),WMKS.LOGGER.log("WebSocket created protocol: "+this.protocol)};const r=s.wsMessage;s.wsMessage=function(t){if(!s.useLegacy)return r.apply(this,arguments);if(s._legacyReceiveQueueIndex>s._legacyReceiveQueue.length)return s.fail("overflow receiveQueue");if(s._legacyReceiveQueueIndex===s._legacyReceiveQueue.length&&(s._legacyReceiveQueue="",s._legacyReceiveQueueIndex=0),"string"!=typeof t.data){const i=new Uint8Array(t.data);s._legacyReceiveQueue=s._legacyReceiveQueue.concat(e(i))}else s._legacyReceiveQueue=s._legacyReceiveQueue.concat(t.data);s._processMessages()},-1===s.protocolList.indexOf("uint8utf8")&&s.protocolList.push("uint8utf8"),n._receiveQueueReset.call(s)}var o={decodeToArray:function(e,i){return t(window.atob(e),i)},decodeToString:function(e){return window.atob(e)},encodeFromArray:function(t){return window.btoa(e(t))},encodeFromString:function(e){return window.btoa(e)}};(WMKS={}).LOGGER=new function(){this.LEVEL={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4};let e=this.LEVEL.INFO;const t=[" [Trace] "," [Debug] "," [Info ] "," [Warn ] "," [Error] "];this.trace=function(e){this.log(e,this.LEVEL.TRACE)},this.debug=function(e){this.log(e,this.LEVEL.DEBUG)},this.info=function(e){this.log(e,this.LEVEL.INFO)},this.warn=function(e){this.log(e,this.LEVEL.WARN)},this.error=function(e){this.log(e,this.LEVEL.ERROR)},this.log="undefined"==typeof console||void 0===console.log?$.noop:function(i,s){(s=void 0===s?this.LEVEL.INFO:s)>=e&&i&&console.log((WMKS.BROWSER.isIE()?(new Date).toUTCString():(new Date).toISOString())+t[s]+i)},this.setLogLevel=function(i){"number"==typeof i&&i>=0&&i<t.length?e=i:this.log("Invalid input logLevel: "+i)}},WMKS.BROWSER=new function(){const e=navigator.userAgent.toLowerCase(),t=(navigator.appVersion.toString(),function(){return!0}),i=function(){return!1};this.isIE=-1!==e.indexOf("msie")||-1!==e.indexOf("trident")||-1!==e.indexOf("edge")?t:i,this.isOpera=-1!==e.indexOf("opera/")||-1!==e.indexOf("opr/")?t:i,this.isWebkit=this.isChrome=this.isSafari=this.isBB=i,!this.isIE()&&!this.isOpera()&&-1!==e.indexOf("applewebkit")&&(this.isWebkit=t,-1!==e.indexOf("chrome")?this.isChrome=t:-1!==e.indexOf("bb")?this.isBB=t:-1!==e.indexOf("safari")&&(this.isSafari=t)),this.isGecko=this.isWebkit()||this.isIE()||-1===e.indexOf("gecko")?i:t,this.isFirefox=-1!==e.indexOf("firefox")||-1!==e.indexOf("iceweasel")?t:i,this.isLowBandwidth=-1!==e.indexOf("mobile")?t:i,this.isIOS=-1!==e.indexOf("iphone")||-1!==e.indexOf("ipod")||-1!==e.indexOf("ipad")?t:i,this.isAndroid=-1!==e.indexOf("android")?t:i,this.isIEMobile=-1!==e.indexOf("IEMobile")?t:i,this.hasTouchInput="ontouchstart"in window||navigator.maxTouchPoints||navigator.msMaxTouchPoints?t:i;try{this.isChromeClient=!!chrome&&!!chrome.management}catch(e){this.isChromeClient=!1}this.isChromeOS=-1!==e.indexOf("cros")?t:i,this.isWindows=-1!==e.indexOf("windows")?t:i,this.isLinux=-1!==e.indexOf("linux")?t:i,this.isMacOS=-1!==e.indexOf("macos")||e.indexOf("macintosh")>-1?t:i,this.isMobileTouchDevice=this.isIOS()||this.isAndroid()||this.isBB()?t:i,this.isTouchDevice=this.isMobileTouchDevice()||this.isChromeClient?t:i;const s=function(t,i){const s=e.match(t);return s&&s.length>i&&s[i]||""};this.version={full:""},this.isSafari()?this.version.full=s(/Version[ \/]([0-9\.]+)/i,1):this.isChrome()?this.version.full=s(/Chrome\/([0-9\.]+)/i,1):this.isFirefox()?this.version.full=s(/(?:Firefox|Iceweasel)[ \/]([0-9\.]+)/i,1):this.isOpera()?this.version.full=s(/Version[ \/]([0-9\.]+)/i,1)||s(/(?:opera|opr)[\s\/]([0-9\.]+)/i,1):this.isIE()&&(this.version.full=s(/(?:\b(MS)?IE\s+|\bTrident\/7\.0;.*\s+rv:|\bEdge\/)([0-9\.]+)/i,2));const n=this.version.full.split(".");this.version.major=parseInt(n.length>0?n[0]:0,10),this.version.minor=parseInt(n.length>1?n[1]:0,10),this.version.float=parseFloat(this.version.full),this.isCanvasSupported=function(){try{let e=document.createElement("canvas");const t=!!e.getContext;return e=null,t}catch(e){return!1}}},WMKS.CONST={CLICK:{left:1,middle:2,right:4},FORCE_RAW_KEY_CODE:{8:!0,9:!0,13:!0}},WMKS.UTIL={createCanvas:function(e){const t={};return e&&(t.position="absolute"),$("<canvas/>").css(t)},createVideo:function(e){const t={};return e&&(t.position="absolute"),$("<video/>").css(t)},getLineLength:function(e,t){return Math.sqrt(Math.pow(e,2)+Math.pow(t,2))},isHighResolutionSupported:function(){return window.devicePixelRatio&&window.devicePixelRatio>1},isFullscreenNow:function(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement)},isFullscreenEnabled:function(){return!(WMKS.BROWSER.isSafari()||!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||document.webkitFullscreenEnabled))},toggleFullScreen:function(e,t){const i=WMKS.UTIL.isFullscreenNow(),s=t||document.documentElement;WMKS.UTIL.isFullscreenEnabled()?i!==e&&(i?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():s.requestFullscreen?s.requestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen?s.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s.msRequestFullscreen&&s.msRequestFullscreen()):WMKS.LOGGER.warn("This browser does not support fullScreen mode.")}},WMKS.BitBuf=function(e,t){return this._buf=e,this._size=t,this._readCount=0,this._overflow=!1,this._thisByte=0,this._thisByteBits=0,this},WMKS.BitBuf.prototype.readBits0=function(e,t){"use strict";let i;return this._bits<t?(this._overflow=!0,-1):(i=~(255>>t),e<<=t,e|=(this._thisByte&i)>>8-t,this._thisByte<<=t,this._thisByte&=255,this._thisByteBits-=t,e)},WMKS.BitBuf.prototype.readBits=function(e){"use strict";let t=0;if(this._overflow)return 0;for(;e>this._thisByteBits;)if(e-=this._thisByteBits,t=this.readBits0(t,this._thisByteBits),this._readCount<this._size)this._thisByte=this._buf[this._readCount++],this._thisByteBits=8;else if(this._thisByte=0,this._thisByteBits=0,e>0)return this._overflow=!0,0;return t=this.readBits0(t,e)},WMKS.BitBuf.prototype.readEliasGamma=function(){"use strict";let e,t,i=0;this._readCount,this._thisByteBits;for(;!this._overflow&&0==(t=this.readBits(1));)i++;return e=1<<i,i&&(e|=this.readBits(i)),e},WMKS.WebSocket=function(e,t){return new window.WebSocket(e,t)},Array.prototype.push8=function(e){this.push(255&e)},Array.prototype.push16=function(e){this.push(e>>8&255,255&e)},Array.prototype.push32=function(e){this.push(e>>24&255,e>>16&255,e>>8&255,255&e)},Array.prototype.push16le=function(e){this.push(255&e,e>>8&255)},Array.prototype.push32le=function(e){this.push(255&e,e>>8&255,e>>16&255,e>>24&255)},s.instanceNumber=0,s.byteStreamFormat='video/mp4; codecs="avc1.640030"',s.prototype.toString=function(){return this._name},s.prototype.init=function(e,t,i,s,n){const o=this,r=t||window.URL||window.webkitURL,a=i||window.MediaSource||window.WebKitMediaSource;this.reset(),this._decodeDoneCb=s,this._decodeErrorCb=n,this._mediaPlayer=e,this._mediaSource=new a,this._mediaPlayer.src=r.createObjectURL(this._mediaSource),this._mediaSource.addEventListener("sourceopen",function(e){return o._onMediaSourceOpen(e)},!1),this._mediaSource.addEventListener("webkitsourceopen",function(e){return o._onMediaSourceOpen(e)},!1)},s.prototype._onMediaSourceOpen=function(e){const t=this;WMKS.LOGGER.log(this+" media source status is changed to open."),"open"===this._mediaSource.readyState?(this._sourceBuffer=this._mediaSource.addSourceBuffer(s.byteStreamFormat),this._sourceBuffer.addEventListener("updateend",function(){0!==t._tempQueue.length&&("add"===t._tempQueue[0].method&&t._decodeDoneCb&&(t._doneRequest++,WMKS.LOGGER.debug(t+" request track: send "+t._sendRequest+" done "+t._doneRequest),t._decodeDoneCb()),t._tempQueue.shift(),t._flushPayloads())}),this._sourceBuffer.addEventListener("error",function(e){WMKS.LOGGER.error(t+" error code is "+e)}),this._flushPayloads()):WMKS.LOGGER.log(this+" media source is not open yet.")},s.prototype._flushPayloads=function(){let e=0,t=0,i=0;if(this._sourceBuffer){if(0!==this._tempQueue.length&&"open"===this._mediaSource.readyState&&!this._sourceBuffer.updating)try{if("add"===this._tempQueue[0].method)this._sourceBuffer.appendBuffer(this._tempQueue[0].payload);else if("remove"===this._tempQueue[0].method){if(e=this._sourceBuffer.buffered.start(0),t=this._sourceBuffer.buffered.end(0),i=this._mediaPlayer.currentTime-.5,WMKS.LOGGER.log(this+" status:  start "+e+" end "+t+" with current time "+this._mediaPlayer.currentTime),!(i>e))throw WMKS.LOGGER.log(this+" it is too close to clear buffer."),this._tempQueue.shift(),"close buffer";WMKS.LOGGER.log(this+" start to remove from "+e+" to "+i),this._sourceBuffer.remove(e,i)}}catch(e){if("QuotaExceededError"===e.name){const e=this;WMKS.LOGGER.log(this+" browser is full."),setTimeout(function(){e._tempQueue.unshift({method:"remove"}),e._flushPayloads()},0)}else WMKS.LOGGER.error(this+" encounters a unrecoverable error. "+e),this._isError=!0,this._decodeDoneCb&&this._decodeDoneCb(),this._decodeErrorCb&&!this._isErrorDoneCalled&&(this._isErrorDoneCalled=!0,this._decodeErrorCb())}}else WMKS.LOGGER.log(this+"source buffer is not ready yet.")},s.prototype.reset=function(){WMKS.LOGGER.log(this+" is reset."),this._mediaSource&&(this._sourceBuffer&&(this._mediaSource.removeSourceBuffer(this._sourceBuffer),this._sourceBuffer=null),"open"===this._mediaSource.readyState&&this._mediaSource.endOfStream(),this._mediaSource=null),this._mediaPlayer&&(this._mediaPlayer.src="",this._mediaPlayer=null),this._sendRequest=0,this._doneRequest=0,this._decodeDoneCb=null,this._decodeErrorCb=null,this._isError=!1,this._isErrorDoneCalled=!1,this._tempQueue=[]},s.prototype.appendData=function(e){if(this._isError)return WMKS.LOGGER.log(this+" is in error state."),void(this._decodeDoneCb&&this._decodeDoneCb());this._sendRequest++,this._tempQueue.push({method:"add",payload:e}),this._flushPayloads(),this._mediaPlayer&&this._mediaPlayer.paused&&this._mediaPlayer.play()},function(){function e(e){let t=0,i=0;const s=$.event.dispatch||$.event.handle;if("detail"in e&&(i=-1*e.detail),"wheelDelta"in e&&(i=e.wheelDelta),"wheelDeltaY"in e&&(i=e.wheelDeltaY),"wheelDeltaX"in e&&(t=-1*e.wheelDeltaX),"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=-1*i,i=0),"deltaY"in e&&(i=-1*e.deltaY),"deltaX"in e&&(t=e.deltaX),0!==i||0!==t)return(e=$.event.fix(e)).type="mousewheel",delete e.wheelDelta,e.wheelDeltaX=t,e.wheelDeltaY=i,s.call(this,e)}const t="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],i=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"];if($.event.fixHooks)for(let e=i.length;e;)$.event.fixHooks[i[--e]]=$.event.mouseHooks;$.event.special.mousewheel={setup:function(){if(this.addEventListener){let i;for(i=0;i<t.length;i++)this.addEventListener(t[i],e,!1)}else this.onmousewheel=e},tearDown:function(){if(this.removeEventListener){let i;for(i=0;i<t.length;i++)this.removeEventListener(t[i],e,!1)}else this.onmousewheel=e}}}(),WMKS.VNCDecoder=function(e){return this.options=$.extend({},this.options,e),$.extend(this,{useVMWRequestResolution:!1,useVMWRequestStreamState:!1,useVMWRequestMultiMon:!1,useVMWKeyEvent:!1,allowVMWKeyEvent2UnicodeAndRaw:!1,useVMWAck:!1,useVMWAudioAck:!1,useVMWSessionClose:!1,serverSupportsMKSVChanClipboard:!1,vvc:null,vvcSession:null,_websocket:null,_encrypted:!1,_receivedFirstUpdate:!1,_serverInitialized:!1,_canvas:[],_currentCursorURI:"default",_cursorVisible:!0,_imageCache:[],_copyRectBlit:null,_copyRectOffscreenBlit:null,_state:this.DISCONNECTED,_FBWidth:0,_FBHeight:0,_FBName:"",_FBBytesPerPixel:0,_FBDepth:3,_mouseButtonMask:0,_mouseX:0,_mouseY:0,onDecodeComplete:{},rects:0,rectsRead:0,rectsDecoded:0,requestedWidth:0,requestedHeight:0,decodeToCacheEntry:-1,updateCache:[],updateCacheEntries:0,cacheFlags:0,resolutionTimeout:{},resolutionTimer:null,resolutionRequestActive:!1,updateReqId:0,typematicState:1,typematicPeriod:33333,typematicDelay:5e5,_keyboardLEDs:0,_streamState:0,_frameTimestampLo:0,_frameTimestampHi:0,rect:[],_msgTimer:null,_mouseTimer:null,_mouseActive:!1,msgTimeout:{},mouseTimeout:{},_retryConnectionTimer:null,_url:"",_receiveQueue:[],_receiveQueueIndex:0,_receiveQueueLength:0,_multimonRenderer:null,_isInMultimonMode:!1,_multiMonRects:null}),this.setRenderCanvas(this.options.canvas),this.options.backCanvas&&(this._canvas=this._canvas.concat([this.options.backCanvas]),this._canvas[1].ctx=this.options.backCanvas.getContext("2d")),this.options.blitTempCanvas&&(this._canvas=this._canvas.concat([this.options.blitTempCanvas]),this._canvas[2].ctx=this.options.blitTempCanvas.getContext("2d")),this.options.mediaPlayer&&(this._mp4Decoder=new s),this.options.multimonRenderer&&(this._multimonRenderer=this.options.multimonRenderer),"undefined"!=typeof createImageBitmap?(this._useImageBitmaps=!0,this._imageManager=null):this._imageManager=new i(256),this._releaseImage=function(e){this._imageManager?this._imageManager.releaseImage(e):"function"==typeof e.close&&e.close()},this},$.extend(WMKS.VNCDecoder.prototype,{options:{canvas:null,backCanvas:null,blitTempCanvas:null,VCDProxyHandshakeVmxPath:null,useUnicodeKeyboardInput:!1,enableVorbisAudioClips:!1,enableOpusAudioClips:!1,enableAacAudioClips:!1,enableVVC:!0,enableUint8Utf8:!1,enableVMWSessionClose:!1,enableSubRectangleCache:!0,retryConnectionInterval:-1,sendRelativeMouseEvent:!1,onConnecting:function(){},onConnected:function(){},onBeforeDisconnected:function(){},onDisconnected:function(){},onAuthenticationFailed:function(){},onError:function(e){},onProtocolError:function(){},onNewDesktopSize:function(e,t){},onKeyboardLEDsChanged:function(e){},onCursorStateChanged:function(e){},onHeartbeat:function(e){},onUpdateCopyPasteUI:function(e,t){},onMultimonCapacityUpdated:function(e){},onCopy:function(e){},onSetReconnectToken:function(e){},onAudio:function(e){},onAudioMixer:function(e){},onEncodingChanged:function(e){},onCursorUrlChanged:function(e){},onCursorPositionChanged:function(e){},cacheSizeKB:102400,cacheSizeEntries:1024},DISCONNECTED:0,VNC_ACTIVE_STATE:1,FBU_DECODING_STATE:2,FBU_RESTING_STATE:3,msgFramebufferUpdate:0,msgSetColorMapEntries:1,msgRingBell:2,msgServerCutText:3,msgVMWSrvMessage:127,msgVMWSrvMessage_ServerCaps:0,msgVMWSrvMessage_Audio:3,msgVMWSrvMessage_Heartbeat:4,msgVMWSrvMessage_SetReconnectToken:6,msgVMWSrvMessage_SessionClose:7,msgVMWSrvMessage_AudioMixer:8,msgClientEncodings:2,msgFBUpdateRequest:3,msgKeyEvent:4,msgPointerEvent:5,msgVMWClientMessage:127,msgVMWKeyEvent:0,msgVMWPointerEvent2:2,msgVMWKeyEvent2:6,msgVMWAudioAck:7,msgVMWSessionClose:12,msgVMWRequestStreamState:15,encRaw:0,encCopyRect:1,encTightPNG:-260,encDesktopSize:-223,encH264RectEnc:1464686100,encTightDiffComp:1464686102,encH264MP4:1464686104,encVMWDefineCursor:1464686180,encVMWCursorState:1464686181,encVMWCursorPosition:1464686182,encVMWTypematicInfo:1464686183,encVMWLEDState:1464686184,encVMWServerPush2:1464686203,encVMWServerCaps:1464686202,encVMWFrameStamp:1464686204,encOffscreenCopyRect:1464686206,encUpdateCache:1464686207,encTopologyChangeEnc:1464686208,encH264MultimonEnc:1464686209,encTightJpegQuality10:-23,diffCompCopyFromPrev:1,diffCompAppend:2,diffCompAppendRemaining:3,updateCacheOpInit:0,updateCacheOpBegin:1,updateCacheOpEnd:2,updateCacheOpReplay:3,updateCacheCapDisableOffscreenSurface:2,updateCacheCapReplay:4,updateCacheCapSubRectangle:256,serverCapKeyEvent:2,serverCapClientCaps:8,serverCapUpdateAck:32,serverCapRequestResolution:128,serverCapKeyEvent2Unicode:256,serverCapKeyEvent2JSKeyCode:512,serverCapAudioAck:1024,serverCapMultiMon:4096,serverCapUpdateCacheInfo:8192,serverCapDisablingCopyUI:16384,serverCapDisablingPasteUI:32768,serverCapSessionClose:131072,serverCapHasMKSVChanClipboard:262144,serverCapRequestStreamState:4194304,clientCapHeartbeat:256,clientCapVorbisAudioClips:512,clientCapAacAudioClips:2048,clientCapAudioAck:4096,clientCapSetReconnectToken:16384,clientCapSessionClose:32768,clientCapUseMKSVChanClipboard:65536,clientCapUseAudioMixer:131072,clientCapOpusAudioClips:1048576,streamStateDisableAudio:1,streamStateDisableVideo:2,audioflagRequestAck:1,audioflagFmtMask:63<<24,audioflagFmtShift:24,audioFlagFmtClipsVorbis:4,audioFlagFmtClipsOpus:5,audioFlagFmtClipsAac:6,subEncFill:128,subEncJPEG:144,subEncPNG:160,subEncDiffJpeg:176,subEncMask:240,mouseTimeResolution:16,resolutionDelay:300}),WMKS.VNCDecoder.prototype.fail=function(e){return WMKS.LOGGER.log(e),this.disconnect(),null},WMKS.VNCDecoder.prototype._assumeServerIsVMware=function(){this.usedVNCHandshake&&(this.useVMWKeyEvent=!0)},WMKS.VNCDecoder.prototype._receiveQueueBytesUnread=function(){return this._receiveQueueLength-this._receiveQueueIndex},WMKS.VNCDecoder.prototype._receiveQueueConsumeBytes=function(e){for(this._receiveQueueIndex+=e;this._receiveQueueIndex>0&&this._receiveQueue[0].data.byteLength<=this._receiveQueueIndex;)this._receiveQueueLength-=this._receiveQueue[0].data.byteLength,this._receiveQueueIndex-=this._receiveQueue[0].data.byteLength,this._receiveQueue.shift()},WMKS.VNCDecoder.prototype._receiveQueueReset=function(){this._receiveQueue=[],this._receiveQueueLength=0,this._receiveQueueIndex=0},WMKS.VNCDecoder.prototype._readBytes=function(e){"use strict";if(this._receiveQueueIndex+e<=this._receiveQueue[0].data.byteLength){var t=new Uint8Array(this._receiveQueue[0].data,this._receiveQueueIndex,e);return this._receiveQueueConsumeBytes(e),t}t=new Uint8Array(e);let i=0;for(;e>0;){const s=Math.min(e,this._receiveQueue[0].data.byteLength-this._receiveQueueIndex),n=new Uint8Array(this._receiveQueue[0].data,this._receiveQueueIndex,s);t.set(n,i),i+=s,e-=s,this._receiveQueueConsumeBytes(s)}return t},WMKS.VNCDecoder.prototype._readByte=function(){"use strict";return this._readBytes(1)[0]},WMKS.VNCDecoder.prototype._skipBytes=function(e){this._receiveQueueConsumeBytes(e)},WMKS.VNCDecoder.prototype._readString=function(t){"use strict";return e(this._readBytes(t))},WMKS.VNCDecoder.prototype._readStringUTF8=function(e){"use strict";let t,i,s,n;const o=[];let r=0;const a=this._readBytes(e);for(;r<e;)(t=a[r])<128?(o.push(t),r++):t<224?(i=63&a[r+1],o.push((31&t)<<6|i),r+=2):t<240?(i=63&a[r+1],s=63&a[r+2],o.push((15&t)<<12|i<<6|s),r+=3):(i=63&a[r+1],s=63&a[r+2],n=63&a[r+3],o.push((7&t)<<18|i<<12|s<<6|n),r+=4);return String.fromCharCode.apply(String,o)},WMKS.VNCDecoder.prototype._readInt16=function(){"use strict";const e=this._readBytes(2);return(e[0]<<8)+e[1]},WMKS.VNCDecoder.prototype._readInt32=function(){"use strict";const e=this._readBytes(4);return(e[0]<<24)+(e[1]<<16)+(e[2]<<8)+e[3]},WMKS.VNCDecoder.prototype._sendString=function(e){this._sendBytes(t(e))},WMKS.VNCDecoder.prototype._sendBytes=function(e){"use strict";if(!this._websocket)return;const t=new ArrayBuffer(e.length),i=new Uint8Array(t);let s;for(s=0;s<e.length;s++)i[s]=e[s];this._websocket.send(t)},WMKS.VNCDecoder.prototype._setReadCB=function(e,t,i){this.nextBytes=e,this.nextFn=t,this.nextArg=i},WMKS.VNCDecoder.prototype._sendMouseEvent=function(){var e;this.options.sendRelativeMouseEvent?((e=[]).push8(this.msgVMWClientMessage),e.push8(this.msgVMWPointerEvent2),e.push16(19),e.push8(0),e.push32(this._mouseX),e.push32(this._mouseY),e.push32(this._mouseButtonMask),e.push8(0),e.push8(0),this._sendBytes(e),this._mouseActive=!1):((e=[]).push8(this.msgPointerEvent),e.push8(this._mouseButtonMask),e.push16(this._mouseX),e.push16(this._mouseY),this._sendBytes(e),this._mouseActive=!1)},WMKS.VNCDecoder.prototype._sendResolutionRequest=function(){const e=[];e.push8(this.msgVMWClientMessage),e.push8(5),e.push16(8),e.push16(this.requestedWidth),e.push16(this.requestedHeight),this._sendBytes(e)},WMKS.VNCDecoder.prototype._sendTopologyRequest=function(e){const t=[];let i=0;for(t.push8(this.msgVMWClientMessage),t.push8(10),t.push16(6+20*e.length),t.push16(e.length),i=0;i<e.length;i++)t.push32(e[i].left),t.push32(e[i].top),t.push32(e[i].requestedWidth),t.push32(e[i].requestedHeight),t.push32(0);this._sendBytes(t)},WMKS.VNCDecoder.prototype._customRendererEnabled=function(){return this._isInMultimonMode&&!!this._multimonRenderer},WMKS.VNCDecoder.prototype._sendClientEncodingsMsg=function(){let e,t=[this.encTightDiffComp,this.encTightPNG,this.encDesktopSize,this.encVMWDefineCursor,this.encVMWCursorState,this.encVMWCursorPosition,this.encVMWTypematicInfo,this.encVMWLEDState,this.encVMWServerPush2,this.encVMWServerCaps,this.encTightJpegQuality10,this.encVMWFrameStamp,this.encUpdateCache];this.options.mediaPlayer&&t.unshift(this.encH264MP4),this.options.enableRawH264&&t.unshift(this.encH264RectEnc),this.options.enableTopologyChange&&t.unshift(this.encToppologyChangeEnc),this.options.enableH264Multimon&&t.unshift(this.encH264MultimonEnc),this._canvas[1]&&(t=[this.encOffscreenCopyRect].concat(t)),t=[this.encCopyRect].concat(t);const i=[];for(i.push8(this.msgClientEncodings),i.push8(0),i.push16(t.length),e=0;e<t.length;e+=1)i.push32(t[e]);this._sendBytes(i)},WMKS.VNCDecoder.prototype._sendFBUpdateRequestMsg=function(e){const t=[];t.push8(this.msgFBUpdateRequest),t.push8(e),t.push16(0),t.push16(0),t.push16(this._FBWidth),t.push16(this._FBHeight),this._sendBytes(t)},WMKS.VNCDecoder.prototype._sendAck=function(e,t){if(this.useVMWAck){const i=10*(e+2),s=[];s.push8(this.msgVMWClientMessage),s.push8(4),s.push16(8),s.push8(t),s.push8(0),s.push16(i),this._sendBytes(s)}else this._sendFBUpdateRequestMsg(t)},WMKS.VNCDecoder.prototype._sendAudioAck=function(e,t){const i=[];i.push8(this.msgVMWClientMessage),i.push8(this.msgVMWAudioAck),i.push16(12),i.push32(e),i.push32(t),this._sendBytes(i)},WMKS.VNCDecoder.prototype._sendRequestStreamState=function(e){if(this._serverInitialized&&this.useVMWRequestStreamState){const t=[];t.push8(this.msgVMWClientMessage),t.push8(this.msgVMWRequestStreamState),t.push16(8),t.push32(e),this._sendBytes(t)}},WMKS.VNCDecoder.prototype._changeCursor=function(e,t,i,s,n,r){function a(e,t,n){!t||(i=t),!n||(s=n),C._currentCursorURI="url("+e+") "+i+" "+s+", default",C._updateCanvasCursor(e)}const c=[],h=n*r*4,d=Math.ceil(n*r/8),u=h+40+2*d;let S,l;for(c.push16le(0),c.push16le(2),c.push16le(1),c.push8(n),c.push8(r),c.push8(0),c.push8(0),c.push16le(i),c.push16le(s),c.push32le(u),c.push32le(c.length+4),c.push32le(40),c.push32le(n),c.push32le(2*r),c.push16le(1),c.push16le(32),c.push32le(0),c.push32le(h+2*d),c.push32le(0),c.push32le(0),c.push32le(0),c.push32le(0),l=r-1;l>=0;l-=1)for(S=0;S<n;S+=1){let i=l*Math.ceil(n/8)+Math.floor(S/8),s=0;t.length>0&&(s=t[i]<<S%8&128?255:0),i=4*(n*l+S),c.push8(e[i]),c.push8(e[i+1]),c.push8(e[i+2]),t.length>0?c.push8(s):c.push8(e[i+3])}for(l=0;l<r;l+=1)for(S=0;S<Math.ceil(n/8);S+=1)c.push8(0);for(l=0;l<r;l+=1)for(S=0;S<Math.ceil(n/8);S+=1)c.push8(0);const _="data:image/x-icon;base64,"+o.encodeFromArray(c);var C=this;if(this.options.cursorHandler){const e=this.options.getShadowCursorScale();this.options.cursorHandler(_,n,r,a,i,s,e)}else a(_)},WMKS.VNCDecoder.prototype._readOffscreenCopyRect=function(e){e.srcBuffer=this._readByte(),e.dstBuffer=this._readByte(),e.srcX=this._readInt16(),e.srcY=this._readInt16(),this._nextRect()},WMKS.VNCDecoder.prototype._readUpdateCacheData=function(e){e.data=this._readBytes(e.dataLength),this._nextRect()},WMKS.VNCDecoder.prototype._readUpdateCacheInitData=function(e){this._skipBytes(4),e.flags=this._readInt32(),e.updateCacheEntries=this._readInt16(),this._skipBytes(4),this._nextRect()},WMKS.VNCDecoder.prototype._readUpdateCacheRect=function(e){e.opcode=this._readByte(),e.slot=this._readInt16(),e.dataLength=this._readInt16(),e.opcode!=this.updateCacheOpInit?this._setReadCB(e.dataLength,this._readUpdateCacheData,e):this._setReadCB(e.dataLength,this._readUpdateCacheInitData,e)},WMKS.VNCDecoder.prototype._readVMWDefineCursorData=function(e){let t,i,s=[],n=[];const o=[];let r,a,c;if(0===e.cursorType)for(e.masklength>0&&(s=this._readBytes(e.masklength)),e.pixelslength>0&&(n=this._readBytes(e.pixelslength)),t=0;t<e.height;t++)for(i=0;i<e.width;i++)if(a=i+t*e.width,c=t*Math.ceil(e.width/8)+Math.floor(i/8),r=1<<7-i%8,255===s[4*a]&&255===s[4*a+1]&&255===s[4*a+2]&&255===s[4*a+3])for(let e=0;e<4;e++)0!==n[4*a+e]&&(n[4*a+e]=0,o[c]|=r);else o[c]|=r;else 1===e.cursorType&&e.pixelslength>0&&(n=this._readBytes(e.pixelslength),4==e.pixelslength&&0==n[3]&&(n[3]=1));this._changeCursor(n,o,e.x,e.y,e.width,e.height),this._nextRect()},WMKS.VNCDecoder.prototype._readVMWDefineCursor=function(e){e.cursorType=this._readByte(),this._skipBytes(1),e.pixelslength=4*e.width*e.height,0===e.cursorType?e.masklength=e.pixelslength:e.masklength=0,this._setReadCB(e.pixelslength+e.masklength,this._readVMWDefineCursorData,e)},WMKS.VNCDecoder.prototype._updateCanvasCursor=function(e){let t,i;t=this._cursorVisible?WMKS.BROWSER.isIE()?"default":this._currentCursorURI:WMKS.BROWSER.isFirefox()&&WMKS.BROWSER.isMacOS()?"none, !important":"none",(i=this._mediaPlayer||this._canvas[0]).style.cursor!==t&&(i.style.cursor=t),i.cursorShadowImg!==e&&void 0!==e&&(i.cursorShadowImg=e,this.options.onCursorUrlChanged(e))},WMKS.VNCDecoder.prototype._readVMWCursorState=function(e){const t=this._readInt16();this._cursorVisible=!!(1&t),this._updateCanvasCursor(),this.options.onCursorStateChanged(this._cursorVisible),this._nextRect()},WMKS.VNCDecoder.prototype._readVMWCursorPosition=function(e){WMKS.VNCDecoder.cursorPosition=e,this._onCursorPositionChanged(e),this._nextRect()},WMKS.VNCDecoder.prototype._onCursorPositionChanged=function(e){const t=e;if(this._isInMultimonMode&&this._multiMonRects){const e=this._multiMonRects[1];e.left<0&&(t.x=t.x+e.left),e.top<0&&(t.y=t.y+e.top)}this.options.onCursorPositionChanged(t)},WMKS.VNCDecoder.prototype._readTypematicInfo=function(e){this.typematicState=this._readInt16(),this.typematicPeriod=this._readInt32(),this.typematicDelay=this._readInt32(),this._nextRect()},WMKS.VNCDecoder.prototype._readLEDState=function(e){this._keyboardLEDs=this._readInt32(),this.options.onKeyboardLEDsChanged(this._keyboardLEDs),this._nextRect()},WMKS.VNCDecoder.prototype._readFrameStamp=function(e){this._frameTimestampLo=this._readInt32(),this._frameTimestampHi=this._readInt32(),this._nextRect()},WMKS.VNCDecoder.prototype._fillRectWithColor=function(e,t,i,s,n,o){let r;r="rgb("+o[0]+","+o[1]+","+o[2]+")",e.fillStyle=r,e.fillRect(t,i,s,n)},WMKS.VNCDecoder.prototype._blitImageString=function(e,t,i,s,n,o){let r,a,c;for(c=(r=e.createImageData(s,n)).data,a=0;a<s*n*4;a+=4)c[a]=o.charCodeAt(a+2),c[a+1]=o.charCodeAt(a+1),c[a+2]=o.charCodeAt(a+0),c[a+3]=255;e.putImageData(r,t,i)},WMKS.VNCDecoder.prototype._copyRectGetPut=function(e,t,i,s,n,o,r,a){let c;c=this._canvas[e].ctx.getImageData(t,i,s,n),this._canvas[o].ctx.putImageData(c,r,a),c=null},WMKS.VNCDecoder.prototype._copyRectDrawImage=function(e,t,i,s,n,o,r,a){this._canvas[o].ctx.drawImage(this._canvas[e],t,i,s,n,r,a,s,n)},WMKS.VNCDecoder.prototype._copyRectDrawImageTemp=function(e,t,i,s,n,o,r,a){this._copyRectDrawImage(e,t,i,s,n,2,t,i),this._copyRectDrawImage(2,t,i,s,n,o,r,a)},WMKS.VNCDecoder.prototype._lighten=function(e,t,i,s,n){this._canvas[0].ctx.globalCompositeOperation="lighten",this._canvas[0].ctx.fillStyle=n,this._canvas[0].ctx.fillRect(e,t,i,s),this._canvas[0].ctx.globalCompositeOperation="source-over"},WMKS.VNCDecoder.prototype._decodeDiffComp=function(e,t){"use strict";let i=0,s=0;const n=new Uint8Array(1024);let o;for(;s<e.length&&i<=n.length;)switch(e[s++]){case this.diffCompCopyFromPrev:var r=e[s++];n.set(t.subarray(i,i+r),i),i+=r;break;case this.diffCompAppend:r=e[s++];n.set(e.subarray(s,s+r),i),s+=r,i+=r;break;case this.diffCompAppendRemaining:return(o=new Uint8Array(i+e.length-s)).set(n.subarray(0,i),0),s<e.length&&o.set(e.subarray(s),i),o}return n.subarray(0,i)},WMKS.VNCDecoder.prototype._readTightData=function(e){let t=this._readBytes(this.nextBytes);const i=window.URL||window.webkitURL,s=this;let n;e.subEncoding===this.subEncDiffJpeg&&(t=this._decodeDiffComp(t,this._lastJpegData)),e.subEncoding!==this.subEncPNG?(this._lastJpegData=t,n="image/jpeg"):n="image/png",this._useImageBitmaps?(WMKS.BROWSER.isChromeClient&&this._isInMultimonMode&&(e.image2={data:t,type:n}),createImageBitmap(new Blob([t],{type:n})).then(function(t){e.image=t,s.onDecodeComplete()})):(e.image=this._imageManager.getImage(),e.image.width=e.width,e.image.height=e.height,i?(e.image.onload=this.onDecodeObjectURLComplete,e.image.src=i.createObjectURL(new Blob([t],{type:n}))):(t=o.encodeFromArray(t),e.image.onload=this.onDecodeComplete,e.image.src="data:"+n+";base64,"+t)),this._nextRect()},WMKS.VNCDecoder.prototype._readTightPNG=function(e){if(e.subEncoding=this._readByte(),e.subEncoding&=this.subEncMask,this._mediaPlayer&&!this._customRendererEnabled()&&this.options.onEncodingChanged("TightPNG"),e.subEncoding===this.subEncFill)e.color=[],e.color[0]=this._readByte(),e.color[1]=this._readByte(),e.color[2]=this._readByte(),e.color[3]=255,this.rectsDecoded++,this._nextRect();else{let t=1,i=this._readByte();128&i&&(t=2,i&=-129,16384&(i+=this._readByte()<<7)&&(t=3,i&=-16385,i+=this._readByte()<<14)),this._setReadCB(i,this._readTightData,e)}},WMKS.VNCDecoder.prototype._readH264MP4Rect=function(e){const t=this._readInt16(),i=this._readInt16(),s=this._readInt32();this._customRendererEnabled()?(1===t&&(WMKS.LOGGER.log("MP4 encoding is selected and stream is reset in the multimon mode with id "+i),this._multimonRenderer.onInit("mp4",{streamId:i},this.onDecodeComplete,this.onDecodeMP4Error)),this._setReadCB(s,this._readMultimonH264MP4Data,i)):(1===t&&(WMKS.LOGGER.log("MP4 encoding is selected and stream is reset."),this.options.onEncodingChanged("MP4"),this._mp4Decoder.init(this._mediaPlayer,void 0,void 0,this.onDecodeComplete,this.onDecodeMP4Error)),this._setReadCB(s,this._readH264MP4Data,e))},WMKS.VNCDecoder.prototype._readH264MP4Data=function(e){this._mp4Decoder.appendData(this._readBytes(this.nextBytes)),this._nextRect()},WMKS.VNCDecoder.prototype._readMultimonH264MP4Data=function(e){this._multimonRenderer.onData("mp4",{streamId:e,data:this._readBytes(this.nextBytes)},this.onDecodeComplete,this.onDecodeMP4Error),this._nextRect()},WMKS.VNCDecoder.prototype._readH264Rect=function(e){const t=this._readInt16(),i=(this._readInt16(),this._readInt32());1===t&&(WMKS.LOGGER.log("Raw H264 encoding is selected and stream is reset."),this._customRendererEnabled()||this.options.onEncodingChanged("RawH264")),this._setReadCB(i,this._readH264Data,e)},WMKS.VNCDecoder.prototype._readH264Data=function(e){this._readBytes(this.nextBytes),this._nextRect()},WMKS.VNCDecoder.prototype._readCopyRect=function(e){e.srcX=this._readInt16(),e.srcY=this._readInt16(),this._nextRect()},WMKS.VNCDecoder.prototype._readRaw=function(e){e.imageString=this._readString(this.nextBytes),this._nextRect()},WMKS.VNCDecoder.prototype._readDesktopSize=function(e){this._FBWidth=e.width,this._FBHeight=e.height,this.options.onNewDesktopSize(this._FBWidth,this._FBHeight),this._nextRect()},WMKS.VNCDecoder.prototype._readRect=function(){const e=this.rectsRead;switch(this.rect[e]={},this.rect[e].x=this._readInt16(),this.rect[e].y=this._readInt16(),this.rect[e].width=this._readInt16(),this.rect[e].height=this._readInt16(),this.rect[e].encoding=this._readInt32(),this.rect[e].encoding!==this.encTightPNG&&this.rect[e].encoding!==this.encH264MP4&&this.rectsDecoded++,this.rect[e].encoding){case this.encRaw:this._setReadCB(this.rect[e].width*this.rect[e].height*this._FBBytesPerPixel,this._readRaw,this.rect[e]);break;case this.encCopyRect:this._setReadCB(4,this._readCopyRect,this.rect[e]);break;case this.encOffscreenCopyRect:this._setReadCB(6,this._readOffscreenCopyRect,this.rect[e]);break;case this.encUpdateCache:this._setReadCB(5,this._readUpdateCacheRect,this.rect[e]);break;case this.encH264RectEnc:this._setReadCB(8,this._readH264Rect,this.rect[e]);break;case this.encTightPNG:this._setReadCB(4,this._readTightPNG,this.rect[e]);break;case this.encH264MP4:this._setReadCB(8,this._readH264MP4Rect);break;case this.encDesktopSize:this._readDesktopSize(this.rect[e]);break;case this.encVMWDefineCursor:this._setReadCB(2,this._readVMWDefineCursor,this.rect[e]);break;case this.encVMWCursorState:this._assumeServerIsVMware(),this._setReadCB(2,this._readVMWCursorState,this.rect[e]);break;case this.encVMWCursorPosition:this._readVMWCursorPosition(this.rect[e]);break;case this.encVMWTypematicInfo:this._setReadCB(10,this._readTypematicInfo,this.rect[e]);break;case this.encVMWLEDState:this._setReadCB(4,this._readLEDState,this.rect[e]);break;case this.encVMWFrameStamp:this._setReadCB(8,this._readFrameStamp,this.rect[e]);break;default:return this.fail("Disconnected: unsupported encoding "+this.rect[e].encoding)}},WMKS.VNCDecoder.prototype._evictUpdateCacheEntry=function(e){null!==this.updateCache[e].image&&this._releaseImage(this.updateCache[e].image),this.updateCache[e]={},this.updateCache[e].image=null},WMKS.VNCDecoder.prototype._executeUpdateCacheInit=function(e){"use strict";let t;for(t=0;t<this.updateCacheEntries;t++)this._evictUpdateCacheEntry(t);if(this.updateCache=[],this.updateCacheEntries=e.updateCacheEntries,this.cacheFlags=e.flags,this.updateCacheEntries>this.options.cacheSizeEntries)return this.fail("Disconnected: requested cache too large");for(t=0;t<this.updateCacheEntries;t++)this.updateCache[t]={},this.updateCache[t].image=null},WMKS.VNCDecoder.prototype._updateCacheInsideBeginEnd=function(){return-1!==this.decodeToCacheEntry},WMKS.VNCDecoder.prototype._updateCacheInitialized=function(){return 0!==this.updateCacheEntries},WMKS.VNCDecoder.prototype._subRectangleCacheEnabled=function(){return this.options.enableSubRectangleCache&&this._updateCacheInitialized()&&this.cacheFlags&this.updateCacheCapSubRectangle},WMKS.VNCDecoder.prototype._executeUpdateCacheBegin=function(e){"use strict";let t,i,s,n,o;if(!this._updateCacheInitialized()||this._updateCacheInsideBeginEnd()||e.slot>=this.updateCacheEntries)return this.fail("Disconnected: requested cache slot too large");i=!(t=new WMKS.BitBuf(e.data,e.dataLength)).readBits(1),s=0,o=0;do{if(s=t.readEliasGamma(),i=!i)for(n=0;n<s&&n<this.updateCacheEntries;n++)this._evictUpdateCacheEntry(n+o);o+=s}while(o<this.updateCacheEntries&&!t.overflow);this.decodeToCacheEntry=e.slot,this._evictUpdateCacheEntry(e.slot),this.updateCache[this.decodeToCacheEntry].imageWidth=e.width,this.updateCache[this.decodeToCacheEntry].imageHeight=e.height},WMKS.VNCDecoder.prototype._executeUpdateCacheEnd=function(e){"use strict";let t=null;const i=this.updateCache[this.decodeToCacheEntry];let s,n,o,r,a=0,c=0,h=0,d=0;const u=i.imageWidth/16;i.imageHeight;let S,l;if(!this._updateCacheInitialized()||!this._updateCacheInsideBeginEnd()||e.slot!=this.decodeToCacheEntry||e.slot>=this.updateCacheEntries)return this.fail("Disconnected: requested cache slot invalid");t=this._subRectangleCacheEnabled()?{x:e.x,y:e.y,width:e.width,height:e.height}:{x:0,y:0,width:this._FBWidth,height:this._FBHeight},o=Math.ceil(t.width/16),r=Math.ceil(t.height/16),i.encodedMaskRect=t,i.mask=e.data,i.maskLength=e.dataLength,s=!(l=new WMKS.BitBuf(i.mask,i.maskLength)).readBits(1),n=0;do{0==n&&(n=l.readEliasGamma(),s=!s),S=Math.min(u-h,o-a),S=Math.min(S,n),s&&(this._canvas[0].ctx.drawImage(i.image,16*h,16*d,16*S,16,t.x+16*a,t.y+16*c,16*S,16),(h+=S)==u&&(h=0,d++)),(a+=S)==o&&(a=0,c++),n-=S}while(c<r&&!l._overflow);this.decodeToCacheEntry=-1},WMKS.VNCDecoder.prototype._executeUpdateCacheReplay=function(e){"use strict";if(e.slot>=this.updateCacheEntries)return this.fail("Disconnected: requested cache slot invalid");if(!this.updateCache[e.slot].encodedMaskRect)return;const t=this.updateCache[e.slot],i=t.encodedMaskRect;let s=0,n=0;const o=Math.ceil(i.width/16),r=Math.ceil(i.height/16);let a,c=0,h=0;const d=t.imageWidth/16,u=(t.imageHeight,new WMKS.BitBuf(e.data,e.dataLength)),S=new WMKS.BitBuf(t.mask,t.maskLength);let l=!S.readBits(1),_=0,C=!u.readBits(1),p=0;if(!this._updateCacheInitialized()||this._updateCacheInsideBeginEnd()||e.slot>=this.updateCacheEntries)return this.fail("");do{0==_&&(_=S.readEliasGamma(),l=!l),0==p&&(p=u.readEliasGamma(),C=!C),a=o-s,a=Math.min(a,_),l&&(a=Math.min(a,d-c),a=Math.min(a,p),C&&this._canvas[0].ctx.drawImage(t.image,16*c,16*h,16*a,16,i.x+16*s,i.y+16*n,16*a,16),(c+=a)==d&&(c=0,h++),p-=a),(s+=a)==o&&(s=0,n++),_-=a}while(n<r&&!u._overflow&&!S._overflow)},WMKS.VNCDecoder.prototype._handleVCDProxyVmxPathMessage=function(){const e=this._readString(17);if("connect info vmx\n"!==e)return this.fail("Invalid connection vmx request: "+e);this._sendString(this.options.VCDProxyHandshakeVmxPath),this._setReadCB(12,this._peekFirstMessage)},WMKS.VNCDecoder.prototype._executeUpdateCache=function(e){"use strict";switch(e.opcode){case this.updateCacheOpInit:this._executeUpdateCacheInit(e);break;case this.updateCacheOpBegin:this._executeUpdateCacheBegin(e);break;case this.updateCacheOpEnd:this._executeUpdateCacheEnd(e);break;case this.updateCacheOpReplay:this._executeUpdateCacheReplay(e);break;default:return this.fail("Disconnected: requested cache opcode invalid")}},WMKS.VNCDecoder.prototype._executeRectSingleForMultimon=function(e,t,i,s){switch(e.encoding){case this.encCopyRect:case this.encTightPNG:this._multimonRenderer.onData("rect",{data:e,frameId:t},i,s);break;case this.encUpdateCache:this.options.enableSubRectangleCache?this._multimonRenderer.onData("rect",{data:e,frameId:t},i,s):i();break;case this.encRaw:WMKS.LOGGER.warn("unsupported encoding for multimon: encRaw"),e.imageString="",i();break;case this.encDesktopSize:case this.encVMWDefineCursor:case this.encVMWCursorState:case this.encVMWCursorPosition:case this.encH264MP4:i();break;default:s()}},WMKS.VNCDecoder.prototype._executeRectSingle=function(e){const t=this._canvas[0].ctx;switch(e.encoding){case this.encRaw:this._blitImageString(t,e.x,e.y,e.width,e.height,e.imageString),e.imageString="";break;case this.encCopyRect:this._copyRectBlit(0,e.srcX,e.srcY,e.width,e.height,0,e.x,e.y);break;case this.encOffscreenCopyRect:this._copyRectOffscreenBlit(e.srcBuffer,e.srcX,e.srcY,e.width,e.height,e.dstBuffer,e.x,e.y);break;case this.encTightPNG:e.subEncoding===this.subEncFill?this._fillRectWithColor(t,e.x,e.y,e.width,e.height,e.color):-1===this.decodeToCacheEntry?(t.drawImage(e.image,e.x,e.y),this._releaseImage(e.image),e.image=null):(this.updateCache[this.decodeToCacheEntry].image=e.image,e.image=null);break;case this.encDesktopSize:case this.encVMWDefineCursor:case this.encVMWCursorState:case this.encVMWCursorPosition:case this.encH264MP4:break;case this.encUpdateCache:this._executeUpdateCache(e)}},WMKS.VNCDecoder.prototype.sendACK=function(e,t){const i=(new Date).getTime(),s=e||this.decodeStart,n=void 0!==t?t:this.updateReqId;this._sendAck(i-s,n)},WMKS.VNCDecoder.prototype._executeRects=function(){let e,t,i,s,n,o,r,a;if(this._state!==this.FBU_DECODING_STATE)return this.fail("wrong state: "+this._state);if(this.rectsDecoded!==this.rects||this.rectsRead!==this.rects)return this.fail("messed up state");if(this._customRendererEnabled())for(t=this.decodeStart,i=this.updateReqId,s=this.rects,n=0,r=o=function(){++n===s&&this.sendACK(t,i)}.bind(this),a=Date.now(),e=0;e<this.rects;e++)this._executeRectSingleForMultimon(this.rect[e],a,r,o),delete this.rect[e];else{for(e=0;e<this.rects;e++)this._executeRectSingle(this.rect[e]),delete this.rect[e];this.sendACK()}this.rects=0,this.rectsRead=0,this.rectsDecoded=0,this.updateReqId=0,!1===this._receivedFirstUpdate&&(this.options.onConnected(),this._receivedFirstUpdate=!0);this._state=this.FBU_RESTING_STATE,this._getNextServerMessage(),this._msgTimer=setTimeout(this.msgTimeout,1)},WMKS.VNCDecoder.prototype._nextRect=function(){this.rectsRead++,this.rectsRead<this.rects?this._setReadCB(12,this._readRect):(this._state=this.FBU_DECODING_STATE,this.rectsDecoded===this.rects&&this._executeRects())},WMKS.VNCDecoder.prototype._gobble=function(e){this._skipBytes(this.nextBytes),e()},WMKS.VNCDecoder.prototype._getNextServerMessage=function(){this._setReadCB(1,this._handleServerMsg)},WMKS.VNCDecoder.prototype._framebufferUpdate=function(){this.updateReqId=this._readByte(),this.rects=this._readInt16(),this.rectsRead=0,this.rectsDecoded=0,this.decodeStart=(new Date).getTime(),this._setReadCB(12,this._readRect)},WMKS.VNCDecoder.prototype._handleServerInitializedMsg=function(){const e=this;this._FBWidth=this._readInt16(),this._FBHeight=this._readInt16();const t=this._readByte(),i=this._readByte(),s=this._readByte(),n=this._readByte();WMKS.LOGGER.log("Screen: "+this._FBWidth+" x "+this._FBHeight+", bits-per-pixel: "+t+", depth: "+i+", big-endian-flag: "+s+", true-color-flag: "+n),this._skipBytes(6);const o=this._readByte(),r=this._readByte(),a=this._readByte();WMKS.LOGGER.debug("red shift: "+o+", green shift: "+r+", blue shift: "+a),this._skipBytes(3);const c=this._readInt32();if(this.options.onNewDesktopSize(this._FBWidth,this._FBHeight),this._copyRectBlit=this._copyRectDrawImageTemp,this._copyRectOffscreenBlit=this._copyRectDrawImage,!n)return this.fail("no colormap support");this._FBBytesPerPixel=4,this._FBDepth=3;this._setReadCB(c,function(){e._FBName=e._readString(c),e._sendClientEncodingsMsg(),e._sendFBUpdateRequestMsg(0),WMKS.LOGGER.log("Connected "+(e._encrypted?"(encrypted)":"(unencrypted)")+" to: "+e._FBName),e._serverInitialized=!0,e._getNextServerMessage()})},WMKS.VNCDecoder.prototype._peekFirstMessage=function(){this.usedVNCHandshake=12==this._receiveQueue[0].data.byteLength,this.usedVNCHandshake?this._setReadCB(12,this._handleProtocolVersionMsg):this._setReadCB(24,this._handleServerInitializedMsg)},WMKS.VNCDecoder.prototype._handleSecurityResultMsg=function(){const e=this;let t;const i=function(){const i=e._readString(t);return e.options.onAuthenticationFailed(),e.fail(i)},s=function(){t=e._readInt32(),e._setReadCB(t,i)};switch(this._readInt32()){case 0:return this._sendBytes([1]),void this._setReadCB(24,this._handleServerInitializedMsg);case 1:return void this._setReadCB(4,s);case 2:return this.options.onAuthenticationFailed(),this.fail("Too many auth attempts");default:return this.fail("Bogus security result")}},WMKS.VNCDecoder.prototype._handleSecurityMsg=function(){let e,t,i=0;const s=this,n=function(){const e=this._readString(t);return s.options.onAuthenticationFailed(),s.fail(e)};0===(e=this._readByte())?this._setReadCB(4,function(){t=s._readInt32(),s._setReadCB(t,n)}):this._setReadCB(e,function(){const t=s._readBytes(e);WMKS.LOGGER.log("Server security types: "+t);for(let e=0;e<t.length;e+=1)t&&t[e]<3&&(i=t[e]);return 0===i?s.fail("Unsupported security types: "+t):(s._sendBytes([i]),WMKS.LOGGER.log("Using authentication scheme: "+i),1!==i?s.fail("vnc authentication not implemented"):void s._setReadCB(4,s._handleSecurityResultMsg))})},WMKS.VNCDecoder.prototype._handleProtocolVersionMsg=function(){const e=this._readString(12);if("RFB 003.008\n"!==e)return this.fail("Invalid Version packet: "+e);this._sendString("RFB 003.008\n"),this._setReadCB(1,this._handleSecurityMsg)},WMKS.VNCDecoder.prototype._sendClientCaps=function(){if(this._serverInitialized){const e=[];let t=this.clientCapHeartbeat|this.clientCapAudioAck|this.clientCapSetReconnectToken;this.options.enableVorbisAudioClips&&(t|=this.clientCapVorbisAudioClips),this.options.enableOpusAudioClips&&(t|=this.clientCapOpusAudioClips),this.options.enableAacAudioClips&&(t|=this.clientCapAacAudioClips),this.options.enableVMWSessionClose&&(t|=this.clientCapSessionClose),this.options.enableVMWAudioMixer&&(t|=this.clientCapUseAudioMixer),this.serverSupportsMKSVChanClipboard&&this.vvcSession&&(t|=this.clientCapUseMKSVChanClipboard),e.push8(this.msgVMWClientMessage),e.push8(3),e.push16(8),e.push32(t),this._sendBytes(e)}},WMKS.VNCDecoder.prototype._sendSessionClose=function(e){if(this._serverInitialized&&this.useVMWSessionClose&&this.options.enableVMWSessionClose){WMKS.LOGGER.log("Send session close to server.");const t=[];t.push8(this.msgVMWClientMessage),t.push8(this.msgVMWSessionClose),t.push16(8),t.push32(e),this._sendBytes(t)}},WMKS.VNCDecoder.prototype._sendUpdateCacheInfo=function(){"use strict";const e=[];let t=this.updateCacheCapReplay|this.updateCacheCapDisableOffscreenSurface;this.options.enableSubRectangleCache&&(t|=this.updateCacheCapSubRectangle);const i=this.options.cacheSizeEntries,s=this.options.cacheSizeKB;WMKS.LOGGER.trace("sendUpdateCacheInfo"),e.push8(this.msgVMWClientMessage),e.push8(11),e.push16(14),e.push32(t),e.push16(i),e.push32(s),this._sendBytes(e)},WMKS.VNCDecoder.prototype._handleServerCapsMsg=function(){const e=this._readInt32();if(this.useVMWKeyEvent=!!(e&this.serverCapKeyEvent),this.allowVMWKeyEvent2UnicodeAndRaw=this.options.useUnicodeKeyboardInput&&!!(e&this.serverCapKeyEvent2Unicode)&&!!(e&this.serverCapKeyEvent2JSKeyCode),this.useVMWAck=!!(e&this.serverCapUpdateAck),this.useVMWRequestResolution=!!(e&this.serverCapRequestResolution),this.useVMWRequestStreamState=!!(e&this.serverCapRequestStreamState),this.useVMWRequestMultiMon=!!(e&this.serverCapMultiMon),this.useVMWAudioAck=!!(e&this.serverCapAudioAck),this.useVMWSessionClose=!!(e&this.serverCapSessionClose),this.serverSupportsMKSVChanClipboard=!!(e&this.serverCapHasMKSVChanClipboard),this.useVMWRequestResolution&&this.requestedWidth>0&&this.requestedHeight>0&&this.onRequestResolution(this.requestedWidth,this.requestedHeight),this.options.onMultimonCapacityUpdated(this.useVMWRequestMultiMon),e&this.serverCapClientCaps&&this._sendClientCaps(),e&this.serverCapUpdateCacheInfo&&this._sendUpdateCacheInfo(),e&this.serverCapDisablingCopyUI||e&this.serverCapDisablingPasteUI){let t=0,i=0;e&this.serverCapDisablingCopyUI&&(t=1),e&this.serverCapDisablingPasteUI&&(i=1),this.options.onUpdateCopyPasteUI(t,i)}this._getNextServerMessage()},WMKS.VNCDecoder.prototype._handleServerHeartbeatMsg=function(){const e=this._readInt16();this.options.onHeartbeat(e),this._getNextServerMessage()},WMKS.VNCDecoder.prototype._handleSessionCloseMsg=function(){const e=this._readInt32();this.options.onBeforeDisconnected(e),this._getNextServerMessage()},WMKS.VNCDecoder.prototype._handleAudioMixer=function(){const e=this._readInt32(),t=this._readInt32(),i=this._readInt32(),s=this._readInt32();e<2&&(0===t||1===t)?this.options.onAudioMixer({channelId:e,msgType:t,data:i,flags:s}):WMKS.LOGGER.warn("Ignoring audio mixer message for an unsupported  channelId = "+e+" msgType = "+t+" data = "+i+" flags = "+s),this._getNextServerMessage()},WMKS.VNCDecoder.prototype._handleServerSetReconnectTokenMsg=function(e){const t=this._readString(e);this.options.onSetReconnectToken(t),this._getNextServerMessage()},WMKS.VNCDecoder.prototype._handleServerAudioMsg=function(){const e=this._readInt32(),t=this._readInt32(),i=this._readInt32(),s=this._readInt32(),n=this._readInt32(),o=this._readInt32(),r=this._readInt32(),a=this._readInt32(),c={sampleRate:t,numChannels:i,containerSize:n,sampleSize:s,length:e,audioTimestampLo:o,audioTimestampHi:r,frameTimestampLo:this._frameTimestampLo,frameTimestampHi:this._frameTimestampHi,flags:a,data:null};this._setReadCB(e,this._handleServerAudioMsgData,c)},WMKS.VNCDecoder.prototype._handleServerAudioMsgData=function(e){e.length>0?(e.data=this._readBytes(e.length),this.useVMWAudioAck&&(0==e.flags||e.flags&this.audioflagRequestAck)&&this._sendAudioAck(e.audioTimestampLo,e.audioTimestampHi),this.options.onAudio(e)):WMKS.LOGGER.info("Audio data length is 0."),this._getNextServerMessage()},WMKS.VNCDecoder.prototype._handleServerCutText=function(e){const t=this._readStringUTF8(e);this.options.onCopy(t),this._getNextServerMessage()},WMKS.VNCDecoder.prototype._handleServerMsg=function(){let e;const t=this,i=this._readByte();switch(i){case this.msgFramebufferUpdate:this._setReadCB(3,this._framebufferUpdate);break;case this.msgSetColorMapEntries:this._setReadCB(5,function(){t._skipBytes(3);const e=t._readInt16();t._setReadCB(6*e,t._gobble,t._getNextServerMessage)});break;case this.msgRingBell:this._getNextServerMessage();break;case this.msgServerCutText:this._setReadCB(8,function(){t._readBytes(3),(e=t._readInt32())>0?t._setReadCB(e,t._handleServerCutText,e):t._getNextServerMessage()});break;case this.msgVMWSrvMessage:this._setReadCB(3,function(){const e=t._readByte(),i=t._readInt16();if(e===this.msgVMWSrvMessage_ServerCaps){if(8!==i)return t.options.onProtocolError(),t.fail("invalid length message for id: "+e+", len: "+i);t._setReadCB(i-4,t._handleServerCapsMsg)}else if(e===this.msgVMWSrvMessage_Heartbeat){if(6!==i)return t.options.onProtocolError(),t.fail("invalid length message for id: "+e+", len: "+i);t._setReadCB(i-4,t._handleServerHeartbeatMsg)}else if(e===this.msgVMWSrvMessage_SetReconnectToken)t._setReadCB(i-4,t._handleServerSetReconnectTokenMsg,i-4);else if(e===this.msgVMWSrvMessage_Audio){if(36!==i)return t.options.onProtocolError(),t.fail("invalid length message for id: "+e+", len: "+i);t._setReadCB(i-4,t._handleServerAudioMsg)}else if(e===this.msgVMWSrvMessage_SessionClose){if(8!==i)return t.options.onProtocolError(),t.fail("invalid length message for id: "+e+", len: "+i);t._setReadCB(i-4,t._handleSessionCloseMsg)}else if(e===this.msgVMWSrvMessage_AudioMixer){if(20!==i)return t.options.onProtocolError(),t.fail("invalid length message for id: "+e+", len: "+i);t._setReadCB(i-4,t._handleAudioMixer)}else{const e=i-4;0===e?t._getNextServerMessage():t._setReadCB(e,t._gobble,t._getNextServerMessage)}});break;default:return this.options.onProtocolError(),this.fail("Disconnected: illegal server message type "+i)}},WMKS.VNCDecoder.prototype._processMessages=function(){for(;this._state===this.VNC_ACTIVE_STATE&&this._receiveQueueBytesUnread()>=this.nextBytes;){const e=this.nextBytes,t=this._receiveQueueBytesUnread();this.nextFn(this.nextArg);const i=this._receiveQueueBytesUnread();if(e<t-i)return this.fail("decode overrun "+e+" vs "+(t-i))}},WMKS.VNCDecoder.prototype.onMouseMove=function(e,t){this._mouseX=e,this._mouseY=t,this._serverInitialized&&(this._mouseActive=!0,null===this._mouseTimer&&(this._sendMouseEvent(),this._mouseTimer=setTimeout(this.mouseTimeout,this.mouseTimeResolution)))},WMKS.VNCDecoder.prototype.onMouseButton=function(e,t,i,s){this._mouseX=e,this._mouseY=t,i?this._mouseButtonMask|=s:this._mouseButtonMask&=~s,this._serverInitialized&&(this._mouseActive=!0,this._sendMouseEvent())},WMKS.VNCDecoder.prototype.onKeyVScan=function(e,t){if(this._serverInitialized){const i=[];i.push8(this.msgVMWClientMessage),i.push8(this.msgVMWKeyEvent),i.push16(8),i.push16(e),i.push8(t),i.push8(0),this._sendBytes(i)}},WMKS.VNCDecoder.prototype.onVMWKeyUnicode=function(e,t,i){if(this._serverInitialized){const s=[];s.push8(this.msgVMWClientMessage),s.push8(this.msgVMWKeyEvent2),s.push16(10),s.push32(e),s.push8(t),s.push8(i),this._sendBytes(s)}},WMKS.VNCDecoder.prototype.onMouseWheel=function(e,t,i,s){if(this._serverInitialized){const n=[];n.push8(this.msgVMWClientMessage),n.push8(this.msgVMWPointerEvent2),n.push16(19),n.push8(1),n.push32(e),n.push32(t),n.push32(0),n.push8(s),n.push8(i),this._sendBytes(n)}},WMKS.VNCDecoder.prototype.onRequestResolution=function(e,t){this._serverInitialized&&this.useVMWRequestResolution&&(e!==this.requestedWidth||t!==this.requestedHeight)&&(this.resolutionRequestActive=!0,clearTimeout(this.resolutionTimer),this.resolutionTimer=setTimeout(this.resolutionTimeout,this.resolutionDelay),this.requestedWidth=e,this.requestedHeight=t,this._isInMultimonMode=!1,this._multiMonRects=null)},WMKS.VNCDecoder.prototype.onRequestTopology=function(e){this.requestedWidth=0,this.requestedHeight=0,this._serverInitialized&&this.useVMWRequestMultiMon&&(WMKS.LOGGER.log("Calling _sendTopologyRequest with arg:"+JSON.stringify(e)),this._sendTopologyRequest(e),this._isInMultimonMode=!0,this._multiMonRects=e)},WMKS.VNCDecoder.prototype.disconnect=function(){this._state!==this.DISCONNECTED&&(this._state=this.DISCONNECTED,this._mp4Decoder&&(this._mp4Decoder.reset(),this._mp4Decoder=null),this._isInMultimonMode&&(this._customRendererEnabled()&&this._multimonRenderer.reset(),this._isInMultimonMode=!1,this._multiMonRects=null),this._multimonRenderer=null,this._receiveQueueReset(),this.rects=0,this._receivedFirstUpdate=!1,this._websocket&&(this._sendSessionClose(23),this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onmessage=null,this._websocket.onerror=null,this._websocket.close(),delete this._websocket),this._serverInitialized=!1)},WMKS.VNCDecoder.prototype.connect=function(e){const t=this;this.setRenderCanvas(this.options.canvas),this._mediaPlayer=this.options.mediaPlayer,this.onDecodeComplete=function(){t.rectsDecoded++,t.rectsDecoded===t.rects&&t.rectsRead===t.rects&&(t._state=t.FBU_DECODING_STATE,t._executeRects())},this.onDecodeObjectURLComplete=function(){URL.revokeObjectURL(this.src),t.onDecodeComplete()},this.onDecodeMP4Error=function(){const e=t.options.mediaPlayer;WMKS.LOGGER.log("Resetting stream request is sent."),t.options.mediaPlayer=null,t._sendClientEncodingsMsg(),t.options.mediaPlayer=e,t._sendClientEncodingsMsg()},this.msgTimeout=function(){t._state=t.VNC_ACTIVE_STATE,t._processMessages()},this.mouseTimeout=function(){t._mouseTimer=null,t._mouseActive&&(t._sendMouseEvent(),t._mouseTimer=setTimeout(t.mouseTimeout,t.mouseTimeResolution))},this.resolutionTimeout=function(){t.resolutionRequestActive&&(t._sendResolutionRequest(),t.resolutionRequestActive=!1)},this.options.VCDProxyHandshakeVmxPath?this._setReadCB(17,this._handleVCDProxyVmxPathMessage):this._setReadCB(12,this._peekFirstMessage),this._url=e,this._receiveQueueReset(),this.wsOpen=function(e){if(t._state=t.VNC_ACTIVE_STATE,"binary"!==this.protocol&&"vmware-vvc"!==this.protocol)return this.fail("no agreement on protocol");"vmware-vvc"===this.protocol&&(t._setupVVC(),WMKS.LOGGER.log("WebSocket is using VMware Virtual Channels"),this.protocol="binary"),"binary"===this.protocol&&(this.binaryType="arraybuffer",WMKS.LOGGER.log("WebSocket HAS binary support")),t.options.onConnecting(t.vvc,t.vvcSession),WMKS.LOGGER.log("WebSocket created protocol: "+this.protocol)},this.wsClose=function(e){t.options.onDisconnected(e.reason,e.code)},this.wsMessage=function(e){if("string"==typeof e.data)return t.fail("non-binary message");t._receiveQueue.push(e),t._receiveQueueLength+=e.data.byteLength,t._processMessages()},this.wsError=function(e){t.options.onError(e)},this.protocolList=["binary"],this.options.enableVVC&&this.protocolList.push("vmware-vvc"),this._setupConnection=function(){t._websocket=WMKS.WebSocket(t._url,t.protocolList),t._websocket.onopen=t.wsOpen,t._websocket.onclose=t.wsClose,t._websocket.onmessage=t.wsMessage,t._websocket.onerror=t.wsError},this._setupVVC=function(){t.vvc=new r,t.vvcSession=t.vvc.openSession(t._websocket),t.vvcSession.onerror=function(e){t.vvcSession.close()},t.vvcSession.ontransportclose=function(e){t.wsClose(e)},t.vvcSession.ontransporterror=function(e){t.wsError(e)},t.vvc.createListener(t.vvcSession,"blast-*").onpeeropen=function(e,i){"blast-mks"===i.name?(i.onclose=function(i){e.close(),t._websocket=null,t.disconnect()},i.onerror=function(i){e.close(),t._websocket=null,t.disconnect()},t._websocket=i,i.onmessage=t.wsMessage,e.acceptChannel(i)):"blast-audio"===i.name&&(i.onclose=function(t){e.close()},i.onerror=function(t){e.close()},i.onmessage=t.wsMessage,e.acceptChannel(i))}},this._retryConnectionTimeout=function(){t._state===t.DISCONNECTED&&(WMKS.LOGGER.log("Connection timeout. Retrying now."),t._websocket&&(t._websocket.onclose=function(){},t._websocket.close(),t._websocket=null),t._setupConnection()),t._retryConnectionTimer=null},this.options.enableUint8Utf8&&n(this),this._setupConnection(),this.options.retryConnectionInterval>0&&(WMKS.LOGGER.log("Check connection status after "+this.options.retryConnectionInterval+"ms."),this._retryConnectionTimer=setTimeout(this._retryConnectionTimeout,this.options.retryConnectionInterval))},WMKS.VNCDecoder.prototype.setRenderCanvas=function(e){if(this._canvas[0]=e,this._canvas[0].ctx=e.getContext("2d"),!this._canvas[0].ctx.createImageData)throw"no canvas imagedata support"},WMKS.VNCDecoder.prototype.setAudioStreamEnabled=function(e){e?this._streamState&=~this.streamStateDisableAudio:this._streamState|=this.streamStateDisableAudio,this._sendRequestStreamState(this._streamState)},WMKS.VNCDecoder.prototype.setVideoStreamEnabled=function(e){e?this._streamState&=~this.streamStateDisableVideo:this._streamState|=this.streamStateDisableVideo,this._sendRequestStreamState(this._streamState)},WMKS.VSCAN_CODES={VSCAN_LCONTROL:29,VSCAN_RCONTROL:285,VSCAN_LSHIFT:42,VSCAN_RSHIFT:54,VSCAN_LALT:56,VSCAN_RALT:312,VSCAN_LGUI:347,VSCAN_RGUI:348,VSCAN_XLSHIFT:298,VSCAN_XRSHIFT:310,VSCAN_HOME:327,VSCAN_UP:328,VSCAN_PAGEUP:329,VSCAN_LEFT:331,VSCAN_RIGHT:333,VSCAN_END:335,VSCAN_DOWN:336,VSCAN_PAGEDOWN:337,VSCAN_INSERT:338,VSCAN_DELETE:339,VSCAN_NUMPAD_DIVIDE:309,VSCAN_SLASH:309,VSCAN_NUMPAD_MULTIPLY:55,VSCAN_NUMPAD_HOME:71,VSCAN_NUMPAD_7:71,VSCAN_NUMPAD_UP:72,VSCAN_NUMPAD_8:72,VSCAN_NUMPAD_PAGEUP:73,VSCAN_NUMPAD_9:73,VSCAN_NUMPAD_MINUS:74,VSCAN_NUMPAD_LEFT:75,VSCAN_NUMPAD_4:75,VSCAN_NUMPAD_5:76,VSCAN_NUMPAD_RIGHT:77,VSCAN_NUMPAD_6:77,VSCAN_NUMPAD_PLUS:78,VSCAN_NUMPAD_END:79,VSCAN_NUMPAD_1:79,VSCAN_NUMPAD_DOWN:80,VSCAN_NUMPAD_2:80,VSCAN_NUMPAD_PAGEDOWN:81,VSCAN_NUMPAD_3:81,VSCAN_NUMPAD_INSERT:82,VSCAN_NUMPAD_0:82,VSCAN_NUMPAD_DELETE:83,VSCAN_NUMPAD_DOT:83,VSCAN_NUMPAD_COMMA:126,VSCAN_NUMPAD_ENTER:284,VSCAN_SCROLL:70,VSCAN_PRINT:311,VSCAN_BREAK:326,VSCAN_BACKSPACE:14,VSCAN_NUMLOCK:69,VSCAN_SYSREQ:84,VSCAN_TAB:15,VSCAN_ESCAPE:1,VSCAN_ENTER:28,VSCAN_SPACE:57,VSCAN_CAPSLOCK:58,VSCAN_F1:59,VSCAN_F2:60,VSCAN_F3:61,VSCAN_F4:62,VSCAN_F5:63,VSCAN_F6:64,VSCAN_F7:65,VSCAN_F8:66,VSCAN_F9:67,VSCAN_F10:68,VSCAN_F11:87,VSCAN_F12:88,VSCAN_F13:100,VSCAN_F14:101,VSCAN_F15:102,VSCAN_F16:103,VSCAN_F17:104,VSCAN_F18:105,VSCAN_F19:106,VSCAN_F20:107,VSCAN_F21:108,VSCAN_F22:109,VSCAN_F23:110,VSCAN_F24:118,VSCAN_A:30,VSCAN_B:48,VSCAN_C:46,VSCAN_D:32,VSCAN_E:18,VSCAN_F:33,VSCAN_G:34,VSCAN_H:35,VSCAN_I:23,VSCAN_J:36,VSCAN_K:37,VSCAN_L:38,VSCAN_M:50,VSCAN_N:49,VSCAN_O:24,VSCAN_P:25,VSCAN_Q:16,VSCAN_R:19,VSCAN_S:31,VSCAN_T:20,VSCAN_U:22,VSCAN_V:47,VSCAN_W:17,VSCAN_X:45,VSCAN_Y:21,VSCAN_Z:44,VSCAN_TILDE:41,VSCAN_0:11,VSCAN_9:10,VSCAN_8:9,VSCAN_7:8,VSCAN_6:7,VSCAN_5:6,VSCAN_4:5,VSCAN_3:4,VSCAN_2:3,VSCAN_1:2,VSCAN_PLUS:13,VSCAN_EQUALS:13,VSCAN_MINUS:12,VSCAN_FWDSLASH:53,VSCAN_LBRACKET:26,VSCAN_RBRACKET:27,VSCAN_BACKSLASH:43,VSCAN_COLON:39,VSCAN_QUOTE:40,VSCAN_COMMA:51,VSCAN_PERIOD:52,VSCAN_EUROPE1:43,VSCAN_EUROPE2:86,VSCAN_MENU:349,VSCAN_HIRAGANA:112,VSCAN_RO:115,VSCAN_YEN:125,VSCAN_HENKAN:121,VSCAN_MUHENKAN:123,VSCAN_POWER:350,VSCAN_HANGUL_EN:114,VSCAN_HANJA_EN:113,VSCAN_HANGUL_KO:370,VSCAN_HANJA_KO:369,VSCAN_HANGUL:242,VSCAN_HANJA:241,VSCAN_NONE:0,VSCAN_INVALID:511,VSCAN_PAUSE:256,VKSCAN_CODE_BITS:255,VKSCAN_PREFIX_BIT:256,VKSCAN_NONE:0,VKSCAN_PAUSE:256,VSCAN_SCAN_PREVIOUS_TRACK:272,VSCAN_SCAN_NEXT_TRACK:281,VSCAN_MUTE:288,VSCAN_CALCULATOR:289,VSCAN_PLAY_PAUSE:290,VSCAN_STOP:292,VSCAN_VOLUME_DOWN:302,VSCAN_VOLUME_UP:304,VSCAN_BROWSER_HOME:306,VSCAN_BROWSER_SEARCH:357,VSCAN_BROWSER_FAVORITES:358,VSCAN_BROWSER_REFRESH:359,VSCAN_BROWSER_STOP:360,VSCAN_BROWSER_FORWARD:361,VSCAN_BROWSER_BACK:362,VSCAN_MY_COMPUTER:363,VSCAN_MAIL:364,VSCAN_MEDIA_SELECT:365},WMKS.SCAN_CODES={SCAN_ESCAPE:1,SCAN_LCONTROL:29,SCAN_LSHIFT:42,SCAN_RSHIFT:54,SCAN_LALT:56,SCAN_CAPS:58,SCAN_F1:59,SCAN_F10:68,SCAN_NUMLOCK:69,SCAN_SCROLL:70,SCAN_SYSREQ:84,SCAN_TESTOK:85,SCAN_PREFIX:224,SCAN_PREFIX1:225,SCAN_NOPWD:241,SCAN_ACK:250,SCAN_COMPLETE:170,SCAN_ERROR:252,SCAN_NACK:254,SCAN_RESEND:254,SCAN_RELEASE_BIT:128,SCAN_G:34},WMKS.KSCAN_CODES={KSCAN_LCONTROL:20,KSCAN_NUMLOCK:119,KSCAN_PREFIX:224,KSCAN_PREFIX1:225,KSCAN_RELEASE:240},WMKS.KBD_LEDS={KBD_LED_SCROLL_LOCK:1,KBD_LED_NUM_LOCK:2,KBD_LED_CAPS_LOCK:4},WMKS.MKS_MOD={MKS_MOD_ALT:1,MKS_MOD_CONTROL:2,MKS_MOD_SHIFT:4,MKS_MOD_GUI:8,MKS_MOD_WIN:8,MKS_MOD_DEFAULT:65535},WMKS.CONST.KB={ControlKeys:[8,9,13,16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,46,91,92,93,112,113,114,115,116,117,118,119,120,121,122,123,144,145,240],Modifiers:[16,17,18,91,92],WestEuroLanguage:["de-DE","it-IT","es-ES","pt-BR","pt-PT","fr-FR","fr-CH","de-CH"],Diacritics:[192],KEY_CODE:{Shift:16,Ctrl:17,Alt:18,Meta:91,Enter:13,CapsLock:20},SoftKBRawKeyCodes:[8,9,13],keyInputDefaultValue:"",ANSIShiftSymbols:'~!@#$%^&*()_+{}|:"<>?',ANSINoShiftSymbols:"`-=[]\\;',./1234567890",WindowsKeys:{left:91,right:92},VScanMap:{}},WMKS.BROWSER.isMacOS()&&(WMKS.CONST.KB.Modifiers=[16,17,18,91,92,224]),WMKS.CONST.KB.ANSISpecialSymbols=WMKS.CONST.KB.ANSIShiftSymbols+WMKS.CONST.KB.ANSINoShiftSymbols,WMKS.KeyboardManager=function(e){"use strict";if(!e||!e.vncDecoder)return null;this._vncDecoder=e.vncDecoder,this.ignoredRawKeyCodes=e.ignoredRawKeyCodes,this.fixANSIEquivalentKeys=e.fixANSIEquivalentKeys,this.mapMetaToCtrlForKeys=e.mapMetaToCtrlForKeys,this.keyDownKeyTimer=null,this.keyDownIdentifier=null,this.pendingKey=null,this.addCtrlKey=!1,this.activeModifiers=[],this.keyToUnicodeMap={},this.keyToRawMap={},this.keyboardLayoutId=e.keyboardLayoutId,this.UnicodeToVScanMap=WMKS.CONST.KB.VScanMap[this.keyboardLayoutId],this._windowsKeyManager={enabled:e.enableWindowsKey,windowsOn:!1,leftWindowsDown:!1,rightWindowsDown:!1,modifiedKeyMap:{Pause:19},modifiedKey:null,reset:function(){this.windowsOn=!1,this.leftWindowsDown=!1,this.rightWindowsDown=!1,this.modifiedKey=null},keyboardHandler:function(e){e.keyCode===WMKS.CONST.KB.WindowsKeys.left||224===e.keyCode?(this.leftWindowsDown="keydown"===e.type,this.leftWindowsDown||(this.windowsOn=!1)):e.keyCode===WMKS.CONST.KB.WindowsKeys.right&&(this.rightWindowsDown="keydown"===e.type,this.rightWindowsDown||(this.windowsOn=!1))},modifyKey:function(e){return 3===e&&(this.windowsOn?(e=this.modifiedKeyMap.Pause,this.modifiedKey=3):3===this.modifiedKey&&(e=this.modifiedKeyMap.Pause,this.modifiedKey=null)),e}},this._extractKeyCodeFromEvent=function(e){let t=0,i=!1;if(e.keyCode)t=e.keyCode,"pt-PT"==this.keyboardLayoutId&&WMKS.BROWSER.isChrome()&&(186===e.keyCode||191===e.keyCode)&&WMKS.BROWSER.isWindows()&&(t=186===e.keyCode?180:126),"de-DE"==this.keyboardLayoutId&&192==e.keyCode&&WMKS.BROWSER.isFirefox()&&(t=187),("fr-CH"===this.keyboardLayoutId||"de-CH"===this.keyboardLayoutId)&&WMKS.BROWSER.isWindows()&&221===e.keyCode&&(t=94);else if(e.which)t=e.which;else if(e.keyIdentifier&&"U+"===e.keyIdentifier.substring(0,2)){if(!(t=parseInt("0x"+e.keyIdentifier.slice(2),16)))return WMKS.LOGGER.log("assert: Unicode identifier="+e.keyIdentifier+" int conversion failed, keyCode="+t),null;i=!0}else if(0===e.keyCode&&WMKS.BROWSER.isFirefox()&&e.key&&this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw)t=0;else if(this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw||(t=this.handleInternationalKeyboard(e,t)),"ja-JP_106/109"==this.keyboardLayoutId&&!WMKS.BROWSER.isFirefox()&&0===e.keyCode&&(t=165),!t)return WMKS.LOGGER.trace("assert: could not read keycode from event, keyIdentifier="+e.keyIdentifier),null;return!i&&this._windowsKeyManager.enabled&&(t=this._windowsKeyManager.modifyKey(t)),{keyCode:t,isUnicode:i}},this.onKeyDown=function(e){let t,i=0,s=!1;const n=this;if(!(t=this._extractKeyCodeFromEvent(e)))return WMKS.LOGGER.log("Extraction of keyCode from keyUp event failed."),!1;if(i=t.keyCode,s=t.isUnicode,this._syncModifiers(e),0===i)return WMKS.LOGGER.log("onKeyDown: Do not send 0 to server."),!0;if(-1!==$.inArray(i,WMKS.CONST.KB.Modifiers))return e.returnValue=!1,!1;if(-1!==WMKS.CONST.KB.ControlKeys.indexOf(i))return e.returnValue=!1,this._handleControlKeys(i);if(s)return WMKS.LOGGER.log("Send unicode down from keyIdentifier: "+i),n.sendKey(i,!1,!0),e.returnValue=!1,!1;null!==this.keyDownKeyTimer&&(WMKS.LOGGER.log("assert: nuking an existing keyDownKeyTimer"),clearTimeout(this.keyDownKeyTimer));let o=0;return o=WMKS.BROWSER.isFirefox()?100:0,this.keyDownKeyTimer=setTimeout(function(){n.sendKey(i,!1,!1),n.keyDownKeyTimer=null,n.pendingKey=null},o),this.pendingKey=i,e.originalEvent&&e.originalEvent.keyIdentifier&&(this.keyDownIdentifier=e.originalEvent.keyIdentifier),e.returnValue=1!==this.activeModifiers.length||this.activeModifiers[0]!==WMKS.CONST.KB.KEY_CODE.Alt&&this.activeModifiers[0]!==WMKS.CONST.KB.KEY_CODE.Ctrl&&this.activeModifiers[0]!==WMKS.CONST.KB.WindowsKeys.left&&this.activeModifiers[0]!==WMKS.CONST.KB.WindowsKeys.right,e.returnValue},this._handleControlKeys=function(e){return this.isAddCapsLockEvent(e)?(this.sendKey(e,!1,!1),void this.sendKey(e,!0,!1)):(this.sendKey(e,!1,!1),!1)},this.isAddCapsLockEvent=function(e){return e===WMKS.CONST.KB.KEY_CODE.CapsLock&&WMKS.BROWSER.isMacOS()||240===e&&WMKS.BROWSER.isWindows()},this._handleCapsLockKey=function(e){if(this.isAddCapsLockEvent(e)&&!this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw)return this.sendKey(e,!1,!1),this.sendKey(e,!0,!1),!1},this._syncModifiers=function(e){let t,i,s,n,o=[e.shiftKey,e.ctrlKey,e.altKey,e.metaKey,!1,!1];for(!0===e.altGraphKey&&(o[1]=o[2]=!0),o=this.resetEventValue(e,o),!0===e.metaKey&&-1!==this.mapMetaToCtrlForKeys.indexOf(e.keyCode)&&(o[1]=!0,o[3]=!1),this._windowsKeyManager.enabled&&(this._windowsKeyManager.keyboardHandler(e),!0===e.ctrlKey&&(this._windowsKeyManager.leftWindowsDown||-1!==this.activeModifiers.indexOf(WMKS.CONST.KB.WindowsKeys.left)?(o[1]=!1,o[3]=!0,this._windowsKeyManager.windowsOn=!0):(this._windowsKeyManager.rightWindowsDown||-1!==this.activeModifiers.indexOf(WMKS.CONST.KB.WindowsKeys.right))&&(o[1]=!1,o[4]=!0,this._windowsKeyManager.windowsOn=!0))),s=0;s<WMKS.CONST.KB.Modifiers.length;s++)t=WMKS.CONST.KB.Modifiers[s],i=o[s],n=this.activeModifiers.indexOf(t),i&&-1===n?(this.activeModifiers.push(t),this.sendKey(t,!1,!1)):!i&&-1!==n&&(this.activeModifiers.splice(n,1),this.sendKey(t,!0,!1))},this.resetEventValue=function(e,t){const i=e.charCode||e.which,s=WMKS.keyboardUtils._WindowsFirefoxAltGr[this.keyboardLayoutId];return!!s&&-1!==s.indexOf(i)&&WMKS.BROWSER.isWindows()&&WMKS.BROWSER.isFirefox()&&(t[1]=t[2]=!0),t},this.cancelModifiers=function(e){let t;if(!WMKS.BROWSER.isTouchDevice()||e){for(t=0;t<this.activeModifiers.length;t++)this.sendKey(this.activeModifiers[t],!0,!1);this.activeModifiers.length=0,this._windowsKeyManager.enabled&&this._windowsKeyManager.reset()}},this.updateModifiers=function(e,t){this.sendKey(e,t,!1),t?this.activeModifiers.splice(this.activeModifiers.indexOf(e),1):this.activeModifiers.push(e)},this.onKeyPress=function(e){let t,i=!1,s=!1,n=!1,o=!1,r=!1,a="";WMKS.CONST.KB.WestEuroLanguage.indexOf(this.keyboardLayoutId);if(WMKS.BROWSER.isMacOS()&&1===this.activeModifiers.length&&this.activeModifiers[0]===WMKS.CONST.KB.KEY_CODE.Alt)return WMKS.LOGGER.log("Preferring raw keycode with Alt held (Mac)"),!1;if(e.charCode&&e.charCode>=32)t=e.charCode,i=!1;else{if(!e.keyCode)return WMKS.LOGGER.log("assert: could not read keypress event"),!1;t=e.keyCode,t=this.remapUncontrolKey(e,t,i).keyCode,i=this.remapUncontrolKey(e,t,i).isRaw}return null!==this.keyDownKeyTimer&&(clearTimeout(this.keyDownKeyTimer),this.keyDownKeyTimer=null),(!i||-1===WMKS.CONST.KB.ControlKeys.indexOf(t))&&(!this.handleUnusefulKeys(e)&&(e=this.fixDeFrChSpecialKeys(e,this.pendingKey,t),this._syncModifiers(e),null!==this.pendingKey&&(i?this.keyToRawMap[this.pendingKey]=t:this.keyToUnicodeMap[this.pendingKey]=t),this.fixANSIEquivalentKeys&&e.originalEvent&&(e.originalEvent.key?a=e.originalEvent.key:WMKS.BROWSER.isWindows()&&WMKS.BROWSER.isChrome()||(""===e.originalEvent.keyIdentifier&&this.keyDownIdentifier?a=String.fromCharCode(parseInt(this.keyDownIdentifier.replace("U+",""),16)):e.originalEvent.keyIdentifier&&(a=String.fromCharCode(parseInt(e.originalEvent.keyIdentifier.replace("U+",""),16)))),a&&(o=a.charCodeAt(0)!==t,s=-1!==WMKS.CONST.KB.ANSIShiftSymbols.indexOf(a)&&-1===this.activeModifiers.indexOf(WMKS.CONST.KB.KEY_CODE.Shift),n=-1!==WMKS.CONST.KB.ANSINoShiftSymbols.indexOf(a)&&-1!==this.activeModifiers.indexOf(WMKS.CONST.KB.KEY_CODE.Shift),r=-1!==WMKS.CONST.KB.ANSISpecialSymbols.indexOf(a))),this.keyDownIdentifier=null,this.fixANSIEquivalentKeys&&a&&r&&(o||s||n)?(n&&this.sendKey(WMKS.CONST.KB.KEY_CODE.Shift,!0,!1),this.handleSoftKb(a.charCodeAt(0),!0),n&&this.sendKey(WMKS.CONST.KB.KEY_CODE.Shift,!1,!1)):(this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw||(t=this.handleInternationalKeyboard(e,t,this.pendingKey)),null!==this.pendingKey&&(i?this.keyToRawMap[this.pendingKey]=t:this.keyToUnicodeMap[this.pendingKey]=t),this.sendAndfixWrongKeys(e,t,i,this.pendingKey)),(50===this.pendingKey&&126===t||55===this.pendingKey&&96===t)&&!i&&(WMKS.LOGGER.debug("Sending extra up for Unicode "+t+" so one isn't missed."),this.sendKey(t,!0,!i)),this.pendingKey=null,!1))},this.fixDeFrChSpecialKeys=function(e,t,i){return("de-CH"===this.keyboardLayoutId||"fr-CH"===this.keyboardLayoutId)&&WMKS.BROWSER.isWindows()&&WMKS.BROWSER.isFirefox()&&(176===e.charCode&&176===t?(e.keyCode=1176,e.charCode=1176):167===e.charCode&&167===t&&(e.keyCode=1167,e.charCode=1167)),e},this.sendAndfixWrongKeys=function(e,t,i,s){const n=this.isSmallKeyboardKey(e,t,s),o=this.isAddShiftKey(e,t),r=this.isAddAltGr(e,t),a=this.isDeleteShiftKey(e,t);!this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw&&(n||o||a||r)?((n||o)&&(this.sendKey(16,!1,!1),this.sendKey(t,!1,!i),this.sendKey(16,!0,!1)),a&&(this.sendKey(16,!0,!1),this.sendKey(t,!1,!i),this.sendKey(16,!1,!1)),r&&(this.sendKey(17,!1,!1),this.sendKey(18,!1,!1),this.sendKey(t,!1,!i),this.sendKey(17,!0,!1),this.sendKey(18,!0,!1))):this.sendKey(t,!1,!i)},this.isSmallKeyboardKey=function(e,t,i){let s=!1;const n=WMKS.keyboardUtils._SmallKeyboardKey[this.keyboardLayoutId];return!1===e.shiftKey&&!1===e.altKey&&!1===e.ctrlKey&&this.isFitSmallKeyboardPendingKey(t,i)&&!!n&&-1!==n.indexOf(t)&&(s=!0),s},this.isFitSmallKeyboardPendingKey=function(e,t){let i=!0;const s=WMKS.keyboardUtils._smallKeyboardPendingKey[this.keyboardLayoutId];return s&&s[e]&&WMKS.BROWSER.isWindows()&&(s[e]===t||"object"==typeof s[e]&&-1!==s[e].indexOf(t))&&(i=!1),i},this.isMacChromeVscancodeFr=function(){return WMKS.BROWSER.isMacOS()&&!this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw&&"fr-FR"==this.keyboardLayoutId},this.isAddShiftKey=function(e,t){return 167==(e.keyCode||e.charCode)&&this.isMacChromeVscancodeFr()},this.isDeleteShiftKey=function(e,t){const i=e.keyCode||e.charCode;return(95==i||42==i||35==i)&&this.isMacChromeVscancodeFr()&&e.shiftKey},this.isAddAltGr=function(e,t){const i=e.keyCode||e.charCode;return(64==i||35==i)&&this.isMacChromeVscancodeFr()},this.handleUnusefulKeys=function(e){let t,i=!1;return WMKS.BROWSER.isIE()&&WMKS.BROWSER.version.major>10&&(!!(t=WMKS.keyboardUtils._keypressUnusefulKeys[this.keyboardLayoutId])&&-1!==t.indexOf(e.keyCode)&&(i=!0)),i},this.remapUncontrolKey=function(e,t,i){const s=WMKS.BROWSER.isChrome()&&e.altKey&&e.ctrlKey;i=!0;let n;const o=WMKS.keyboardUtils._remapUncontrolKeys[this.keyboardLayoutId];return s&&(void 0!==o&&(n=o[e.keyCode]),void 0!==n&&(i=!1,t=n)),{keyCode:t,isRaw:i}},this.handleInternationalKeyboard=function(e,t,i){const s=WMKS.BROWSER.isChrome()&&e.altKey&&e.ctrlKey,n=WMKS.BROWSER.isFirefox()&&e.altKey&&e.ctrlKey,o=0===e.keyCode&&WMKS.BROWSER.isFirefox()&&e.key&&0===e.charCode,r=-1!==WMKS.CONST.KB.WestEuroLanguage.indexOf(this.keyboardLayoutId);switch(!r&&0===e.keyCode&&WMKS.BROWSER.isFirefox()&&e.key&&!t&&(t=0),this.keyboardLayoutId){case"ja-JP_106/109":t=this.getRemapPendingKey(t,i);break;case"de-DE":(123==t||124==t||125==t)&&(s||WMKS.BROWSER.isFirefox)&&WMKS.BROWSER.isWindows()&&(123==t?t=124:124==t?t=8804:125==t&&(t=8800)),192==t&&WMKS.BROWSER.isFirefox()&&WMKS.BROWSER.isMacOS()&&(t=187),t=this.getRemapPendingKey(t,i);break;case"it-IT":37===e.keyCode&&s&&(t=e.keyCode+1e3),o&&"#"==e.key&&WMKS.BROWSER.isWindows()&&(t=35);break;case"es-ES":0===e.keyCode&&WMKS.BROWSER.isFirefox()&&(" "==e.key||"Dead"==e.key)&&0==e.charCode&&0==e.which&&(t=222),o&&"\\"==e.key&&WMKS.BROWSER.isWindows()&&(t=186),(48===e.keyCode||34===e.keyCode)&&s&&(t=e.keyCode+1e3),t=this.getRemapPendingKey(t,i);break;case"pt-PT":(123==t||167==t)&&(s||WMKS.BROWSER.isFirefox)&&WMKS.BROWSER.isWindows()&&(123==t?t=55:167==t&&(t=52)),WMKS.BROWSER.isFirefox&&WMKS.BROWSER.isWindows()&&("«"==e.key&&(t=187),"À"==e.key&&(t=333)),192==e.keyCode&&WMKS.BROWSER.isChrome&&WMKS.BROWSER.isWindows()&&(t=333);break;case"fr-FR":29===e.keyCode&&WMKS.BROWSER.isChrome()&&"€"!=e.key&&WMKS.BROWSER.isMacOS()&&(t=124),t=this.getRemapPendingKey(t,i);break;case"fr-CH":case"de-CH":if(!0===e.ctrlKey&&!0===e.altKey){const i=e.keyCode||e.which;WMKS.BROWSER.isMacOS()&&(61===i&&(t=187),34===e.keyCode&&WMKS.BROWSER.isChrome()&&(t=224))}96===(e.keyCode||e.which)&&(WMKS.BROWSER.isChrome()||WMKS.BROWSER.isFirefox())&&WMKS.BROWSER.isWindows()&&"`"===e.key&&(t=94),(o||WMKS.BROWSER.isMacOS()&&n)&&(t=this.getKeyCodeFromKey(e,t)||t),WMKS.BROWSER.isWindows()&&n&&(t=this.getRemapFrChAltgrKey(t)),"§"===e.key&&n&&WMKS.BROWSER.isMacOS()&&(t=232),"À"===e.key&&192===(e.keyCode||e.which)&&"de-CH"===this.keyboardLayoutId&&65!==i&&(WMKS.BROWSER.isMacOS()||WMKS.BROWSER.isFirefox()&&WMKS.BROWSER.isWindows())&&(t=1224),t=this.getRemapPendingKey(t,i)}return r&&(o||n)&&"fr-CH"!==this.keyboardLayoutId&&"de-CH"!==this.keyboardLayoutId&&(t=176===e.charCode&&WMKS.BROWSER.isMacOS()&&n?0:this.getKeyCodeFromKey(e,t)||t),t},this.getRemapFrChAltgrKey=function(e){const t=WMKS.keyboardUtils._remapFrChAltgrKey;return t&&t[e]&&(e=t[e]),e},this.getRemapPendingKey=function(e,t){const i=WMKS.keyboardUtils._remapPending[this.keyboardLayoutId];return i&&i[e]&&i[e]===t&&WMKS.BROWSER.isWindows()&&(e=t),e},this.getKeyCodeFromKey=function(e,t){const i=WMKS.keyboardUtils._charToKeycode[this.keyboardLayoutId];return i&&(t=i[e.key]),t},this.onKeyUp=function(e){let t,i,s,n,o=!1;return e.preventDefault?e.preventDefault():e.returnValue=!1,this.keyDownIdentifier=null,(i=this._extractKeyCodeFromEvent(e))?(t=i.keyCode,o=i.isUnicode,this._syncModifiers(e),0===t?(WMKS.LOGGER.log("onKeyUp: Do not send 0 to server."),!0):-1===$.inArray(t,WMKS.CONST.KB.Modifiers)&&(this._handleCapsLockKey(t),o?(WMKS.LOGGER.log("Sending unicode key up from keyIdentifier: "+t),this.sendKey(t,!0,!0)):this.keyToUnicodeMap.hasOwnProperty(t)?(s=this.keyToUnicodeMap[t],this.sendKey(s,!0,!0),delete this.keyToUnicodeMap[t]):this.keyToRawMap.hasOwnProperty(t)?(n=this.keyToRawMap[t],this.sendKey(n,!0,!1),delete this.keyToRawMap[t]):this.sendKey(t,!0,!1),!1)):(WMKS.LOGGER.debug("Extraction of keyCode from keyUp event failed."),!1)},this.onKeyUpSoftKb=function(e){return e.stopPropagation(),e.preventDefault(),!1},this.onKeyDownSoftKb=function(e){const t=e.keyCode||e.which;return!t||-1===WMKS.CONST.KB.SoftKBRawKeyCodes.indexOf(t)||(this.handleSoftKb(t,!1),!1)},this.onKeyPressSoftKb=function(e){const t=e.keyCode||e.which;return!(!WMKS.BROWSER.isAndroid()||!WMKS.BROWSER.isChrome())||($(e.target).val(WMKS.CONST.KB.keyInputDefaultValue),this.handleSoftKb(t,!0),!0)},this.onInputTextSoftKb=function(e){const t=$(e.target);let i=t.val();const s=WMKS.CONST.KB.keyInputDefaultValue.length;return WMKS.BROWSER.isIOS()?(t.val(WMKS.CONST.KB.keyInputDefaultValue),!1):(s>0&&(i=i.substring(s)),i.length>1?(i=i.charAt(0).toLowerCase()+i.slice(1),this.processInputString(i)):WMKS.BROWSER.isAndroid()&&WMKS.BROWSER.isChrome()&&this.processInputString(i),t.val(WMKS.CONST.KB.keyInputDefaultValue),!0)},this.processInputString=function(e,t){let i,s=!1;for(i=0;i<e.length;i++)t&&"\n"===e.charAt(i)?(this.sendKey(WMKS.CONST.KB.KEY_CODE.Enter,!1,!1),this.sendKey(WMKS.CONST.KB.KEY_CODE.Enter,!0,!1)):(s=e.charCodeAt(i),isNaN(s)||this.handleSoftKb(s,!0));return s},this.handleSoftKb=function(e,t){let i,s;(i=t&&WMKS.CONST.KB.UnicodeWithShift[e])?(!(s=-1!==$.inArray(WMKS.CONST.KB.KEY_CODE.Shift,this.activeModifiers))&&!this._isUnicodeInputSupported()&&this.sendKey(WMKS.CONST.KB.KEY_CODE.Shift,!1,!1),this.sendKey(e,!1,t),this.sendKey(e,!0,t),s||this._isUnicodeInputSupported()?s&&this._isUnicodeInputSupported()&&this.sendKey(WMKS.CONST.KB.KEY_CODE.Shift,!1,!1):this.sendKey(WMKS.CONST.KB.KEY_CODE.Shift,!0,!1)):(this.sendKey(e,!1,t),this.sendKey(e,!0,t))},this.isBrowserCapsLockOn=function(e,t,i){return!WMKS.BROWSER.isTouchDevice()&&t&&(WMKS.CONST.KB.UnicodeOnly[e]&&i||WMKS.CONST.KB.UnicodeWithShift[e]&&!i)},this.sendKey=function(e,t,i,s){this._vncDecoder.useVMWKeyEvent&&(i||-1===this.ignoredRawKeyCodes.indexOf(e))&&(this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw&&!0!==s?this._vncDecoder.onVMWKeyUnicode(e,!t,!i):this._sendVScanCode(e,t,i))},this._sendVScanCode=function(e,t,i){let s=null;if((i||13===e)&&(s=this.UnicodeToVScanMap[e]),!s){const t=WMKS.keyboardUtils._jsToVScanTables[this.keyboardLayoutId];!t||(s=t[e]),s||(s=WMKS.keyboardUtils._jsToVScanTable[e]),s||(s=this.UnicodeToVScanMap[e])}s?this._vncDecoder.onKeyVScan(s,!t):WMKS.LOGGER.debug("unknown key: "+e+(t?"-up":"-d"))},this.clearState=function(){this.activeModifiers.length=0,this.sendKey(WMKS.CONST.KB.KEY_CODE.Alt,!0,!1),this.sendKey(WMKS.CONST.KB.KEY_CODE.Ctrl,!0,!1),this.sendKey(WMKS.CONST.KB.KEY_CODE.Shift,!0,!1),WMKS.BROWSER.isMacOS()&&this.sendKey(WMKS.CONST.KB.KEY_CODE.Meta,!0,!1)},this.enableWindowsKey=function(e){this._windowsKeyManager.enabled=e},this.setIgnoredRawKeyCodes=function(e){this.ignoredRawKeyCodes=e},this._isUnicodeInputSupported=function(){return this._vncDecoder.allowVMWKeyEvent2UnicodeAndRaw}},WMKS.CONST.KB.UnicodeOnly={32:57,13:28,97:30,98:48,99:46,100:32,101:18,102:33,103:34,104:35,105:23,106:36,107:37,108:38,109:50,110:49,111:24,112:25,113:16,114:19,115:31,116:20,117:22,118:47,119:17,120:45,121:21,122:44,49:2,50:3,51:4,52:5,53:6,54:7,55:8,56:9,57:10,48:11,59:39,61:13,44:51,45:12,46:52,47:53,96:41,91:26,92:43,93:27,39:40},WMKS.CONST.KB.UnicodeWithShift={65:30,66:48,67:46,68:32,69:18,70:33,71:34,72:35,73:23,74:36,75:37,76:38,77:50,78:49,79:24,80:25,81:16,82:19,83:31,84:20,85:22,86:47,87:17,88:45,89:21,90:44,33:2,64:3,35:4,36:5,37:6,94:7,38:8,42:9,40:10,41:11,58:39,43:13,60:51,95:12,62:52,63:53,126:41,123:26,124:43,125:27,34:40},WMKS.CONST.KB.VScanMap["en-US"]=$.extend({},WMKS.CONST.KB.UnicodeOnly,WMKS.CONST.KB.UnicodeWithShift),WMKS.CONST.KB2={LedKeys:[WMKS.VSCAN_CODES.VSCAN_CAPSLOCK,WMKS.VSCAN_CODES.VSCAN_NUMLOCK,WMKS.VSCAN_CODES.VSCAN_SCROLL],GuiKeys:[WMKS.VSCAN_CODES.VSCAN_LGUI,WMKS.VSCAN_CODES.VSCAN_RGUI],ControlKeys:[WMKS.VSCAN_CODES.VSCAN_LCONTROL,WMKS.VSCAN_CODES.VSCAN_RCONTROL],ModifierKeys:[WMKS.VSCAN_CODES.VSCAN_LGUI,WMKS.VSCAN_CODES.VSCAN_RGUI,WMKS.VSCAN_CODES.VSCAN_LCONTROL,WMKS.VSCAN_CODES.VSCAN_RCONTROL,WMKS.VSCAN_CODES.VSCAN_LSHIFT,WMKS.VSCAN_CODES.VSCAN_RSHIFT,WMKS.VSCAN_CODES.VSCAN_LALT,WMKS.VSCAN_CODES.VSCAN_RALT]},WMKS.KeyboardManager2=function(e){"use strict";if(!e||!e.vncDecoder)return null;this._vncDecoder=e.vncDecoder,this._serverKeyboardLeds=0,this._guiToCtrlVScanMap=e.mapMetaToCtrlForVScans||{},this._enableWindowsKey=e.enableWindowsKey||!1,this._clientModifierStatus={},this._serverModifierStatus={},this.onKeyDown=function(e){const t=e.originalEvent.code,i=WMKS.keyboardUtils.fromKeyCodeToVScanCode[t];if(e.preventDefault(),e.stopPropagation(),void 0===i)return console.warn("onKeyDown: Fail to find the vScanCode for "+t),!1;if(WMKS.BROWSER.isMacOS()&&i==WMKS.VSCAN_CODES.VSCAN_NUMLOCK)return!1;if(-1!==WMKS.CONST.KB2.ModifierKeys.indexOf(i)&&(this._clientModifierStatus[i]=!0),this.checkKeyboardLedSync(e,i),this._enableWindowsKey&&(-1!==WMKS.CONST.KB2.ControlKeys.indexOf(i)||-1!==WMKS.CONST.KB2.GuiKeys.indexOf(i))){if(this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL]&&this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LGUI])return this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_LCONTROL,!1),this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_LGUI]||this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_LGUI,!0),!1;if(this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RCONTROL]&&this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RGUI])return this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_RCONTROL]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_RCONTROL,!1),this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_RGUI]||this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_RGUI,!0),!1}return-1!==this._guiToCtrlVScanMap.indexOf(i)&&(this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LGUI]&&!this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_LCONTROL,!0),this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RGUI]&&!this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_RCONTROL]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_RCONTROL,!0)),-1===WMKS.CONST.KB2.GuiKeys.indexOf(i)&&(WMKS.BROWSER.isWindows()&&(i==WMKS.VSCAN_CODES.VSCAN_RALT?this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_LCONTROL,!1):e.originalEvent.getModifierState("AltGraph")&&!this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_RALT]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_RALT,!0)),this.sendVScanKey(i,!0),WMKS.BROWSER.isMacOS()&&(i==WMKS.VSCAN_CODES.VSCAN_CAPSLOCK&&this.sendVScanKey(i,!1),(this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LGUI]||this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RGUI])&&-1==WMKS.CONST.KB2.ModifierKeys.indexOf(i)&&this.sendVScanKey(i,!1)),!1)},this.onKeyPress=function(e){return e.preventDefault(),e.stopPropagation(),!1},this.onKeyUp=function(e){const t=e.originalEvent.code,i=WMKS.keyboardUtils.fromKeyCodeToVScanCode[t];return e.preventDefault(),e.stopPropagation(),void 0===i?(console.warn("onKeyUp: Fail to find the vScanCode for "+t),!1):(!WMKS.BROWSER.isMacOS()||i!=WMKS.VSCAN_CODES.VSCAN_NUMLOCK)&&(-1!==WMKS.CONST.KB2.ModifierKeys.indexOf(i)&&(this._clientModifierStatus[i]=!1),(-1===WMKS.CONST.KB2.ControlKeys.indexOf(i)&&-1===WMKS.CONST.KB2.GuiKeys.indexOf(i)&&-1===this._guiToCtrlVScanMap.indexOf(i)||(this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_LGUI]&&(!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LGUI]||!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL])&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_LGUI,!1),this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_RGUI]&&(!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RGUI]||!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RCONTROL])&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_RGUI,!1),!!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL]!=!!this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_LCONTROL,!!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_LCONTROL]),!!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RCONTROL]!=!!this._serverModifierStatus[WMKS.VSCAN_CODES.VSCAN_RCONTROL]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_RCONTROL,!!this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RCONTROL]),WMKS.BROWSER.isWindows()&&WMKS.BROWSER.isFirefox()&&i==WMKS.VSCAN_CODES.VSCAN_LCONTROL&&this._clientModifierStatus[WMKS.VSCAN_CODES.VSCAN_RALT]&&this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_RALT,!1),-1===WMKS.CONST.KB2.ControlKeys.indexOf(i)&&-1===WMKS.CONST.KB2.GuiKeys.indexOf(i)))&&(this.sendVScanKey(i,!1),!1))},this.checkKeyboardLedSync=function(e,t){let i=e.originalEvent.getModifierState("CapsLock");const s=!!(this._serverKeyboardLeds&WMKS.KBD_LEDS.KBD_LED_CAPS_LOCK);let n=e.originalEvent.getModifierState("NumLock");const o=!!(this._serverKeyboardLeds&WMKS.KBD_LEDS.KBD_LED_NUM_LOCK);let r=e.originalEvent.getModifierState("ScrollLock");const a=!!(this._serverKeyboardLeds&WMKS.KBD_LEDS.KBD_LED_SCROLL_LOCK);if(WMKS.BROWSER.isMacOS()&&(n=!0),-1!==WMKS.CONST.KB2.LedKeys.indexOf(t)){if(!e.repeat)return;i=!i,n=!n,r=!r}i!==s&&(this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_CAPSLOCK,!0),this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_CAPSLOCK,!1)),n!==o&&(this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_NUMLOCK,!0),this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_NUMLOCK,!1)),r!==a&&(this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_SCROLL,!0),this.sendVScanKey(WMKS.VSCAN_CODES.VSCAN_SCROLL,!1))},this.processInputString=function(e,t){console.warn("processInputString is not supported by vscan keyboard.")},this.sendKey=function(e,t,i){console.warn("sendKey is not supported by vscan keyboard.")},this.enableWindowsKey=function(e){this._enableWindowsKey=e},this.setGuiToCtrlVScanMap=function(e){this._guiToCtrlVScanMap=e},this.setIgnoredRawKeyCodes=function(e){},this.sendVScanKey=function(e,t){this._vncDecoder.onKeyVScan(e,t),-1!==WMKS.CONST.KB2.ModifierKeys.indexOf(e)&&(this._serverModifierStatus[e]=t)},this.onKeyboardLEDsChanged=function(e){this._serverKeyboardLeds=e},this.cancelModifiers=function(e){for(const e in this._serverModifierStatus)this._serverModifierStatus[e]&&this.sendVScanKey(e,!1);this._clientModifierStatus={},this._serverModifierStatus={}},this.clearState=function(){this._clientModifierStatus={},this._serverModifierStatus={};for(let e=0;e<WMKS.CONST.KB2.ModifierKeys.length;++e)this.sendVScanKey(WMKS.CONST.KB2.ModifierKeys[e],!1)}},WMKS.keyboardUtils={},WMKS.keyboardUtils._keyInfoTemplate={jsScanCode:0,vScanCode:0},WMKS.keyboardUtils.keyDownUpInfo=function(e){const t=e||window.event,i=this._keyInfoTemplate;return"keydown"!==t.type&&"keyup"!==t.type||(i.jsScanCode=t.keyCode,i.vScanCode=this._jsToVScanTable[i.jsScanCode],WMKS.BROWSER.isIE()&&WMKS.BROWSER.version.major<=10&&13==i.jsScanCode&&(i.vScanCode=28)),i},WMKS.keyboardUtils.keyPressInfo=function(e){const t=e||window.event;let i=0;return"keypress"===t.type&&(8!=(i=t.which)&&9!=i&&27!=i||(i=0)),i},WMKS.keyboardUtils._jsToVScanTable={9:15,27:1,8:14,16:42,17:29,18:56,20:58,240:58,144:69,37:331,38:328,39:333,40:336,45:338,46:339,36:327,35:335,33:329,34:337,112:59,113:60,114:61,115:62,116:63,117:64,118:65,119:66,120:67,121:68,122:87,123:88,224:56,91:347,92:348,93:0,42:84,19:256},WMKS.keyboardUtils._jsToVScanTables={"de-DE":{220:41,221:13,192:13,192:41,187:13,96:13},"es-ES":{94:26,96:26,180:40,168:40,192:26,219:26,222:40,186:26,242:26},"it-IT":{5:18,30:26,29:27,64:39,35:40,91:26,93:27,171:27,109:39,186:39,123:26,125:27,8364:18}},WMKS.keyboardUtils._charToKeycode={"de-DE":{"ü":252,"Ü":252,"ö":246,"Ö":246,"ä":228,"Ä":228},"es-ES":{"[":192,"]":43,"{":222,"}":231,0:186,'"':1034,"º":186,"ª":186,"ç":231,"Ç":231,"Ñ":209,"ñ":209,"¡":261,"¿":161},"it-IT":{"[":30,"{":30,"]":29,"}":29,"@":1109,"%":1037,"à":1224,"°":1224,"è":232,"é":232,"ì":94,"^":94,"ò":242,"ç":242,"ù":249,"§":249},"pt-BR":{"ç":231,"Ç":231},"pt-PT":{"ç":231,"Ç":231,"º":186,"ª":186,"°":43,"«":187,"»":187,"À":333},"fr-FR":{"²":178},"fr-CH":{"§":167,"°":176,"è":232,"ü":252,"é":233,"ö":246,"à":1224,"ä":228,"[":232,"{":224,'"':1224},"de-CH":{"§":167,"°":176,"è":232,"ü":252,"é":233,"ö":246,"à":1224,"ä":228,"[":232,"{":224,'"':1224,"Ä":228,"Ö":246,"Ü":252,"À":1224,"È":232,"É":233}},WMKS.keyboardUtils._remapUncontrolKeys={"de-DE":{17:81,13:77},"es-ES":{27:219},"it-IT":{13:186},"pt-PT":{27:168},"fr-FR":{27:93},"fr-CH":{27:232},"de-CH":{27:232}},WMKS.keyboardUtils._keypressUnusefulKeys={"de-DE":[180,94,96],"es-ES":[180,96]},WMKS.keyboardUtils._SmallKeyboardKey={"de-DE":[47,42,61],"it-IT":[47,42,61],"es-ES":[47,42,61],"ja-JP_106/109":[42,43],"en-US":[42,43],"pt-BR":[42],"pt-PT":[42,47],"fr-FR":[43,46,47,48,49,50,51,52,53,54,55,56,57],"fr-CH":[42,43,47],"de-CH":[42,43,47]},WMKS.keyboardUtils._smallKeyboardPendingKey={"de-DE":{47:55,61:48},"fr-FR":{43:[187,61],46:[190,59],47:[191,58],48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57}},WMKS.keyboardUtils._WindowsFirefoxAltGr={"pt-PT":[64,91,93,123,125,163,167,168,178,8364],"de-DE":[64,91,92,93,123,124,125,126,172,178,179,181,8364],"it-IT":[35,64,91,93,123,125,8364],"es-ES":[35,64,91,92,93,123,124,125,126,172,178,179,181,8364],"fr-FR":[35,64,91,92,93,94,96,123,124,125,126,164,8364],"fr-CH":[35,64,91,92,93,123,124,125,126,162,166,172,167,176,219,8364],"de-CH":[35,64,91,92,93,123,124,125,126,162,166,172,167,176,8364]},WMKS.keyboardUtils._remapPending={"fr-CH":{224:65,232:69,233:69,228:65,246:79,252:85,192:65,219:85,241:78,209:78,176:52,167:53},"fr-FR":{224:65,232:69,236:73,242:79,249:85,241:78},"de-CH":{224:65,232:69,233:69,228:65,246:79,252:85,192:65,241:78,209:78,176:52,167:53,196:65,214:79,220:85,200:69,192:65,201:69,219:85},"de-DE":{193:65,201:69,205:73,211:79,218:85,194:65,202:69,206:73,212:79,219:85},"ja-JP_106/109":{92:226},"es-ES":{193:65,201:69,205:73,211:79,218:85,192:65,200:69,204:73,210:79,217:85,241:78}},WMKS.keyboardUtils._remapFrChAltgrKey={91:180,93:94,59:91,94:93,92:123,0:125},WMKS.keyboardUtils.fromKeyCodeToVScanCode={ControlLeft:WMKS.VSCAN_CODES.VSCAN_LCONTROL,ControlRight:WMKS.VSCAN_CODES.VSCAN_RCONTROL,ShiftLeft:WMKS.VSCAN_CODES.VSCAN_LSHIFT,ShiftRight:WMKS.VSCAN_CODES.VSCAN_RSHIFT,AltLeft:WMKS.VSCAN_CODES.VSCAN_LALT,AltRight:WMKS.VSCAN_CODES.VSCAN_RALT,MetaLeft:WMKS.VSCAN_CODES.VSCAN_LGUI,MetaRight:WMKS.VSCAN_CODES.VSCAN_RGUI,OSLeft:WMKS.VSCAN_CODES.VSCAN_LGUI,OSRight:WMKS.VSCAN_CODES.VSCAN_RGUI,Home:WMKS.VSCAN_CODES.VSCAN_HOME,ArrowUp:WMKS.VSCAN_CODES.VSCAN_UP,PageUp:WMKS.VSCAN_CODES.VSCAN_PAGEUP,ArrowLeft:WMKS.VSCAN_CODES.VSCAN_LEFT,ArrowRight:WMKS.VSCAN_CODES.VSCAN_RIGHT,End:WMKS.VSCAN_CODES.VSCAN_END,ArrowDown:WMKS.VSCAN_CODES.VSCAN_DOWN,PageDown:WMKS.VSCAN_CODES.VSCAN_PAGEDOWN,Insert:WMKS.VSCAN_CODES.VSCAN_INSERT,Delete:WMKS.VSCAN_CODES.VSCAN_DELETE,NumpadDivide:WMKS.VSCAN_CODES.VSCAN_NUMPAD_DIVIDE,NumpadMultiply:WMKS.VSCAN_CODES.VSCAN_NUMPAD_MULTIPLY,Numpad7:WMKS.VSCAN_CODES.VSCAN_NUMPAD_7,Numpad8:WMKS.VSCAN_CODES.VSCAN_NUMPAD_8,Numpad9:WMKS.VSCAN_CODES.VSCAN_NUMPAD_9,NumpadSubtract:WMKS.VSCAN_CODES.VSCAN_NUMPAD_MINUS,Numpad4:WMKS.VSCAN_CODES.VSCAN_NUMPAD_4,Numpad5:WMKS.VSCAN_CODES.VSCAN_NUMPAD_5,Numpad6:WMKS.VSCAN_CODES.VSCAN_NUMPAD_6,NumpadAdd:WMKS.VSCAN_CODES.VSCAN_NUMPAD_PLUS,Numpad1:WMKS.VSCAN_CODES.VSCAN_NUMPAD_1,Numpad2:WMKS.VSCAN_CODES.VSCAN_NUMPAD_2,Numpad3:WMKS.VSCAN_CODES.VSCAN_NUMPAD_3,Numpad0:WMKS.VSCAN_CODES.VSCAN_NUMPAD_0,NumpadDecimal:WMKS.VSCAN_CODES.VSCAN_NUMPAD_DOT,NumpadComma:WMKS.VSCAN_CODES.VSCAN_NUMPAD_COMMA,NumpadEnter:WMKS.VSCAN_CODES.VSCAN_NUMPAD_ENTER,NumpadEqual:WMKS.VSCAN_CODES.VSCAN_EQUALS,NumpadClear:WMKS.VSCAN_CODES.VSCAN_NUMLOCK,ScrollLock:WMKS.VSCAN_CODES.VSCAN_SCROLL,PrintScreen:WMKS.VSCAN_CODES.VSCAN_PRINT,Pause:WMKS.VSCAN_CODES.VSCAN_PAUSE,Backspace:WMKS.VSCAN_CODES.VSCAN_BACKSPACE,NumLock:WMKS.VSCAN_CODES.VSCAN_NUMLOCK,Tab:WMKS.VSCAN_CODES.VSCAN_TAB,Escape:WMKS.VSCAN_CODES.VSCAN_ESCAPE,Enter:WMKS.VSCAN_CODES.VSCAN_ENTER,Space:WMKS.VSCAN_CODES.VSCAN_SPACE,CapsLock:WMKS.VSCAN_CODES.VSCAN_CAPSLOCK,F1:WMKS.VSCAN_CODES.VSCAN_F1,F2:WMKS.VSCAN_CODES.VSCAN_F2,F3:WMKS.VSCAN_CODES.VSCAN_F3,F4:WMKS.VSCAN_CODES.VSCAN_F4,F5:WMKS.VSCAN_CODES.VSCAN_F5,F6:WMKS.VSCAN_CODES.VSCAN_F6,F7:WMKS.VSCAN_CODES.VSCAN_F7,F8:WMKS.VSCAN_CODES.VSCAN_F8,F9:WMKS.VSCAN_CODES.VSCAN_F9,F10:WMKS.VSCAN_CODES.VSCAN_F10,F11:WMKS.VSCAN_CODES.VSCAN_F11,F12:WMKS.VSCAN_CODES.VSCAN_F12,F13:WMKS.VSCAN_CODES.VSCAN_F13,F14:WMKS.VSCAN_CODES.VSCAN_F14,F15:WMKS.VSCAN_CODES.VSCAN_F15,F16:WMKS.VSCAN_CODES.VSCAN_F16,F17:WMKS.VSCAN_CODES.VSCAN_F17,F18:WMKS.VSCAN_CODES.VSCAN_F18,F19:WMKS.VSCAN_CODES.VSCAN_F19,F20:WMKS.VSCAN_CODES.VSCAN_F20,F21:WMKS.VSCAN_CODES.VSCAN_F21,F22:WMKS.VSCAN_CODES.VSCAN_F22,F23:WMKS.VSCAN_CODES.VSCAN_F23,F24:WMKS.VSCAN_CODES.VSCAN_F24,KeyA:WMKS.VSCAN_CODES.VSCAN_A,KeyB:WMKS.VSCAN_CODES.VSCAN_B,KeyC:WMKS.VSCAN_CODES.VSCAN_C,KeyD:WMKS.VSCAN_CODES.VSCAN_D,KeyE:WMKS.VSCAN_CODES.VSCAN_E,KeyF:WMKS.VSCAN_CODES.VSCAN_F,KeyG:WMKS.VSCAN_CODES.VSCAN_G,KeyH:WMKS.VSCAN_CODES.VSCAN_H,KeyI:WMKS.VSCAN_CODES.VSCAN_I,KeyJ:WMKS.VSCAN_CODES.VSCAN_J,KeyK:WMKS.VSCAN_CODES.VSCAN_K,KeyL:WMKS.VSCAN_CODES.VSCAN_L,KeyM:WMKS.VSCAN_CODES.VSCAN_M,KeyN:WMKS.VSCAN_CODES.VSCAN_N,KeyO:WMKS.VSCAN_CODES.VSCAN_O,KeyP:WMKS.VSCAN_CODES.VSCAN_P,KeyQ:WMKS.VSCAN_CODES.VSCAN_Q,KeyR:WMKS.VSCAN_CODES.VSCAN_R,KeyS:WMKS.VSCAN_CODES.VSCAN_S,KeyT:WMKS.VSCAN_CODES.VSCAN_T,KeyU:WMKS.VSCAN_CODES.VSCAN_U,KeyV:WMKS.VSCAN_CODES.VSCAN_V,KeyW:WMKS.VSCAN_CODES.VSCAN_W,KeyX:WMKS.VSCAN_CODES.VSCAN_X,KeyY:WMKS.VSCAN_CODES.VSCAN_Y,KeyZ:WMKS.VSCAN_CODES.VSCAN_Z,Backquote:WMKS.VSCAN_CODES.VSCAN_TILDE,Digit0:WMKS.VSCAN_CODES.VSCAN_0,Digit9:WMKS.VSCAN_CODES.VSCAN_9,Digit8:WMKS.VSCAN_CODES.VSCAN_8,Digit7:WMKS.VSCAN_CODES.VSCAN_7,Digit6:WMKS.VSCAN_CODES.VSCAN_6,Digit5:WMKS.VSCAN_CODES.VSCAN_5,Digit4:WMKS.VSCAN_CODES.VSCAN_4,Digit3:WMKS.VSCAN_CODES.VSCAN_3,Digit2:WMKS.VSCAN_CODES.VSCAN_2,Digit1:WMKS.VSCAN_CODES.VSCAN_1,Equal:WMKS.VSCAN_CODES.VSCAN_EQUALS,Minus:WMKS.VSCAN_CODES.VSCAN_MINUS,Slash:WMKS.VSCAN_CODES.VSCAN_FWDSLASH,BracketLeft:WMKS.VSCAN_CODES.VSCAN_LBRACKET,BracketRight:WMKS.VSCAN_CODES.VSCAN_RBRACKET,Backslash:WMKS.VSCAN_CODES.VSCAN_BACKSLASH,Semicolon:WMKS.VSCAN_CODES.VSCAN_COLON,Quote:WMKS.VSCAN_CODES.VSCAN_QUOTE,Comma:WMKS.VSCAN_CODES.VSCAN_COMMA,Period:WMKS.VSCAN_CODES.VSCAN_PERIOD,IntlBackslash:WMKS.VSCAN_CODES.VSCAN_EUROPE2,ContextMenu:WMKS.VSCAN_CODES.VSCAN_MENU,KanaMode:WMKS.VSCAN_CODES.VSCAN_HIRAGANA,IntlRo:WMKS.VSCAN_CODES.VSCAN_RO,IntlYen:WMKS.VSCAN_CODES.VSCAN_YEN,Convert:WMKS.VSCAN_CODES.VSCAN_HENKAN,NonConvert:WMKS.VSCAN_CODES.VSCAN_MUHENKAN,Power:WMKS.VSCAN_CODES.VSCAN_POWER,Lang1:WMKS.VSCAN_CODES.VSCAN_HANGUL_EN,Lang2:WMKS.VSCAN_CODES.VSCAN_HANJA_EN,MediaTrackPrevious:WMKS.VSCAN_CODES.VSCAN_SCAN_PREVIOUS_TRACK,MediaTrackNext:WMKS.VSCAN_CODES.VSCAN_SCAN_NEXT_TRACK,VolumeMute:WMKS.VSCAN_CODES.VSCAN_MUTE,AudioVolumeMute:WMKS.VSCAN_CODES.VSCAN_MUTE,LaunchApp2:WMKS.VSCAN_CODES.VSCAN_CALCULATOR,MediaPlayPause:WMKS.VSCAN_CODES.VSCAN_PLAY_PAUSE,MediaStop:WMKS.VSCAN_CODES.VSCAN_STOP,VolumeDown:WMKS.VSCAN_CODES.VSCAN_VOLUME_DOWN,VolumeUp:WMKS.VSCAN_CODES.VSCAN_VOLUME_UP,AudioVolumeDown:WMKS.VSCAN_CODES.VSCAN_VOLUME_DOWN,AudioVolumeUp:WMKS.VSCAN_CODES.VSCAN_VOLUME_UP,BrowserHome:WMKS.VSCAN_CODES.VSCAN_BROWSER_HOME,BrowserSearch:WMKS.VSCAN_CODES.VSCAN_BROWSER_SEARCH,BrowserFavorites:WMKS.VSCAN_CODES.VSCAN_BROWSER_FAVORITES,BrowserRefresh:WMKS.VSCAN_CODES.VSCAN_BROWSER_REFRESH,BrowserStop:WMKS.VSCAN_CODES.VSCAN_BROWSER_STOP,BrowserForward:WMKS.VSCAN_CODES.VSCAN_BROWSER_FORWARD,BrowserBack:WMKS.VSCAN_CODES.VSCAN_BROWSER_BACK,LaunchApp1:WMKS.VSCAN_CODES.VSCAN_MY_COMPUTER,LaunchMail:WMKS.VSCAN_CODES.VSCAN_MAIL,MediaSelect:WMKS.VSCAN_CODES.VSCAN_MEDIA_SELECT},WMKS.CONST.TOUCH={FEATURE:{SoftKeyboard:0,ExtendedKeypad:1,Trackpad:2},tapMoveCorrectionDistancePx:10,additionalTouchIgnoreGapMs:1200,touchMoveSampleMinCount:2,minKeyboardToggleTime:50,leftDragDelayMs:300,OP:{none:"none",scroll:"scroll",drag:"drag",move:"move",tap_twice:"double-click",tap_1finger:"click",tap_3finger:"tap-3f"},SCROLL:{minDeltaDistancePx:20},DOUBLE_TAP:{tapGapInTime:250,tapGapBonusTime:200,tapGapBonus4TimeRatio:.4,tapGapInDistance:40}},WMKS.TouchHandler=function(e){"use strict";if(!(e&&e.canvas&&e.widgetProto&&e.keyboardManager))return WMKS.LOGGER.warn("Invalid params set for TouchHandler."),null;let t=e.widgetProto,i=e.keyboardManager;const s={visible:!1,lastToggleTime:0};let n=[],o=e.canvas;const r=e.onToggle;let a=null,c={currentTouchFingers:-1,firstTouch:null,currentTouch:null,touchArray:[],tapStartTime:null,touchMoveCount:0,skipScrollCount:0,scrollCount:0,zoomCount:0,opType:WMKS.CONST.TOUCH.OP.none},h={inputProxy:null,cursorIcon:null,clickFeedback:null,dragFeedback:null,pulseFeedback:null,scrollFeedback:null,keypad:null,trackpad:null};this._verifyQuickTouches=function(e,t,i){return c.opType===WMKS.CONST.TOUCH.OP.none&&t>50&&1===i&&(WMKS.LOGGER.debug("Special case - touchmove#: "+i+", targetTouches#: "+e.targetTouches.length+", dist: "+t+", scale: "+e.scale),!0)},this._initDragEventAndSendFeedback=function(e){if(c.opType===WMKS.CONST.TOUCH.OP.drag){const i=this._applyZoomCorrectionToTouchXY(e);t.sendMouseButtonMessage(i,!0,WMKS.CONST.CLICK.left,"Touch"),this._showFeedback(h.dragFeedback,e)}},this._initTwoFingerTouch=function(e,t){c.opType===WMKS.CONST.TOUCH.OP.none&&(c.currentTouchFingers=2,c.touchArray.push(e),c.touchArray.push(t),c.firstTouch=WMKS.UTIL.TOUCH.copyTouch(WMKS.UTIL.TOUCH.leftmostOf(e,t)),c.currentTouch=WMKS.UTIL.TOUCH.copyTouch(c.firstTouch))},this._sendScrollEventMessage=function(e){let i,s,n,o,r=0,a=0;c.opType===WMKS.CONST.TOUCH.OP.scroll&&(i=e.clientX-c.currentTouch.clientX,s=e.clientY-c.currentTouch.clientY,r=(n=this._calculateMouseWheelDeltas(i,s)).wheelDeltaX,a=n.wheelDeltaY,0===r&&0===a||(o=this._applyZoomCorrectionToTouchXY(c.touchArray[0]),t.sendScrollMessage(o,r,a),0!==r&&(c.currentTouch.clientX=e.clientX),0!==a&&(c.currentTouch.clientY=e.clientY)))},this._calculateMouseWheelDeltas=function(e,i){let s=0,n=0;const o=Math.abs(e),r=Math.abs(i);let a=o>WMKS.CONST.TOUCH.SCROLL.minDeltaDistancePx,c=r>WMKS.CONST.TOUCH.SCROLL.minDeltaDistancePx;return a&&c&&(r<o?c=!1:a=!1),a&&(s=e>0?1:-1),c&&(n=i>0?-1:1),t.options.reverseScrollY&&(n*=-1),{wheelDeltaX:s,wheelDeltaY:n}},this._updatePreScrollState=function(e){const t=e.clientY-c.currentTouch.clientY;c.scrollCount++,t<0?c.skipScrollCount--:c.skipScrollCount++},this._sendResidualScrollEventMessage=function(){if(0!==c.skipScrollCount&&c.currentTouch){let e,i;i=c.skipScrollCount<0?-1:1,WMKS.LOGGER.debug("Sending a residual scroll message."),WMKS.LOGGER.debug("Cur touch: "+c.currentTouch.pageX+" , "+c.currentTouch.pageY),c.skipScrollCount=0,e=this._applyZoomCorrectionToTouchXY(c.currentTouch),t.sendScrollMessage(e,i,0)}},this._isDoubleTap=function(e,t){let i,s;if(null===c.currentTouch||null===c.tapStartTime||c.opType!==WMKS.CONST.TOUCH.OP.none)return!1;if(i=WMKS.UTIL.TOUCH.touchDistance(c.currentTouch,e.targetTouches[0]),s=t-c.tapStartTime,i<WMKS.CONST.TOUCH.DOUBLE_TAP.tapGapInDistance){if(s<WMKS.CONST.TOUCH.DOUBLE_TAP.tapGapInTime)return!0;if(i/WMKS.CONST.TOUCH.DOUBLE_TAP.tapGapInDistance<WMKS.CONST.TOUCH.DOUBLE_TAP.tapGapBonus4TimeRatio&&s<WMKS.CONST.TOUCH.DOUBLE_TAP.tapGapInTime+WMKS.CONST.TOUCH.DOUBLE_TAP.tapGapBonusTime)return!0}return!1},this._onTouchStart=function(e){let i,s;const n=this,o=$.now();return 1===e.targetTouches.length?(this._isDoubleTap(e,o)?(c.firstTouch=WMKS.UTIL.TOUCH.copyTouch(c.currentTouch),c.opType=WMKS.CONST.TOUCH.OP.tap_twice):(c.firstTouch=WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[0]),c.currentTouch=WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[0])),c.currentTouchFingers=1,c.tapStartTime=o,null!==a&&clearTimeout(a),a=setTimeout(function(){a=null,c.opType=WMKS.CONST.TOUCH.OP.drag,n._initDragEventAndSendFeedback(c.firstTouch)},WMKS.CONST.TOUCH.leftDragDelayMs),!0):2===e.targetTouches.length?(1===c.currentTouchFingers&&((s=o-c.tapStartTime)>WMKS.CONST.TOUCH.additionalTouchIgnoreGapMs&&c.opType===WMKS.CONST.TOUCH.OP.drag&&(i=this._applyZoomCorrectionToTouchXY(e.targetTouches[0]),t.sendMouseButtonMessage(i,!0,WMKS.CONST.CLICK.left,"Touch"),this._resetTouchState())),this._initTwoFingerTouch(WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[0]),WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[1])),!0):3===e.targetTouches.length?(WMKS.BROWSER.isChromeOS()||c.opType===WMKS.CONST.TOUCH.OP.none&&(c.opType=WMKS.CONST.TOUCH.OP.tap_3finger,this.toggleKeyboard(),c.currentTouchFingers=3),!1):void 0},this._onTouchMove=function(e){let i,s;if(null!==a&&(clearTimeout(a),a=null),c.touchMoveCount++,-1===c.currentTouchFingers)return!0;if(c.opType===WMKS.CONST.TOUCH.OP.scroll)return this._sendScrollEventMessage(e.targetTouches[0]),!1;if(c.opType===WMKS.CONST.TOUCH.OP.drag)return c.currentTouch=WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[0]),this.moveCursor(e.targetTouches[0].pageX,e.targetTouches[0].pageY),s=this._applyZoomCorrectionToTouchXY(e.targetTouches[0]),t.sendMouseMoveMessage(s,"Touch"),!1;if(c.opType===WMKS.CONST.TOUCH.OP.tap_3finger)return!1;if(c.currentTouchFingers!==e.targetTouches.length){if(2!==c.currentTouchFingers||1!==e.targetTouches.length)return 1===c.currentTouchFingers&&2===e.targetTouches.length?(WMKS.LOGGER.debug("touch: 1 -> 2, init 2fingertap if no opType: "+c.opType),this._initTwoFingerTouch(WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[0]),WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[1])),!0):(WMKS.LOGGER.debug("touch: 2 -> 1: infer as PINCH/ZOOM."),this._resetTouchState(),!0);if(c.opType===WMKS.CONST.TOUCH.OP.none&&1===e.scale)return WMKS.LOGGER.debug("touch: 2 -> 1 & !scroll, hence right-click."),this._sendTwoTouchEvent(c.firstTouch,c.firstTouch,WMKS.CONST.CLICK.right,e),this._resetTouchState(),!1}else{if(1===c.currentTouchFingers)return i=WMKS.UTIL.TOUCH.touchDistance(e.targetTouches[0],c.currentTouch),this._verifyQuickTouches(e,i,c.touchMoveCount)?(this._initTwoFingerTouch(WMKS.UTIL.TOUCH.copyTouch(c.firstTouch),WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[0])),c.opType=WMKS.CONST.TOUCH.OP.scroll,!1):i<WMKS.CONST.TOUCH.tapMoveCorrectionDistancePx||(this._resetTouchState(),!0);if(2===c.currentTouchFingers&&c.opType===WMKS.CONST.TOUCH.OP.none){if(0===c.touchArray.length||2!==c.touchArray.length)return this._resetTouchState(),!0;if(1===e.scale&&c.touchMoveCount<5)return!0;let t=WMKS.UTIL.TOUCH.touchAngleBwLines(c.touchArray[0],e.targetTouches[0],c.touchArray[1],e.targetTouches[1]);if(0===(t=Math.abs(t)))return!0;if(t<1||t>5.2){if(this._updatePreScrollState(e.targetTouches[0]),c.scrollCount>=WMKS.CONST.TOUCH.touchMoveSampleMinCount)return this._showFeedback(h.scrollFeedback,c.firstTouch,{position:"left",offsetLeft:-50,offsetTop:-25}),c.opType=WMKS.CONST.TOUCH.OP.scroll,c.currentTouch=WMKS.UTIL.TOUCH.copyTouch(e.targetTouches[0]),!1}else if(c.zoomCount++,c.zoomCount>=WMKS.CONST.TOUCH.touchMoveSampleMinCount)return this._resetTouchState(),!0;return!0}}return!0},this._onTouchEnd=function(e){let i,s;if(null!==a&&(clearTimeout(a),a=null),-1===c.currentTouchFingers)return!0;if(0===e.targetTouches.length){switch(0!==c.skipScrollCount&&(c.opType=WMKS.CONST.TOUCH.OP.scroll),c.opType){case WMKS.CONST.TOUCH.OP.scroll:return this._sendResidualScrollEventMessage(e),this._resetTouchState(),!1;case WMKS.CONST.TOUCH.OP.tap_twice:return this._sendTwoTouchEvent(c.firstTouch,c.currentTouch,WMKS.CONST.CLICK.left,e),this._resetTouchState(),!1;case WMKS.CONST.TOUCH.OP.tap_3finger:return this._resetTouchState(),!1;case WMKS.CONST.TOUCH.OP.drag:return 1===(s=e.changedTouches).length?(i=this._applyZoomCorrectionToTouchXY(s[0]),t.sendMouseButtonMessage(i,!1,WMKS.CONST.CLICK.left,"Touch")):WMKS.LOGGER.warn("Unexpected touch# "+s.length+" changed in a drag operation!"),this._resetTouchState(),!1;default:if(1===c.currentTouchFingers)return this._sendTwoTouchEvent(c.firstTouch,c.currentTouch,WMKS.CONST.CLICK.left,e),this._resetTouchState(!0),!1;if(2===c.currentTouchFingers)return this._sendTwoTouchEvent(c.firstTouch,c.firstTouch,WMKS.CONST.CLICK.right,e),this._resetTouchState(),!1}return this._resetTouchState(),!1}},this._resetTouchState=function(e){e||(c.tapStartTime=null,c.currentTouch=null),c.currentTouchFingers=-1,c.opType=WMKS.CONST.TOUCH.OP.none,c.firstTouch=null,c.touchArray.length=0,c.touchMoveCount=0,c.skipScrollCount=0,c.scrollCount=0,c.zoomCount=0},this._sendTwoTouchEvent=function(e,i,s){let n=this._applyZoomCorrectionToTouchXY(e);return t.sendMouseButtonMessage(n,!0,s,"Touch"),c.opType===WMKS.CONST.TOUCH.OP.tap_twice?(t.sendMouseButtonMessage(n,!1,s,"Touch"),this._showFeedback(h.clickFeedback,e,{showTwice:!0})):(n=this._applyZoomCorrectionToTouchXY(i),t.sendMouseButtonMessage(n,!1,s,"Touch"),this._showFeedback(h.clickFeedback,e)),!0},this.addToRepositionQueue=function(e){e&&n.push(e)},this.widgetRepositionOnRotation=function(e){let t,i,s,n,o=!1;return WMKS.BROWSER.isTouchDevice()?!(!e||e.is(":hidden"))&&(t=e.width(),i=e.height(),s=window.innerWidth,n=window.innerHeight,WMKS.UTIL.TOUCH.isPortraitOrientation()?e.offset().left+t>s&&(e.offset({left:String(s-t-5)}),o=!0):e.offset().top+i>n&&(e.offset({top:String(n-i-5)}),o=!0),o):(WMKS.LOGGER.warn("Widget reposition ignored, this is not a touch device."),!1)},this._repositionFloatingElementsOnRotation=function(e){const t=this,i=o.offset();this.widgetRepositionOnRotation(h.inputProxy),this.widgetRepositionOnRotation(h.cursorIcon),h.clickFeedback.offset(i),h.dragFeedback.offset(i),h.pulseFeedback.offset(i),h.scrollFeedback.offset(i),$.each(n,function(e,i){try{t.widgetRepositionOnRotation(i)}catch(e){WMKS.LOGGER.warn("Custom element reposition failed: "+e)}})},this._onOrientationChange=function(e){const t=this;this._isInputInFocus()&&$(window).one("resize",function(e){setTimeout(function(){$(window).trigger("orientationchange"),t._repositionFloatingElementsOnRotation()},500)})},this._applyZoomCorrectionToTouchXY=function(e){return null===e?(WMKS.LOGGER.warn("Unexpected: touch is null."),null):t.getEventPosition(e)},this._showFeedback=function(e,t,i){let s,n,r;const a=i||{};let c,h;if(t&&e){if(n=a.offsetLeft||0,r=a.offsetTop||0,c=0,h=0,WMKS.BROWSER.isChromeOS()){const e=o.offset();c=-e.left,h=-e.top}s=WMKS.UTIL.TOUCH.getRelativePositionMultiplier(a.position),e.css({left:t.pageX+n+c+e.outerWidth()*s.width,top:t.pageY+r+h+e.outerHeight()*s.height}),this.moveCursor(t.pageX+c,t.pageY+h),e.removeClass("animate-feedback-indicator animate-double-feedback-indicator"),a.showTwice?setTimeout(function(){e.addClass("animate-double-feedback-indicator")},0):setTimeout(function(){e.addClass("animate-feedback-indicator")},0)}else WMKS.LOGGER.trace("No touch value / feedback object, skip feedback.")},this.moveCursor=function(e,t){h.cursorIcon&&h.cursorIcon.css({left:e,top:t})},this.setCursorVisibility=function(e){h.cursorIcon&&(e?h.cursorIcon.show():h.cursorIcon.hide())},this._sendKeyInput=function(e){t.sendKeyInput(e)},this.onCaretPositionChanged=function(e){let t,i;h.inputProxy&&(t=e.x,i=e.y,t<window.pageXOffset&&(t=window.pageXOffset),i<window.pageYOffset&&(i=window.pageYOffset),h.inputProxy.offset({left:t,top:i}))},this._keyboardDisplay=function(e){e?(o.focus(),h.inputProxy.focus().select()):(WMKS.BROWSER.isAndroid()&&(h.inputProxy.attr("readonly",!0).attr("disabled",!0),setTimeout(function(){h&&(h.inputProxy.attr("readonly",!1).attr("disabled",!1),o.focus())},100)),document.activeElement.blur(),s.visible=!1)},this._isInputInFocus=function(){return"input-proxy"===document.activeElement.id},this._onInputFocus=function(e){return this._sendUpdatedKeyboardState(!0),e.stopPropagation(),!0},this._onInputBlur=function(e){return this._sendUpdatedKeyboardState(!1),e.stopPropagation(),!0},this._sendUpdatedKeyboardState=function(e){s.visible=e,s.lastToggleTime=$.now(),$.isFunction(r)&&r.call(this,["KEYBOARD",s.visible])},this.toggleKeyboard=function(e){WMKS.BROWSER.isTouchDevice()?h.inputProxy&&(e&&e.show===s.visible||($.now()-s.lastToggleTime<WMKS.CONST.TOUCH.minKeyboardToggleTime?WMKS.LOGGER.warn("Ignore kb toggle - Got request soon after focus/blur."):this._keyboardDisplay(!s.visible))):WMKS.LOGGER.warn("Mobile keyboard not supported, this is not a touch device.")},this.toggleTrackpad=function(e){WMKS.BROWSER.isTouchDevice()?h.trackpad&&(e=$.extend({},e,{toggleCallback:r}),h.trackpad.toggle(e)):WMKS.LOGGER.warn("Trackpad not supported. Not a touch device.")},this.toggleExtendedKeypad=function(e){WMKS.BROWSER.isTouchDevice()?h.keypad&&(e=$.extend({},e,{toggleCallback:r}),h.keypad.toggle(e)):WMKS.LOGGER.warn("Extended keypad not supported. Not a touch device.")},this.installTouchHandlers=function(){const e=this,t=o.parent();WMKS.BROWSER.isTouchDevice()?(o.css({"-webkit-user-select":"none","-webkit-touch-callout":"none"}),o.bind("touchmove.wmks",function(t){return e._onTouchMove(t.originalEvent)}).bind("touchstart.wmks",function(t){return e._onTouchStart(t.originalEvent)}).bind("touchend.wmks",function(t){return e._onTouchEnd(t.originalEvent)}).bind("orientationchange.wmks",function(t){return e._onOrientationChange(t)}).bind("orientationchange.wmks.elements",function(t){e._repositionFloatingElementsOnRotation(t)}),h.cursorIcon=$("<div/>").addClass("feedback-container cursor-icon").appendTo(t),h.clickFeedback=$("<div/>").addClass("feedback-container tap-icon").appendTo(t),h.dragFeedback=$("<div/>").addClass("feedback-container drag-icon").appendTo(t),h.pulseFeedback=$("<div/>").addClass("feedback-container pulse-icon").appendTo(t),h.scrollFeedback=$("<div/>").addClass("feedback-container scroll-icon").appendTo(t),t.find(".feedback-container").bind("touchmove.wmks",function(t){return e._onTouchMove(t.originalEvent)}).bind("touchstart.wmks",function(t){return e._onTouchStart(t.originalEvent)}).bind("touchend.wmks",function(t){return e._onTouchEnd(t.originalEvent)})):WMKS.LOGGER.log("Not a touch device, and hence skip touch handler")},this.disconnectEvents=function(){o&&(o.unbind("orientationchange.wmks.icons").unbind("orientationchange.wmks").unbind("touchmove.wmks").unbind("touchstart.wmks").unbind("touchend.wmks"),o.find(".feedback-container").unbind("touchmove.wmks").unbind("touchstart.wmks").unbind("touchend.wmks"))},this.initializeMobileFeature=function(e){if(WMKS.BROWSER.isTouchDevice())switch(e){case WMKS.CONST.TOUCH.FEATURE.Trackpad:h.trackpad=new WMKS.trackpadManager(t,o),h.trackpad.initialize();break;case WMKS.CONST.TOUCH.FEATURE.ExtendedKeypad:h.keypad=new WMKS.extendedKeypad({widget:t,parentElement:o.parent(),keyboardManager:i}),h.keypad.initialize();break;case WMKS.CONST.TOUCH.FEATURE.SoftKeyboard:h.inputProxy=this.initSoftKeyboard();break;default:WMKS.LOGGER.error("Invalid mobile feature type: "+e)}},this.initSoftKeyboard=function(){const e=this,t=i,s=$('<input type="text"/>').val(WMKS.CONST.KB.keyInputDefaultValue).attr({id:"input-proxy",autocorrect:"off",autocapitalize:"off"}).css({"font-size":"1px",width:"1px",height:"1px","background-color":"transparent",color:"transparent","box-shadow":0,outline:"none",border:0,padding:0,left:-1,top:-1,overflow:"hidden",position:"absolute"}).bind("blur",function(t){return e._onInputBlur(t)}).bind("focus",function(t){return e._onInputFocus(t)}).bind("input",function(e){return t.onInputTextSoftKb(e)}).bind("keydown",function(e){return t.onKeyDownSoftKb(e)}).bind("keyup",function(e){return t.onKeyUpSoftKb(e)}).bind("keypress",function(e){return t.onKeyPressSoftKb(e)}).insertBefore(o.parent());return WMKS.BROWSER.isIOS()&&s.css({"-webkit-touch-callout":"none"}),s},this.removeMobileFeature=function(e){switch(e){case WMKS.CONST.TOUCH.FEATURE.Trackpad:h.trackpad&&(h.trackpad.destroy(),h.trackpad=null);break;case WMKS.CONST.TOUCH.FEATURE.ExtendedKeypad:h.keypad&&(h.keypad.destroy(),h.keypad=null);break;case WMKS.CONST.TOUCH.FEATURE.SoftKeyboard:h.inputProxy&&(s.visible&&this.toggleKeyboard(!1),h.inputProxy.remove(),h.inputProxy=null);break;default:WMKS.LOGGER.error("Invalid mobile feature type: "+e)}},this.destroy=function(){this.disconnectEvents(),this.removeMobileFeature(WMKS.CONST.TOUCH.FEATURE.SoftKeyboard),this.removeMobileFeature(WMKS.CONST.TOUCH.FEATURE.ExtendedKeypad),this.removeMobileFeature(WMKS.CONST.TOUCH.FEATURE.Trackpad),t=null,o=null,i=null,c=null,h=null,n.length=0,n=null}},WMKS.UTIL.TOUCH={isLandscapeOrientation:function(){if(WMKS.BROWSER.isChromeOS()){const e=(screen.orientation||{}).type;return void 0===e||"landscape-primary"===e||"landscape-secondary"===e}return 90===window.orientation||-90===window.orientation},isPortraitOrientation:function(){if(WMKS.BROWSER.isChromeOS()){const e=(screen.orientation||{}).type;return"portrait-secondary"===e||"portrait-primary"===e}return 0===window.orientation||180===window.orientation},getRelativePositionMultiplier:function(e){let t=-.5,i=-.5;return!e||(-1!==e.indexOf("left")?t=-1:-1!==e.indexOf("right")&&(t=1),-1!==e.indexOf("top")?i=-1:-1!==e.indexOf("bottom")&&(i=1)),{width:t,height:i}},touchEqual:function(e,t){return e.screenX===t.screenX&&e.screenY===t.screenY},touchDistance:function(e,t){return WMKS.UTIL.getLineLength(t.screenX-e.screenX,t.screenY-e.screenY)},touchAngleBwLines:function(e,t,i,s){return Math.atan2(e.screenY-t.screenY,e.screenX-t.screenX)-Math.atan2(i.screenY-s.screenY,i.screenX-s.screenX)},copyTouch:function(e){return{screenX:e.screenX,screenY:e.screenY,clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY}},leftmostOf:function(e,t){return e.screenX<t.screenX?e:t}},WMKS.widgetProto={},WMKS.widgetProto.options={fitToParent:!1,fitGuest:!1,useNativePixels:!1,isFitToViewer:!0,isShadow:!1,allowMobileKeyboardInput:!0,useUnicodeKeyboardInput:!1,useVNCHandshake:!0,VCDProxyHandshakeVmxPath:null,reverseScrollY:!1,allowMobileExtendedKeypad:!0,allowMobileTrackpad:!0,enableVorbisAudioClips:!1,enableOpusAudioClips:!1,enableAacAudioClips:!1,enableVMWAudioMixer:!1,enableVVC:!0,enableMP4:!1,enableRawH264:!1,enableTopologyChange:!1,enableH264Multimon:!1,multimonRenderer:null,enableSubRectangleCache:!0,enableUint8Utf8:!1,retryConnectionInterval:-1,ignoredRawKeyCodes:[],fixANSIEquivalentKeys:!1,mapMetaToCtrlForKeys:[],mapMetaToCtrlForVScans:[],enableWindowsKey:!1,keyboardLayoutId:"en-US",sendRelativeMouseEvent:!1,disableVscanKeyboard:!0,disableTouch:!1},WMKS.widgetProto._updatePixelRatio=function(){this.options.useNativePixels?this._pixelRatio=window.devicePixelRatio||1:this._pixelRatio=1},WMKS.widgetProto._updateMobileFeature=function(e,t){this._touchHandler&&(e?this._touchHandler.initializeMobileFeature(t):this._touchHandler.removeMobileFeature(t))},WMKS.widgetProto._updateDisplayScale=function(e){this._displayScaleRatio=e,WMKS.LOGGER.debug("Display scale updated to "+this._displayScaleRatio)},WMKS.widgetProto._setOption=function(e,t){switch($.Widget.prototype._setOption.apply(this,arguments),e){case"fitToParent":this.rescaleOrResize(!1);break;case"fitGuest":this.rescaleOrResize(!0);break;case"displayScale":this._updateDisplayScale(t);break;case"useNativePixels":if(t&&!WMKS.UTIL.isHighResolutionSupported())return void WMKS.LOGGER.warn("Browser/device does not support this feature.");this._updatePixelRatio(),this.options.fitGuest?this.updateFitGuestSize(!0):this.rescaleOrResize(!1);break;case"allowMobileKeyboardInput":this._updateMobileFeature(t,WMKS.CONST.TOUCH.FEATURE.SoftKeyboard);break;case"allowMobileTrackpad":this._updateMobileFeature(t,WMKS.CONST.TOUCH.FEATURE.Trackpad);break;case"allowMobileExtendedKeypad":this._updateMobileFeature(t,WMKS.CONST.TOUCH.FEATURE.ExtendedKeypad);break;case"reverseScrollY":this.options.reverseScrollY=t;break;case"fixANSIEquivalentKeys":this._keyboardManager.fixANSIEquivalentKeys=t;break;case"VCDProxyHandshakeVmxPath":this.setVCDProxyHandshakeVmxPath(t);break;case"mapMetaToCtrlForKeys":this._keyboardManager.mapMetaToCtrlForKeys=t;break;case"mapMetaToCtrlForVScans":this._keyboardManager.setGuiToCtrlVScanMap(t);break;case"enableWindowsKey":this._keyboardManager.enableWindowsKey(t);break;case"keyboardLayoutId":this._keyboardManager.keyboardLayoutId=t,this._keyboardManager.UnicodeToVScanMap=WMKS.CONST.KB.VScanMap[t];break;case"ignoredRawKeyCodes":this._keyboardManager.setIgnoredRawKeyCodes(t);break;case"sendRelativeMouseEvent":this._vncDecoder.options.sendRelativeMouseEvent=t}},WMKS.widgetProto.getCanvasPosition=function(e,t){let i,s,n,o;if(isNaN(e)||isNaN(t))return{x:0,y:0};i=this._canvas.offset(),s=this._pixelRatio*this._displayScaleRatio/this._scale;let r=Math.ceil((e-i.left)*s),a=Math.ceil((t-i.top)*s);return n=Math.ceil(this._canvas[0].offsetWidth*this._scale*s)-1,o=Math.ceil(this._canvas[0].offsetHeight*this._scale*s)-1,r=Math.min(r,n),a=Math.min(a,o),{x:r=Math.max(r,0),y:a=Math.max(a,0)}},WMKS.widgetProto.getRelativeMouseCanvasPosition=function(e){let t,i,s;const n=e.x,o=e.y;return isNaN(n)||isNaN(o)?{x:0,y:0}:(t=this._canvas.offset(),i=this._canvas.parent().offset(),s=this._scale/this._pixelRatio,{x:Math.ceil(n*s+t.left),y:Math.ceil(o*s+t.top)})},WMKS.widgetProto.getEventPosition=function(e){let t,i;return e.pageX||e.pageY?(t=e.pageX,i=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),this.getCanvasPosition(t,i)},WMKS.widgetProto._isCanvasMouseEvent=function(e){const t=e||window.event,i=t.target||t.srcElement;return 0!==this._mouseDownBMask||(i===this._canvas[0]||this._video&&i===this._video[0]||i===$("#relativePadSurface"))},WMKS.widgetProto._onMouseButton=function(e,t){if(this._vncDecoder&&this._isCanvasMouseEvent(e)){const i=e||window.event,s=this.getEventPosition(i);let n;return i.which?WMKS.BROWSER.isMacOS()&&WMKS.BROWSER.isGecko()&&i.ctrlKey&&2===i.button?(WMKS.LOGGER.trace("FF on OSX: Rewrite Ctrl+Right-click as Ctrl+Left-click."),n=1):n=1<<i.button:n=(1&i.button)<<0|(2&i.button)<<1|(4&i.button)>>1,this.sendMouseButtonMessage(s,t,n,"Mouse")}},WMKS.widgetProto.sendMouseButtonMessage=function(e,t,i,s){return this._vncDecoder&&(t?this._mouseDownBMask|=i:this._mouseDownBMask&=~i,(this._mousePosGuest.x!==e.x||this._mousePosGuest.y!==e.y)&&this.sendMouseMoveMessage(e,s),this._vncDecoder.onMouseButton(e.x,e.y,t,i)),!0},WMKS.widgetProto.drawShadowCursor=function(){if(this._vncDecoder&&this._shadowCursorPos&&this._shadowCursorUrl){const e=this._pixelRatio*this._displayScaleRatio,t=this._shadowCursorPos.x/e*this._shadowCursorScale+this._shadowCursorX,i=this._shadowCursorPos.y/e*this._shadowCursorScale+this._shadowCursorY;null===this._shadowCursorIcon&&($('<div class="feedback-container cursor-icon-shadow"></div>').insertAfter(this.element),this._shadowCursorIcon=$(".cursor-icon-shadow"));const s="scale("+this._shadowCursorScale+","+this._shadowCursorScale+")";this._shadowCursorIcon.css({left:t,top:i,display:"block",transform:s}),this._shadowCursorIcon.html('<img src="'+this._shadowCursorUrl+'">')}},WMKS.widgetProto._isScrolling=!1,WMKS.widgetProto._onMouseWheel=function(e){if(this._vncDecoder&&this._isCanvasMouseEvent(e)){const t=e||window.event,i=this.getEventPosition(t),s=Math.max(Math.min(e.wheelDeltaX,1),-1);let n=Math.max(Math.min(e.wheelDeltaY,1),-1);if(this.options.reverseScrollY&&(n*=-1),/mac/i.test(navigator.platform)){if(this._isScrolling)return;this._isScrolling=!0;const e=this;setTimeout(function(){e._isScrolling=!1},200),this.sendScrollMessage(i,s,n)}else this.sendScrollMessage(i,s,n);return e.stopPropagation(),e.preventDefault(),!1}},WMKS.widgetProto.sendScrollMessage=function(e,t,i){this._vncDecoder&&this._vncDecoder.onMouseWheel(e.x,e.y,t,i)},WMKS.widgetProto._onMouseMove=function(e){if(this._vncDecoder&&this._isCanvasMouseEvent(e)){const t=e||window.event,i=this.getEventPosition(t);this.sendMouseMoveMessage(i,"Mouse")}return!0},WMKS.widgetProto.sendMouseMoveMessage=function(e,t){this._vncDecoder&&(this.hideShadowCursor(),this._vncDecoder.onMouseMove(e.x,e.y),this._mousePosGuest=e,this._touchHandler&&(this._touchHandler.onCaretPositionChanged(e),"Touch"!==t?this._touchHandler.setCursorVisibility(!1):this._touchHandler.setCursorVisibility(!0)))},WMKS.widgetProto.sendKeyMessage=function(e){const t=e.type,i=e.event;return i.originalEvent&&"function"!=typeof i.originalEvent.getModifierState&&(i.originalEvent.getModifierState=function(e){const t=this.originalEvent.modifierState;return!!t&&e in t&&t[e]}.bind(i)),i.preventDefault||(i.preventDefault=function(){}),i.stopPropagation||(i.stopPropagation=function(){}),"KeyDown"==t?(this.updateUserActivity(),this._keyboardManager.onKeyDown(i)):"KeyPress"==t?(this.updateUserActivity(),this._keyboardManager.onKeyPress(i)):"KeyUp"==t?(this.updateUserActivity(),this._keyboardManager.onKeyUp(i)):void 0},WMKS.widgetProto.onBlur=function(e){this._onBlur(e)},WMKS.widgetProto.onBlur=function(e){this._onBlur(e)},WMKS.widgetProto._onBlur=function(e){return this.connected&&(this._keyboardManager.cancelModifiers(),this._vncDecoder.onMouseButton(this._mousePosGuest.x,this._mousePosGuest.y,0,this._mouseDownBMask),this._mouseDownBMask=0),!0},WMKS.widgetProto.disconnectEvents=function(){this.element.unbind("contextmenu.wmks").unbind("keydown.wmks").unbind("keypress.wmks").unbind("keyup.wmks").unbind("mousedown.wmks").unbind("mousewheel.wmks"),this.element.unbind("mousemove.wmks").unbind("mouseup.wmks").unbind("blur.wmks"),$(window).unbind("blur.wmks"+this._wmksId),$(window).unbind("mousemove.wmks"+this._wmksId),$(window).unbind("mousewheel.wmks"+this._wmksId),$(window).unbind("mouseup.wmks"+this._wmksId),$(window).unbind("mousedown.wmks"+this._wmksId),this._touchHandler&&this._touchHandler.disconnectEvents()},WMKS.widgetProto.connectEvents=function(){const e=this;this.element.bind("blur.wmks",function(t){return e._onBlur(t)}),this._canvas.bind("focus.wmks",function(){e.hideShadowCursor()}).bind("blur.wmks",function(){e._shadowCursorIcon&&e._shadowCursorIcon.show()}),this.element.bind("contextmenu.wmks",function(e){return!1}).bind("keydown.wmks",function(t){return e.updateUserActivity(),e._keyboardManager.onKeyDown(t)}).bind("keypress.wmks",function(t){return e._keyboardManager.onKeyPress(t)}).bind("keyup.wmks",function(t){return e.updateUserActivity(),e._keyboardManager.onKeyUp(t)}),$(window).bind("blur.wmks"+this._wmksId,function(t){return e._onBlur(t)}).bind("mousemove.wmks"+this._wmksId,function(t){if(e.updateUserActivity(),e.hideShadowCursor(),!e.options.sendRelativeMouseEvent)return e._onMouseMove(t)}).bind("mousewheel.wmks"+this._wmksId,function(t){if(e.updateUserActivity(),!e.options.sendRelativeMouseEvent)return e._onMouseWheel(t)}).bind("mouseup.wmks"+this._wmksId,function(t){if(e.updateUserActivity(),!e.options.sendRelativeMouseEvent)return e._onMouseButton(t,0)}).bind("mousedown.wmks"+this._wmksId,function(t){if(e.updateUserActivity(),!e.options.sendRelativeMouseEvent)return e._onMouseButton(t,1)}),this._touchHandler&&this._touchHandler.installTouchHandlers(),this._relativeMouseHandler&&this._relativeMouseHandler.installMouseHandlers()},WMKS.widgetProto.hideShadowCursor=function(){this._shadowCursorIcon&&(this._shadowCursorIcon.hide(),this._shadowCursorPos=null)},WMKS.widgetProto.maxFitWidth=function(){return this.element[0].scrollWidth*this._pixelRatio},WMKS.widgetProto.maxFitHeight=function(){return this.element[0].scrollHeight*this._pixelRatio},WMKS.widgetProto.hideKeyboard=function(e){(e=e||{}).show=!1,this.toggleKeyboard(e)},WMKS.widgetProto.showKeyboard=function(e){(e=e||{}).show=!0,this.toggleKeyboard(e)},WMKS.widgetProto.toggleKeyboard=function(e){this.options.allowMobileKeyboardInput&&this._touchHandler&&this._touchHandler.toggleKeyboard(e)},WMKS.widgetProto.toggleTrackpad=function(e){this.options.allowMobileTrackpad&&this._touchHandler&&this._touchHandler.toggleTrackpad(e)},WMKS.widgetProto.toggleRelativePad=function(e){this._relativeMouseHandler&&this._relativeMouseHandler.toggleRelativePad(e)},WMKS.widgetProto.toggleExtendedKeypad=function(e){this.options.allowMobileExtendedKeypad&&this._touchHandler&&this._touchHandler.toggleExtendedKeypad(e)},WMKS.widgetProto.sendInputString=function(e){this._keyboardManager.processInputString(e,!0)},WMKS.widgetProto.sendKeyCodes=function(e,t,i){let s;const n=[];if(t&&this._keyboardManager.sendVScanKey){for(s=0;s<t.length;s++)this._keyboardManager.sendVScanKey(t[s],!0);for(s=0;s<t.length;s++)this._keyboardManager.sendVScanKey(t[s],!1)}else{for(s=0;s<e.length;s++){const t=e[s];t>0?(this._keyboardManager.sendKey(t,!1,!1,i),(20!==t||WMKS.BROWSER.isMacOS())&&n.push(t)):t<0&&this._keyboardManager.sendKey(0-t,!0,!0,i)}for(s=n.length-1;s>=0;s--)this._keyboardManager.sendKey(n[s],!0,!1,i)}},WMKS.widgetProto.rescale=function(){this.rescaleOrResize(!0)},WMKS.widgetProto.updateFitGuestSize=function(e){let t=this.element.width()*this._pixelRatio*this._displayScaleRatio,i=this.element.height()*this._pixelRatio*this._displayScaleRatio;if(this.options.fitGuest&&(!e||this._guestWidth!==t||this._guestWidth!==i)){if(this._resolutionHandler){const e=this._resolutionHandler(t,i);t=e[0],i=e[1]}this._vncDecoder.onRequestResolution(t,i)}},WMKS.widgetProto.updateTopology=function(e,t){let i;if(this.options.fitGuest){if(!t)for(i=0;i<e.length;i++)e[i].left=e[i].left*this._pixelRatio,e[i].top=e[i].top*this._pixelRatio,e[i].requestedWidth=e[i].requestedWidth*this._pixelRatio,e[i].requestedHeight=e[i].requestedHeight*this._pixelRatio;this._vncDecoder.onRequestTopology(e)}},WMKS.widgetProto.setAudioStreamEnabled=function(e){this._vncDecoder&&this._vncDecoder.setAudioStreamEnabled(e)},WMKS.widgetProto.setVideoStreamEnabled=function(e){this._vncDecoder&&this._vncDecoder.setVideoStreamEnabled(e)},WMKS.widgetProto.rescaleOrResize=function(e){let t=1,i=0,s=0;const n=this.element.width(),o=this.element.height();this._canvas.css({width:this._guestWidth/(this._pixelRatio*this._displayScaleRatio),height:this._guestHeight/(this._pixelRatio*this._displayScaleRatio)}),this._video&&this._video.css({width:this._guestWidth/(this._pixelRatio*this._displayScaleRatio),height:this._guestHeight/(this._pixelRatio*this._displayScaleRatio)});const r=this._canvas[0].offsetWidth,a=this._canvas[0].offsetHeight;if(WMKS.LOGGER.debug("Resize canvas, offsetwidth is : "+r+",offsetHeight is : "+a),null===this.transform||this.options.fitToParent||this.options.fitGuest)if(null!==this.transform&&this.options.fitToParent){const e=n/r,c=o/a;i=(n-r)/2,s=(o-a)/2,t=Math.max(.1,Math.min(e,c)),!1===this.options.isFitToViewer&&this.options.isShadow&&(t=1,i=i<0?0:i,s=s<0?0:s),this._shadowCursorX=(n-r*t)/2,this._shadowCursorY=(o-a*t)/2,n-r*t<0&&(this._shadowCursorX=0),o-a*t<0&&(this._shadowCursorY=0),this._shadowCursorScale=t}else this.options.fitGuest&&e?this.updateFitGuestSize(!0):null===this.transform&&WMKS.LOGGER.warn("No scaling support");null!==this.transform&&(t!==this._scale&&(this._scale=t,this._canvas.css(this.transform,"scale("+this._scale+")"),this._video&&this._video.css(this.transform,"scale("+this._scale+")")),i===this._x&&s===this._y||(this._x=i,this._y=s,WMKS.LOGGER.debug("Resize canvas, top  is : "+s+",left is : "+i),this._canvas.css({top:s,left:i}),this._video&&this._video.css({top:s,left:i})),this._handleIEScrollBar())},WMKS.widgetProto._handleIEScrollBar=function(){WMKS.BROWSER.isIE()&&!0===this.options.isFitToViewer&&this.options.isShadow&&this._scale<1?this.element.css({overflow:"hidden"}):this.element.css({overflow:""})},WMKS.widgetProto.setVCDProxyHandshakeVmxPath=function(e){this.options.VCDProxyHandshakeVmxPath=e,this._vncDecoder&&this._vncDecoder.options&&(this._vncDecoder.options.VCDProxyHandshakeVmxPath=e)},WMKS.widgetProto.disconnect=function(){this._vncDecoder.disconnect(),this.disconnectEvents(),this._keyboardManager.cancelModifiers(),this.hideShadowCursor()},WMKS.widgetProto.connect=function(e){this.disconnect(),this._vncDecoder.connect(e),this.connectEvents()},WMKS.widgetProto.destroy=function(){this.disconnect(),this.element.removeClass("wmks"),!this._touchHandler||(this._touchHandler.destroy(),this._touchHandler=null),this._relativeMouseHandler.destroy(),this._relativeMouseHandler=null,this._canvas.remove(),this._video&&this._video.remove(),this._backCanvas&&this._backCanvas.remove(),this._blitTempCanvas&&this._blitTempCanvas.remove(),$.Widget.prototype.destroy.call(this)},WMKS.widgetProto.requestElementReposition=function(e,t){if(this._touchHandler){if(t)return void this._touchHandler.addToRepositionQueue(e);this._touchHandler.widgetRepositionOnRotation(e)}},WMKS.widgetProto.updateUserActivity=function(){this._trigger("useractivity",0,$.now())},WMKS.widgetProto.id=1,WMKS.widgetProto._create=function(){const e=this;this._mouseDownBMask=0,this._mousePosGuest={x:0,y:0},this._scale=1,this._pixelRatio=1,this.connected=!1,this.isCanvasActive=!1,this._displayScaleRatio=1,this._wmksId=WMKS.widgetProto.id++,this._shadowCursorIcon=null,this._shadowCursorScale=1,this._shadowCursorX=0,this._shadowCursorY=0,this._shadowCursorPos=null,this._shadowCursorUrl=null,this._canvas=WMKS.UTIL.createCanvas(!0).prop({id:"mainCanvas",tabindex:1}),this._backCanvas=WMKS.UTIL.createCanvas(!0),this._blitTempCanvas=WMKS.UTIL.createCanvas(!0),this.element.addClass("wmks").append(this._canvas),this.options.enableMP4&&(this._video=WMKS.UTIL.createVideo(!0),this.element.append(this._video));const t=function(t){return void 0!==e._canvas[0].style[t]?t:null};this.transform=t("transform")||t("WebkitTransform")||t("MozTransform")||t("msTransform")||t("OTransform"),this._vncDecoder=new WMKS.VNCDecoder({useVNCHandshake:this.options.useVNCHandshake,VCDProxyHandshakeVmxPath:this.options.VCDProxyHandshakeVmxPath,useUnicodeKeyboardInput:this.options.useUnicodeKeyboardInput,enableVorbisAudioClips:this.options.enableVorbisAudioClips,enableOpusAudioClips:this.options.enableOpusAudioClips,enableAacAudioClips:this.options.enableAacAudioClips,enableVVC:this.options.enableVVC,enableUint8Utf8:this.options.enableUint8Utf8,enableVMWSessionClose:this.options.enableVMWSessionClose,enableVMWAudioMixer:this.options.enableVMWAudioMixer,retryConnectionInterval:this.options.retryConnectionInterval,sendRelativeMouseEvent:this.options.sendRelativeMouseEvent,canvas:this._canvas[0],backCanvas:this._backCanvas[0],blitTempCanvas:this._blitTempCanvas[0],mediaPlayer:this.options.enableMP4?this._video[0]:null,enableRawH264:this.options.enableRawH264,enableTopologyChange:this.options.enableTopologyChange,multimonRenderer:this.options.multimonRenderer,enableH264Multimon:this.options.enableH264Multimon,enableSubRectangleCache:this.options.enableSubRectangleCache,cursorHandler:this.options.cursorHandler,getShadowCursorScale:function(){return e._shadowCursorScale},onConnecting:function(t,i){e._trigger("connecting",0,{vvc:t,vvcSession:i})},onConnected:function(){e.connected=!0,e._trigger("connected"),e._keyboardManager.clearState(),e.rescaleOrResize(!0)},onCursorUrlChanged:function(t){e._shadowCursorUrl=t,e.drawShadowCursor()},onCursorPositionChanged:function(t){e._shadowCursorPos=t,e.drawShadowCursor()},onBeforeDisconnected:function(t){e._trigger("beforedisconnected",0,t)},onDisconnected:function(t,i){e.connected=!1,e._trigger("disconnected",0,{reason:t,code:i})},onAuthenticationFailed:function(){e._trigger("authenticationFailed")},onError:function(t){e._trigger("error",0,t)},onProtocolError:function(){e._trigger("protocolError")},onNewDesktopSize:function(t,i){e._guestWidth=t,e._guestHeight=i;const s={width:t,height:i},n={width:t/e._pixelRatio,height:i/e._pixelRatio};e._canvas.attr(s).css(n),s.y=i,e._backCanvas.attr(s).css(n),e._blitTempCanvas.attr(s).css(n),e._video&&e._video.attr(s).css(n),e._trigger("resolutionchanged",null,s),e.rescaleOrResize(!1)},onEncodingChanged:function(t){"TightPNG"!==t||e.isCanvasActive?"MP4"===t&&e.isCanvasActive?(WMKS.LOGGER.info("Activate video element since we use MP4 encoding."),e._video?(e.isCanvasActive=!1,e._canvas.hide(),e._video.show()):WMKS.LOGGER.error("Video element doesn't exist.")):"RawH264"===t&&e.isCanvasActive&&WMKS.LOGGER.info("Activate video element since we use raw H264 encoding."):(WMKS.LOGGER.info("Activate canvas element since we use TightPNG encoding."),e.isCanvasActive=!0,e._video&&e._video.hide(),e._canvas.show())},onKeyboardLEDsChanged:function(t){e._keyboardManager.onKeyboardLEDsChanged&&e._keyboardManager.onKeyboardLEDsChanged(t),e._trigger("keyboardLEDsChanged",0,t)},onCursorStateChanged:function(t){e._touchHandler&&e._touchHandler.setCursorVisibility(t)},onHeartbeat:function(t){e._trigger("heartbeat",0,t)},onUpdateCopyPasteUI:function(t,i){const s={noCopyUI:t,noPasteUI:i};e._trigger("updateCopyPasteUI",0,s)},onMultimonCapacityUpdated:function(t){e._trigger("updateMultimonCapacityUI",0,t)},onCopy:function(t){return"string"!=typeof t?(WMKS.LOGGER.debug("data format is not string, ignore."),!1):(e._trigger("copy",0,t),!0)},onSetReconnectToken:function(t){e._trigger("reconnecttoken",0,t)},onAudio:function(t){e._trigger("audio",0,[t])},onAudioMixer:function(t){e._trigger("audiomixer",0,t)}}),KeyboardEvent.prototype.hasOwnProperty("code")&&KeyboardEvent.prototype.hasOwnProperty("getModifierState")&&!WMKS.BROWSER.isMobileTouchDevice()&&!this.options.disableVscanKeyboard?this._keyboardManager=new WMKS.KeyboardManager2({vncDecoder:this._vncDecoder,mapMetaToCtrlForVScans:this.options.mapMetaToCtrlForVScans,enableWindowsKey:this.options.enableWindowsKey}):this._keyboardManager=new WMKS.KeyboardManager({vncDecoder:this._vncDecoder,ignoredRawKeyCodes:this.options.ignoredRawKeyCodes,fixANSIEquivalentKeys:this.options.fixANSIEquivalentKeys,mapMetaToCtrlForKeys:this.options.mapMetaToCtrlForKeys,enableWindowsKey:this.options.enableWindowsKey,keyboardLayoutId:this.options.keyboardLayoutId});const i=this._video?this._video:this._canvas;this.options.disableTouch||(this._touchHandler=new WMKS.TouchHandler({widgetProto:this,canvas:i,keyboardManager:this._keyboardManager,onToggle:function(t){e._trigger("toggle",0,t)}})),this._relativeMouseHandler=new WMKS.RelativeMouseHandler({widgetProto:this,canvas:this._canvas,keyboardManager:this._keyboardManager,onToggle:function(t){e._trigger("toggle",0,t),e._setOption("sendRelativeMouseEvent",t[1]),e._relativeMouseHandler.setCursorVisibility(t[1])}}),this._resolutionHandler=this.options.resolutionHandler,this._updatePixelRatio(),this.updateFitGuestSize(),this._relativeMouseHandler.initializeRelativeMouseFeature(),this._updateMobileFeature(this.options.allowMobileKeyboardInput,WMKS.CONST.TOUCH.FEATURE.SoftKeyboard),this._updateMobileFeature(this.options.allowMobileTrackpad,WMKS.CONST.TOUCH.FEATURE.Trackpad),this._updateMobileFeature(this.options.allowMobileExtendedKeypad,WMKS.CONST.TOUCH.FEATURE.ExtendedKeypad)},WMKS.dialogManager=function(){this.dialog=null,this.visible=!1,this.lastToggleTime=0,this.options={name:"DIALOG_MGR",toggleCallback:function(e,t){},minToggleTime:50}},WMKS.dialogManager.prototype.setOption=function(e,t){return this.options[e]=t,this},WMKS.dialogManager.prototype.setOptions=function(e){let t;for(t in e)this.setOption(t,e[t]);return this},WMKS.dialogManager.prototype.initialize=function(e){this.options=$.extend({},this.options,e),this.dialog=this.create(),this.init()},WMKS.dialogManager.prototype.destroy=function(){!this.dialog||(this.disconnect(),this.remove())},WMKS.dialogManager.prototype.create=function(){return null},WMKS.dialogManager.prototype.init=function(){},WMKS.dialogManager.prototype.disconnect=function(){},WMKS.dialogManager.prototype.remove=function(){const e=this.dialog;!e||e.dialog("destroy").remove()},WMKS.dialogManager.prototype.toggle=function(e){const t=this.dialog,i=!this.visible;let s;t&&(!e||this.setOptions(e),i!==(s=t.dialog("isOpen"))&&($.now()-this.lastToggleTime<this.options.minToggleTime||(s?this.close():this.open())))},WMKS.dialogManager.prototype.sendUpdatedState=function(e){this.visible=e,this.lastToggleTime=$.now(),$.isFunction(this.options.toggleCallback)&&this.options.toggleCallback.call(this,[this.options.name,e])},WMKS.dialogManager.prototype.open=function(){!this.dialog||(this.visible=!this.visible,this.dialog.dialog("open"),this.sendUpdatedState(!0))},WMKS.dialogManager.prototype.close=function(){!this.dialog||(this.visible=!this.visible,this.dialog.dialog("close"),this.sendUpdatedState(!1))},WMKS.extendedKeypad=function(e){if(!e||!e.widget||!e.keyboardManager)return null;WMKS.dialogManager.call(this),this._widget=e.widget,this._kbManager=e.keyboardManager,this._parentElement=e.parentElement,this.manualModifiers=[],$.extend(this.options,{name:"EXTENDED_KEYPAD"}),WMKS.LOGGER.warn("Key pad : "+this.options.name)},WMKS.extendedKeypad.prototype=new WMKS.dialogManager,WMKS.extendedKeypad.prototype.create=function(){const e=this,t=$('<div id="ctrlPanePopup"></div>');return t.append(this.getControlPaneHtml()),t.dialog({autoOpen:!1,closeOnEscape:!0,resizable:!1,position:{my:"center",at:"center",of:this._parentElement},zIndex:1e3,dialogClass:"ctrl-pane-wrapper",close:function(i){return e._kbManager.cancelModifiers(!0),t.find(".ab-modifier-key.ab-modifier-key-down").removeClass("ab-modifier-key-down"),e.toggleFunctionKeys(!1),e.sendUpdatedState(!1),!0},dragStop:function(t){e.positionFunctionKeys()}}),t},WMKS.extendedKeypad.prototype.init=function(){const e=this,t=this.dialog,i=function(t){const i=parseInt($(this).attr("abkeycode"),10);return e._kbManager.handleSoftKb(i,!1),!1};t.find(".ab-modifier-key").on("touchstart",function(t){const i=$(this).hasClass("ab-modifier-key-down"),s=parseInt($(this).attr("abkeycode"),10);return isNaN(s)?(WMKS.LOGGER.debug("Got NaN as modifier key. Skipping it."),!1):($(this).toggleClass("ab-modifier-key-down"),e._kbManager.updateModifiers(s,i),!1)}),t.find("#fnMasterKey").off("touchstart").on("touchstart",function(t){return e.toggleFunctionKeys(),!1}),t.find(".ab-extended-key").off("touchstart").on("touchstart",i),t.find(".ab-flip").off("touchstart").on("touchstart",function(){return $(this).parents(".flip-container").toggleClass("perform-flip"),e.toggleFunctionKeys(!1),!1}),t.parent().prop("id","ctrlPaneWidget"),t.parent().parent().append(this.getFunctionKeyHtml()),$("#fnKeyPad").find(".ab-extended-key").off("touchstart").on("touchstart",i),t.parent().off("orientationchange.ctrlpane").on("orientationchange.ctrlpane",function(){e._widget.requestElementReposition($(this)),e.positionFunctionKeys()})},WMKS.dialogManager.prototype.disconnect=function(){const e=this.dialog;e.find("#fnMasterKey").off("touchstart"),e.find(".ab-extended-key").off("touchstart"),e.find(".ab-flip").off("touchstart"),e.parent().off("orientationchange.ctrlpane"),$("#fnKeyPad").find(".ab-extended-key").off("touchstart")},WMKS.extendedKeypad.prototype.getControlPaneHtml=function(){return'<div class="ctrl-pane flip-container">            <div class="flipper">               <div class="back">                  <div class="ctrl-key-top-row ab-extended-key baseKey" abkeycode="36"><div>Home</div></div>                  <div class="ctrl-key-top-row ab-extended-key baseKey" abkeycode="38">                     <img class="touch-sprite up-arrow"/></div>                  <div class="ctrl-key-top-row ab-extended-key baseKey" abkeycode="35"><div>End</div></div>                  <div class="ctrl-key-top-row ab-extended-key baseKey" abkeycode="27"><div>Esc</div></div>                  <div class="ctrl-key-bottom-row ab-extended-key baseKey" abkeycode="37">                     <img class="touch-sprite left-arrow"/></div>                  <div class="ctrl-key-bottom-row ab-extended-key baseKey" abkeycode="40">                     <img class="touch-sprite down-arrow"/></div>                  <div class="ctrl-key-bottom-row ab-extended-key baseKey" abkeycode="39">                     <img class="touch-sprite right-arrow"/></div>                  <div class="ctrl-key-bottom-row ab-flip baseKey">                     <img class="touch-sprite more-keys"/></div>               </div>               <div class="front">                  <div class="ctrl-key-top-row ab-modifier-key baseKey" abkeycode="16"><div>Shift</div></div>                  <div class="ctrl-key-top-row ab-extended-key baseKey" abkeycode="46"><div>Del</div></div>                  <div class="ctrl-key-top-row ab-extended-key baseKey" abkeycode="33"><div>PgUp</div></div>                  <div id="fnMasterKey" class="ctrl-key-top-row baseKey">                     <div style="letter-spacing: -1px">F1-12</div></div>                  <div class="ctrl-key-bottom-row ab-modifier-key baseKey" abkeycode="17"><div>Ctrl</div></div>                  <div class="ctrl-key-bottom-row ab-modifier-key baseKey" abkeycode="18"><div>Alt</div></div>                  <div class="ctrl-key-bottom-row ab-extended-key baseKey" abkeycode="34"><div>PgDn</div></div>                  <div class="ctrl-key-bottom-row ab-flip baseKey">                     <img class="touch-sprite more-keys"/></div>               </div>            </div>         </div>'},WMKS.extendedKeypad.prototype.getFunctionKeyHtml=function(){return'<div class="fnKey-pane-wrapper hide" id="fnKeyPad">             <div class="ctrl-pane">                <div class="key-group up-position">                  <div class="border-key-top-left">                     <div class="fn-key-top-row ab-extended-key baseKey" abkeycode="112"><div>F1</div></div>                  </div>                  <div class="fn-key-top-row ab-extended-key baseKey" abkeycode="113"><div>F2</div></div>                  <div class="fn-key-top-row ab-extended-key baseKey" abkeycode="114"><div>F3</div></div>                  <div class="fn-key-top-row ab-extended-key baseKey" abkeycode="115"><div>F4</div></div>                  <div class="fn-key-top-row ab-extended-key baseKey" abkeycode="116"><div>F5</div></div>                  <div class="border-key-top-right">                     <div class="fn-key-top-row ab-extended-key baseKey" abkeycode="117"><div>F6</div></div>                  </div>                  <div class="border-key-bottom-left">                     <div class="fn-key-bottom-row ab-extended-key baseKey" abkeycode="118"><div>F7</div></div>                  </div>                  <div class="fn-key-bottom-row ab-extended-key baseKey" abkeycode="119"><div>F8</div></div>                  <div class="fn-key-bottom-row ab-extended-key baseKey" abkeycode="120"><div>F9</div></div>                  <div class="fn-key-bottom-row ab-extended-key baseKey" abkeycode="121"><div>F10</div></div>                  <div class="fn-key-bottom-row ab-extended-key baseKey" abkeycode="122"><div>F11</div></div>                  <div class="border-key-bottom-right">                     <div class="fn-key-bottom-row ab-extended-key baseKey" abkeycode="123"><div>F12</div></div>                  </div>               </div>            </div>            <div class="fnKey-inner-border-helper" id="fnKeyInnerBorder"></div>         </div>'},WMKS.extendedKeypad.prototype.toggleCtrlPane=function(){const e=this.dialog;e.dialog("isOpen")?e.dialog("close"):e.dialog("open")},WMKS.extendedKeypad.prototype.toggleFunctionKeys=function(e){const t=$("#fnKeyPad"),i=e||void 0===e&&!t.is(":visible");t.toggle(i),$("#fnMasterKey").toggleClass("ab-modifier-key-down",i),this.positionFunctionKeys()},WMKS.extendedKeypad.prototype.positionFunctionKeys=function(){const e=$("#fnKeyPad"),t=$("#ctrlPaneWidget");if(e.is(":visible")){e.position({my:"right bottom",at:"right top",of:t,collision:"flip"}),$("#fnKeyInnerBorder").height(e.height()-2).width(e.width()-2);const i=e.offset().top+e.height()<=t.offset().top+t.height();let s;this.adjustFunctionKeyStyle(i),i?(s=parseInt(t.css("z-index"),10)-1,$("#fnKeyInnerBorder").css("border-color","#d5d5d5")):(s=parseInt($("#ctrlPaneWidget").css("z-index"),10)+1,$("#fnKeyInnerBorder").css("border-color","#aaa")),e.css("z-index",s.toString())}return!0},WMKS.extendedKeypad.prototype.adjustFunctionKeyStyle=function(e){const t=$("#fnKeyPad"),i=t.find(".key-group");e?i.hasClass("down-position")&&(i.removeClass("down-position"),i.addClass("up-position"),t.removeClass("fnKey-pane-wrapper-down"),t.addClass("fnKey-pane-wrapper")):i.hasClass("up-position")&&(i.removeClass("up-position"),i.addClass("down-position"),t.removeClass("fnKey-pane-wrapper"),t.addClass("fnKey-pane-wrapper-down"))},WMKS.CONST.TRACKPAD={STATE:{idle:0,tap:1,tap_2finger:2,drag:3,scroll:4}},WMKS.trackpadManager=function(e,t){WMKS.dialogManager.call(this),this._widget=e,this._canvas=t,this._cursorPosGuest={x:0,y:0},this._dragTimer=null,this._dragStartedByLongTap=!1,this.state=WMKS.CONST.TRACKPAD.STATE.idle,this.history=[],$.extend(this.options,{name:"TRACKPAD",speedControlMinMovePx:5,accelerator:10,minSpeed:1,maxSpeed:10}),WMKS.LOGGER.warn("trackpad : "+this.options.name)},WMKS.trackpadManager.prototype=new WMKS.dialogManager,WMKS.trackpadManager.prototype.getTrackpadHtml=function(){return'<div id="trackpad" class="trackpad-container">                   <div class="left-border"></div>                   <div id="trackpadSurface" class="touch-area"></div>                   <div class="right-border"></div>                   <div class="bottom-border">                      <div class="button-container">                         <div id="trackpadLeft" class="button-left"></div>                         <div id="trackpadRight" class="button-right"></div>                      </div>                   </div>               </div>'},WMKS.trackpadManager.prototype.create=function(){let e;const t=this;return this._widget&&this._canvas?((e=$(this.getTrackpadHtml())).dialog({autoOpen:!1,closeOnEscape:!0,resizable:!1,position:{my:"center",at:"center",of:this._canvas},zIndex:1e3,draggable:!0,dialogClass:"trackpad-wrapper",close:function(e){t.sendUpdatedState(!1)},create:function(e){t.layout($(this).parent())}}),e):(WMKS.LOGGER.debug("Trackpad dialog creation has been aborted. Widget or Canvas is not ready."),null)},WMKS.trackpadManager.prototype.init=function(){const e=this.dialog,t=this;let i,s,n;e?(this._widget.requestElementReposition(e.parent(),!0),i=e.find("#trackpadSurface").on("touchstart",function(e){return t.trackpadTouchStart(e.originalEvent)}).on("touchmove",function(e){return t.trackpadTouchMove(e.originalEvent)}).on("touchend",function(e){return t.trackpadTouchEnd(e.originalEvent)}),s=e.find("#trackpadLeft").on("touchstart",function(e){return t.trackpadClickStart(e,WMKS.CONST.CLICK.left)}).on("touchend",function(e){return t.trackpadClickEnd(e,WMKS.CONST.CLICK.left)}),n=e.find("#trackpadRight").on("touchstart",function(e){return t.trackpadClickStart(e,WMKS.CONST.CLICK.right)}).on("touchend",function(e){return t.trackpadClickEnd(e,WMKS.CONST.CLICK.right)})):WMKS.LOGGER.debug("Trackpad init aborted. Dialog is not created successfully.")},WMKS.trackpadManager.prototype.disconnect=function(){const e=this.dialog;let t,i,s;e&&(t=e.find("#trackpadSurface").off("touchmove").off("touchstart").off("touchend"),i=e.find("#trackpadLeft").off("touchstart").off("touchend"),s=e.find("#trackpadRight").off("touchstart").off("touchend"))},WMKS.trackpadManager.prototype.layout=function(e){const t=this._canvas;let i,s;e&&t&&(i=e.parent())!==(s=t.parent())&&s.append(e)},WMKS.trackpadManager.prototype.trackpadClickStart=function(e,t){return t!==WMKS.CONST.CLICK.left&&t!==WMKS.CONST.CLICK.right?(WMKS.LOGGER.debug("assert: unknown button "+t),!1):($(e.target).addClass("button-highlight"),this._widget.sendMouseButtonMessage(this.getMousePosition(),!0,t),!1)},WMKS.trackpadManager.prototype.trackpadClickEnd=function(e,t){return t!==WMKS.CONST.CLICK.left&&t!==WMKS.CONST.CLICK.right?(WMKS.LOGGER.debug("assert: unknown button "+t),!1):($(e.target).removeClass("button-highlight"),this._widget.sendMouseButtonMessage(this.getMousePosition(),!1,t),!1)},WMKS.trackpadManager.prototype.computeMovingDistance=function(e,t){let i,s,n,o;return i=this.getTrackpadSpeed(e,this.history[0].x,this.history[1].x,this.history[2].x),s=this.getTrackpadSpeed(t,this.history[0].y,this.history[1].y,this.history[2].y),(o=(n=WMKS.UTIL.getLineLength(i,s))*this.options.accelerator)>this.options.maxSpeed?o=this.options.maxSpeed:o<this.options.minSpeed&&(o=this.options.minSpeed),[i*o,s*o]},WMKS.trackpadManager.prototype.getTrackpadSpeed=function(e,t,i,s){return.3*e+.1*t-.1*i-.3*s},WMKS.trackpadManager.prototype.trackpadTouchStart=function(e){const t=this;return e.targetTouches.length>2?this.state===WMKS.CONST.TRACKPAD.STATE.scroll?WMKS.LOGGER.debug("Ignore new touchstart, currently scrolling, touch#: "+e.targetTouches.length):(WMKS.LOGGER.debug("Aborting touch, too many fingers #: "+e.targetTouches.length),this.resetTrackpadState()):2===e.targetTouches.length?this.state=WMKS.CONST.TRACKPAD.STATE.tap_2finger:(this.state=WMKS.CONST.TRACKPAD.STATE.tap,null!==this._dragTimer&&(clearTimeout(this._dragTimer),this._dragTimer=null),this._dragTimer=setTimeout(function(){t._dragTimer=null,t._widget.sendMouseButtonMessage(t.getMousePosition(),!0,WMKS.CONST.CLICK.left),t._dragStartedByLongTap=!0},WMKS.CONST.TOUCH.leftDragDelayMs)),!1},WMKS.trackpadManager.prototype.trackpadTouchMove=function(e){let t,i,s;const n=$(e.target),o=this._widget;return null!==this._dragTimer&&(clearTimeout(this._dragTimer),this._dragTimer=null),this.state!==WMKS.CONST.TRACKPAD.STATE.idle&&(t=e.targetTouches[0].pageX,(i=e.targetTouches[0].pageY)<n.offset().top||i>n.offset().top+n.height()||t<n.offset().left||t>n.offset().left+n.width()?(this.state===WMKS.CONST.TRACKPAD.STATE.drag&&(this._dragStartedByLongTap&&o.sendMouseButtonMessage(this.getMousePosition(),!1,WMKS.CONST.CLICK.left),this.state=WMKS.CONST.TRACKPAD.STATE.tap,this.history.length=0),!1):(this.state===WMKS.CONST.TRACKPAD.STATE.drag?(s=this.computeNewCursorLocation(t,i),!o._touchHandler||o._touchHandler.moveCursor(s.x,s.y),o.sendMouseMoveMessage(s),this.history.shift(),this.history.push({x:t,y:i})):this.state===WMKS.CONST.TRACKPAD.STATE.scroll&&this.sendScrollMessageFromTrackpad(e.targetTouches[0]),this.state===WMKS.CONST.TRACKPAD.STATE.tap?(this.state=WMKS.CONST.TRACKPAD.STATE.drag,this.history.push({x:t,y:i},{x:t,y:i},{x:t,y:i})):this.state===WMKS.CONST.TRACKPAD.STATE.tap_2finger&&2===e.targetTouches.length&&(this.state=WMKS.CONST.TRACKPAD.STATE.scroll,this.history[0]={x:t,y:i}),!1))},WMKS.trackpadManager.prototype.computeNewCursorLocation=function(e,t){let i;const s=this.getMousePosition();return i=WMKS.UTIL.getLineLength(e-this.history[2].x,t-this.history[2].y),isNaN(i)||0===i?s:(i<this.options.speedControlMinMovePx?(s.x+=e-this.history[2].x,s.y+=t-this.history[2].y):(i=this.computeMovingDistance(e,t),s.x+=Math.floor(i[0]),s.y+=Math.floor(i[1])),this._widget.getCanvasPosition(s.x,s.y))},WMKS.trackpadManager.prototype.trackpadTouchEnd=function(e){let t;return null!==this._dragTimer&&(clearTimeout(this._dragTimer),this._dragTimer=null),0===e.targetTouches.length&&this.state!==WMKS.CONST.TRACKPAD.STATE.idle&&(t=this.getMousePosition(),this.state===WMKS.CONST.TRACKPAD.STATE.tap?(this._widget.sendMouseButtonMessage(t,!0,WMKS.CONST.CLICK.left),this._widget.sendMouseButtonMessage(t,!1,WMKS.CONST.CLICK.left)):this.state===WMKS.CONST.TRACKPAD.STATE.tap_2finger?(this._widget.sendMouseButtonMessage(t,!0,WMKS.CONST.CLICK.right),this._widget.sendMouseButtonMessage(t,!1,WMKS.CONST.CLICK.right)):this.state===WMKS.CONST.TRACKPAD.STATE.drag&&this._dragStartedByLongTap&&this._widget.sendMouseButtonMessage(t,!1,WMKS.CONST.CLICK.left),this.resetTrackpadState(),!1)},WMKS.trackpadManager.prototype.resetTrackpadState=function(){this.state=WMKS.CONST.TRACKPAD.STATE.idle,this.history.length=0,this._dragStartedByLongTap=!1},WMKS.trackpadManager.prototype.sendScrollMessageFromTrackpad=function(e){let t,i,s,n=0,o=0;t=e.pageX-this.history[0].x,i=e.pageY-this.history[0].y,!this._widget._touchHandler||(n=(s=this._widget._touchHandler._calculateMouseWheelDeltas(t,i)).wheelDeltaX,o=s.wheelDeltaY),0===n&&0===o||(this._widget.sendScrollMessage(this.getMousePosition(),n,o),0!==n&&(this.history[0].x=e.pageX),0!==o&&(this.history[0].y=e.pageY))},WMKS.trackpadManager.prototype.getMousePosition=function(){let e=this._widget._mousePosGuest;return 0===e.x&&0===e.y?this._cursorPosGuest.x===e.x&&this._cursorPosGuest.y===e.y||(e=this._cursorPosGuest,this._widget.sendMouseMoveMessage(e)):this._cursorPosGuest=e,e},WMKS.Packet=function(e,t,i){this.length=t,this._buffer=e,this._readPosition=0,this._byteOrder=i||WMKS.Packet.BYTE_ORDER.NETWORK_ORDER,this._byteOrder==WMKS.Packet.BYTE_ORDER.LITTLE_ENDIAN?(this.setInt16=this.setInt16le,this.setInt32=this.setInt32le,this.setUint16=this.setUint16le,this.setUint32=this.setUint32le,this.getInt16=this.getInt16le,this.getInt32=this.getInt32le,this.getUint16=this.getUint16le,this.getUint32=this.getUint32le):this._byteOrder==WMKS.Packet.BYTE_ORDER.BIG_ENDIAN&&(this.setInt16=this.setInt16be,this.setInt32=this.setInt32be,this.setUint16=this.setUint16be,this.setUint32=this.setUint32be,this.getInt16=this.getInt16be,this.getInt32=this.getInt32be,this.getUint16=this.getUint16be,this.getUint32=this.getUint32be)},WMKS.Packet.BYTE_ORDER={LITTLE_ENDIAN:1,BIG_ENDIAN:2,NETWORK_ORDER:2},WMKS.Packet.createNewPacket=function(e,t){return e=e||512,new WMKS.Packet(new Uint8Array(e),0,t)},WMKS.Packet.createFromBuffer=function(e,t){if(e instanceof ArrayBuffer)e=new Uint8Array(e);else if(!(e instanceof Uint8Array))return null;return new WMKS.Packet(e,e.length,t)},WMKS.Packet.createNewPacketBE=function(e){return WMKS.Packet.createNewPacket(e,WMKS.Packet.BYTE_ORDER.BIG_ENDIAN)},WMKS.Packet.createNewPacketLE=function(e){return WMKS.Packet.createNewPacket(e,WMKS.Packet.BYTE_ORDER.LITTLE_ENDIAN)},WMKS.Packet.createFromBufferBE=function(e){return WMKS.Packet.createFromBuffer(e,WMKS.Packet.BYTE_ORDER.BIG_ENDIAN)},WMKS.Packet.createFromBufferLE=function(e){return WMKS.Packet.createFromBuffer(e,WMKS.Packet.BYTE_ORDER.LITTLE_ENDIAN)},WMKS.Packet.prototype.reset=function(){this.length=0,this._readPosition=0},WMKS.Packet.prototype.getData=function(){return this._buffer.subarray(0,this.length)},WMKS.Packet.prototype.bytesRemaining=function(){return this.length-this._readPosition},WMKS.Packet.prototype.getDataAsArrayBuffer=function(){return this._buffer.buffer.slice(this._buffer.byteOffset,this._buffer.byteOffset+this.length)},WMKS.Packet.prototype.writeUint8=function(e){this._ensureWriteableBytes(1),this.setUint8(this.length,e),this.length+=1},WMKS.Packet.prototype.writeUint16=function(e){this._ensureWriteableBytes(2),this.setUint16(this.length,e),this.length+=2},WMKS.Packet.prototype.writeUint32=function(e){this._ensureWriteableBytes(4),this.setUint32(this.length,e),this.length+=4},WMKS.Packet.prototype.writeInt8=function(e){this._ensureWriteableBytes(1),this.setInt8(this.length,e),this.length+=1},WMKS.Packet.prototype.writeInt16=function(e){this._ensureWriteableBytes(2),this.setInt16(this.length,e),this.length+=2},WMKS.Packet.prototype.writeInt32=function(e){this._ensureWriteableBytes(4),this.setInt32(this.length,e),this.length+=4},WMKS.Packet.prototype.writeStringASCII=function(e){let t;for(this._ensureWriteableBytes(e.length),t=0;t<e.length;++t)this.setUint8(this.length++,e.charCodeAt(t))},WMKS.Packet.prototype.writeArray=function(e){e&&e.length&&(this._ensureWriteableBytes(e.length),this._buffer.set(e,this.length),this.length+=e.length)},WMKS.Packet.prototype.readUint8=function(){let e;return this._checkReadableBytes(1)&&(e=this.getUint8(this._readPosition),this._readPosition+=1),e},WMKS.Packet.prototype.readUint16=function(){let e;return this._checkReadableBytes(2)&&(e=this.getUint16(this._readPosition),this._readPosition+=2),e},WMKS.Packet.prototype.readUint32=function(){let e;return this._checkReadableBytes(4)&&(e=this.getUint32(this._readPosition),this._readPosition+=4),e},WMKS.Packet.prototype.readInt8=function(){let e;return this._checkReadableBytes(1)&&(e=this.getInt8(this._readPosition),this._readPosition+=1),e},WMKS.Packet.prototype.readInt16=function(){let e;return this._checkReadableBytes(2)&&(e=this.getInt16(this._readPosition),this._readPosition+=2),e},WMKS.Packet.prototype.readInt32=function(){let e;return this._checkReadableBytes(4)&&(e=this.getInt32(this._readPosition),this._readPosition+=4),e},WMKS.Packet.prototype.readArray=function(e){let t;return this._checkReadableBytes(e)&&(0===e?t=null:(t=this.getArray(this._readPosition,e),this._readPosition+=e)),t},WMKS.Packet.prototype.readStringASCII=function(e){let t=this.readArray(e);return t&&(t=String.fromCharCode.apply(String,t)),t},WMKS.Packet.prototype.setUint8=function(e,t){this._buffer[e]=255&t},WMKS.Packet.prototype.setUint16be=function(e,t){this._buffer[e+1]=255&t,this._buffer[e+0]=t>>8&255},WMKS.Packet.prototype.setUint32be=function(e,t){this._buffer[e+3]=255&t,this._buffer[e+2]=t>>8&255,this._buffer[e+1]=t>>16&255,this._buffer[e+0]=t>>24&255},WMKS.Packet.prototype.setUint16le=function(e,t){this._buffer[e+0]=255&t,this._buffer[e+1]=t>>8&255},WMKS.Packet.prototype.setUint32le=function(e,t){this._buffer[e+0]=255&t,this._buffer[e+1]=t>>8&255,this._buffer[e+2]=t>>16&255,this._buffer[e+3]=t>>24&255},WMKS.Packet.prototype.setInt8=function(e,t){return this.setUint8(e,t)},WMKS.Packet.prototype.setInt16be=function(e,t){return this.setUint16be(e,t)},WMKS.Packet.prototype.setInt32be=function(e,t){return this.setUint32be(e,t)},WMKS.Packet.prototype.setInt16le=function(e,t){return this.setUint16le(e,t)},WMKS.Packet.prototype.setInt32le=function(e,t){return this.setUint32le(e,t)},WMKS.Packet.prototype.getArray=function(e,t){return this._buffer.subarray(e,e+t)},WMKS.Packet.prototype.getInt8=function(e){let t=this._buffer[e];return 128&t&&(t=t-255-1),t},WMKS.Packet.prototype.getInt16be=function(e){let t;return t=this._buffer[e+1],32768&(t|=this._buffer[e+0]<<8)&&(t=t-65535-1),t},WMKS.Packet.prototype.getInt32be=function(e){let t;return t=this._buffer[e+3],t|=this._buffer[e+2]<<8,t|=this._buffer[e+1]<<16,t|=this._buffer[e+0]<<24},WMKS.Packet.prototype.getInt16le=function(e){let t;return t=this._buffer[e+0],32768&(t|=this._buffer[e+1]<<8)&&(t=t-65535-1),t},WMKS.Packet.prototype.getInt32le=function(e){let t;return t=this._buffer[e+0],t|=this._buffer[e+1]<<8,t|=this._buffer[e+2]<<16,t|=this._buffer[e+3]<<24},WMKS.Packet.prototype.getUint8=function(e){return this._buffer[e]},WMKS.Packet.prototype.getUint16be=function(e){let t;return t=this._buffer[e+1],t|=this._buffer[e+0]<<8},WMKS.Packet.prototype.getUint32be=function(e){let t;return t=this._buffer[e+3],t|=this._buffer[e+2]<<8,t|=this._buffer[e+1]<<16,(t|=this._buffer[e+0]<<24)<0&&(t=4294967295+t+1),t},WMKS.Packet.prototype.getUint16le=function(e){let t;return t=this._buffer[e+0],t|=this._buffer[e+1]<<8},WMKS.Packet.prototype.getUint32le=function(e){let t;return t=this._buffer[e+0],t|=this._buffer[e+1]<<8,t|=this._buffer[e+2]<<16,(t|=this._buffer[e+3]<<24)<0&&(t=4294967295+t+1),t},WMKS.Packet.prototype._resizeBuffer=function(e){if(e>0){const t=new Uint8Array(e);t.set(this._buffer),this._buffer=t}},WMKS.Packet.prototype._ensureWriteableBytes=function(e){if(e>0){const t=this.length+e;let i=this._buffer.length;for(;i<t;)i=Math.floor(1.5*i);i>this._buffer.length&&this._resizeBuffer(i)}},WMKS.Packet.prototype._checkReadableBytes=function(e){return this._readPosition+e<=this.length};var r=function(){return this._sessions=[],this._listeners=[],this._lastError=null,this};r.ENABLE_PROBE_CHANNEL=1,r.MAJOR_VER=3,r.MINOR_VER=0,r.SUPPORTED_VER=[{MAJOR:2,MINOR:0,FLAGS:0},{MAJOR:1,MINOR:0,FLAGS:0}],r.CAPS_V10_1=0,r.CAPS_V10_2=0,r.ALL_SESSIONS=-1,r.RTT_HISTORY_SIZE=30,r.MIN_CHANNEL_NAME_LEN=1,r.MAX_CHANNEL_NAME_LEN=255,r.MAX_INITIAL_DATA_LEN=4096,r.STATUS={SUCCESS:0,ERROR:1,OUT_OF_MEMORY:2,INVALID_ARGS:3,INVALID_STATE:4,CLOSED:5,PROTOCOL_ERROR:6,TRANSPORT_ERROR:7,OPEN_REJECTED:8,OPEN_TIMEOUT:9},r.prototype.openSession=function(e){let t;return(t=new S(this)).attachToWebSocket(e),this._sessions.push(t),t},r.prototype.closeSession=function(e){let t;return e instanceof S?e.state===r.SESSION_STATE.CLOSING||(-1===(t=this._sessions.indexOf(e))?(this.setLastError(r.STATUS.INVALID_ARGS,"VVC.closeSession","Invalid session, session is not registered with this vvc instance"),!1):(e.onSessionClose(),this._sessions=this._sessions.splice(t,1),!0)):(this.setLastError(r.STATUS.INVALID_ARGS,"VVC.closeSession","Invalid session, not instanceof VVCSession"),!1)},r.prototype.createListener=function(e,t){let i,s,n;if(e instanceof S){if(t.length<r.MIN_CHANNEL_NAME_LEN||t.length>r.MAX_CHANNEL_NAME_LEN)return this.setLastError(r.STATUS.INVALID_ARGS,"VVC.createListener",'Invalid name "'+t+'", length must be between '+r.MIN_CHANNEL_NAME_LEN+" and "+r.MAX_CHANNEL_NAME_LEN+" characters."),null;for(s=this._findSessionListeners(e),n=0;n<s.length;++n)if(s[n].name===t)return this.setLastError(r.STATUS.INVALID_ARGS,"VVC.createListener",'Invalid name "'+t+'", a listener on this session with this name already exists.'),null;return i=new d(this,e,t),this._listeners.push(i),i}return this.setLastError(r.STATUS.INVALID_ARGS,"VVC.createListener","Invalid session: not an instanceof VVCSession"),null},r.prototype.closeListener=function(e){const t=this._listeners.indexOf(e);return e instanceof d?e.state===r.LISTENER_STATE.CLOSING||(-1===t?(this.setLastError(r.STATUS.INVALID_ARGS,"VVC.closeListener","Invalid listener, listener is not registered with this vvc instance"),!1):(e.onclose&&e.onclose(),this._listeners=this._listeners.splice(t,1),!0)):(this.setLastError(r.STATUS.INVALID_ARGS,"VVC.closeListener","Invalid listener, not instanceof VVCListener"),!1)},r.prototype._findListenerByName=function(e){let t,i;for(i=0;i<this._listeners.length;++i)if((t=this._listeners[i]).name===e)return t;return null},r.prototype._findSessionListeners=function(e){let t,i;const s=[];for(i=0;i<this._listeners.length;++i)((t=this._listeners[i]).session===r.ALL_SESSIONS||t.session===e)&&s.push(t);return s};const a=function(e,t,i){return this.status=e,this.where=t,this.msg=i,this};r.prototype.getLastError=function(){return this._lastError},r.prototype.setLastError=function(e,t,i){this._lastError=new a(e,t,i),e!==r.STATUS.SUCCESS&&console.error(t+": "+i)};const c=function(e,t,i,s,n,o){return this.id=t,this.name=i,this.priority=s||0,this.flags=n||0,this.timeout=o||0,this.protocol="binary",this.state=r.CHANNEL_STATE.INIT,this.onopen=this.onopen||null,this.onclose=this.onclose||null,this.onerror=this.onerror||null,this.onmessage=this.onmessage||null,this._session=e,this._vvcInstance=e.vvcInstance,this};r.CHANNEL_STATE={INIT:0,OPEN_FAILED:1,OPEN:2,CLOSING:3,PEER_CLOSING:4,PEER_CLOSED:5,CLOSED:6},c.prototype.send=function(e){return this._session.send(this,e)},c.prototype.close=function(){return this._session.closeChannel(this)};const h=function(e){c.call(this,e,r.CONTROL_CHANNEL_ID,r.CONTROL_CHANNEL_NAME,0,0,0),this.state=r.CHANNEL_STATE.OPEN,this.versionMajor=0,this.versionMinor=0,this._rttSendTimeMS=0};h.prototype=Object.create(c.prototype),r.CTRL_HEADER_SIZE=4,r.CONTROL_CHANNEL_ID=0,r.CONTROL_CHANNEL_NAME="vvcctrl",r.CTRL_OP={RECV_ACK:1,INIT:2,INIT_ACK:3,OPEN_CHAN:4,OPEN_CHAN_ACK:5,OPEN_CHAN_CANCEL:6,CLOSE_CHAN:7,CLOSE_CHAN_ACK:8,RTT:9,RTT_ACK:10},r.CTRL_FLAG={ODAT:128},r.INIT_EXT_FLAG={EDAT:32768},r.INIT_EXT_TYPE={VERSION:1,PROBE:2},r.INIT_EXT_PROBE_FLAG={SUPPORTED:1},r.OPEN_CHAN_STATUS={SUCCESS:0,REJECT:1,TIMEOUT:2},r.CLOSE_CHAN_REASON={NORMAL:0,ERROR:1},r.CLOSE_CHAN_STATUS={SUCCESS:0,ERROR:1},r.CTRL_OP.SIZE=[],r.CTRL_OP.SIZE[r.CTRL_OP.RECV_ACK]=0,r.CTRL_OP.SIZE[r.CTRL_OP.INIT]=12,r.CTRL_OP.SIZE[r.CTRL_OP.INIT_ACK]=12,r.CTRL_OP.SIZE[r.CTRL_OP.OPEN_CHAN]=20,r.CTRL_OP.SIZE[r.CTRL_OP.OPEN_CHAN_ACK]=12,r.CTRL_OP.SIZE[r.CTRL_OP.OPEN_CHAN_CANCEL]=0,r.CTRL_OP.SIZE[r.CTRL_OP.CLOSE_CHAN]=8,r.CTRL_OP.SIZE[r.CTRL_OP.CLOSE_CHAN_ACK]=8,r.CTRL_OP.SIZE[r.CTRL_OP.RTT]=0,r.CTRL_OP.SIZE[r.CTRL_OP.RTT_ACK]=0,r.CTRL_OP.NAME=[],r.CTRL_OP.NAME[r.CTRL_OP.RECV_ACK]="VVC.CTRL_OP.RECV_ACK",r.CTRL_OP.NAME[r.CTRL_OP.INIT]="VVC.CTRL_OP.INIT",r.CTRL_OP.NAME[r.CTRL_OP.INIT_ACK]="VVC.CTRL_OP.INIT_ACK",r.CTRL_OP.NAME[r.CTRL_OP.OPEN_CHAN]="VVC.CTRL_OP.OPEN_CHAN",r.CTRL_OP.NAME[r.CTRL_OP.OPEN_CHAN_ACK]="VVC.CTRL_OP.OPEN_CHAN_ACK",r.CTRL_OP.NAME[r.CTRL_OP.OPEN_CHAN_CANCEL]="VVC.CTRL_OP.OPEN_CHAN_CANCEL",r.CTRL_OP.NAME[r.CTRL_OP.CLOSE_CHAN]="VVC.CTRL_OP.CLOSE_CHAN",r.CTRL_OP.NAME[r.CTRL_OP.CLOSE_CHAN_ACK]="VVC.CTRL_OP.CLOSE_CHAN_ACK",r.CTRL_OP.NAME[r.CTRL_OP.RTT]="VVC.CTRL_OP.RTT",r.CTRL_OP.NAME[r.CTRL_OP.RTT_ACK]="VVC.CTRL_OP.RTT_ACK",h.prototype.sendInit=function(e){let t,i,s;if(void 0===e&&(e=r.CTRL_OP.INIT),e!==r.CTRL_OP.INIT&&e!==r.CTRL_OP.INIT_ACK)return this._vvcInstance.setLastError(r.STATUS.INVALID_ARGS,"VVCControlChannel.sendInit","Invalid code,  expected INIT or INIT_ACK"),!1;if((s=this._createControlPacket(e)).writeUint16(r.MAJOR_VER),s.writeUint16(r.MINOR_VER),s.writeUint32(r.CAPS_V10_1),s.writeUint32(r.CAPS_V10_2),r.MAJOR_VER>=2){for(t=16*r.SUPPORTED_VER.length,r.ENABLE_PROBE_CHANNEL&&(t+=8),s.writeUint32(t),i=0;i<r.SUPPORTED_VER.length;++i)s.writeUint16(r.INIT_EXT_TYPE.VERSION),s.writeUint16(r.INIT_EXT_FLAG.EDAT),s.writeUint32(8),s.writeUint16(r.SUPPORTED_VER[i].MAJOR),s.writeUint16(r.SUPPORTED_VER[i].MINOR),s.writeUint32(r.SUPPORTED_VER[i].FLAGS);r.ENABLE_PROBE_CHANNEL&&(s.writeUint16(r.INIT_EXT_TYPE.PROBE),s.writeUint16(0),s.writeUint32(r.INIT_EXT_PROBE_FLAG.SUPPORTED))}return this._sendControlPacket(s)},h.prototype.sendRtt=function(){return this._rttSendTimeMS=Date.now(),this._sendControlPacket(this._createControlPacket(r.CTRL_OP.RTT))},h.prototype.sendRecvAck=function(e){let t;for(;e>65535;)t=this._createControlPacket(r.CTRL_OP.RECV_ACK,0,65534),this._sendControlPacket(t),e-=65535;return e>0&&(t=this._createControlPacket(r.CTRL_OP.RECV_ACK,0,e-1),this._sendControlPacket(t)),!0},h.prototype.sendOpenChannel=function(e,t){let i,s=0;return e instanceof c?(s=0,!t||(s=t.length),(i=this._createControlPacket(r.CTRL_OP.OPEN_CHAN)).writeUint32(e.id),i.writeUint32(e.priority),i.writeUint32(e.flags),i.writeUint32(e.timeout),i.writeUint16(0),i.writeUint8(0),i.writeUint8(e.name.length),i.writeUint32(s),i.writeStringASCII(e.name),s&&i.writeArray(t),this._sendControlPacket(i)):(this._vvcInstance.setLastError(r.STATUS.INVALID_ARGS,"VVCControlChannel.sendOpenChannel","Invalid channel,  expected instanceof VVCChannel"),!1)},h.prototype.sendOpenChannelAck=function(e,t,i){const s=this._createControlPacket(r.CTRL_OP.OPEN_CHAN_ACK);return s.writeUint32(e.id),s.writeUint32(t),i?(s.writeUint32(i.length),s.writeArray(i)):s.writeUint32(0),this._sendControlPacket(s)},h.prototype.sendCloseChannel=function(e,t){const i=this._createControlPacket(r.CTRL_OP.CLOSE_CHAN);return i.writeUint32(e.id),i.writeUint32(t),this._sendControlPacket(i)},h.prototype.sendCloseChannelAck=function(e,t){const i=this._createControlPacket(r.CTRL_OP.CLOSE_CHAN_ACK);return i.writeUint32(e.id),i.writeUint32(t),this._sendControlPacket(i)},h.prototype.onmessage=function(e){const t=WMKS.Packet.createFromBuffer(e.data),i=t.readUint8(),s=(t.readUint8(),t.readUint16());switch(i){case r.CTRL_OP.INIT:case r.CTRL_OP.INIT_ACK:this._onInit(t,i);break;case r.CTRL_OP.RTT:this._onRtt(t);break;case r.CTRL_OP.RTT_ACK:this._onRttAck(t);break;case r.CTRL_OP.OPEN_CHAN:this._onOpenChannel(t);break;case r.CTRL_OP.OPEN_CHAN_ACK:this._onOpenChannelAck(t);break;case r.CTRL_OP.CLOSE_CHAN:this._onCloseChannel(t);break;case r.CTRL_OP.CLOSE_CHAN_ACK:this._onCloseChannelAck(t);break;case r.CTRL_OP.RECV_ACK:this._onRecvAck(t,s);break;default:return this._session.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel.onmessage","Unknown control opcode: "+i),!1}return!0},h.prototype._onRtt=function(e){let t;return!!this._checkErrorMinimumSize(r.CTRL_OP.RTT,e)&&(t=this._createControlPacket(r.CTRL_OP.RTT_ACK),this._sendControlPacket(t))},h.prototype._onRttAck=function(e){return!!this._checkErrorMinimumSize(r.CTRL_OP.RTT_ACK,e)&&(this._session.addRttTime(Date.now()-this._rttSendTimeMS),!0)},h.prototype._onRecvAck=function(e,t){return!!this._checkErrorMinimumSize(r.CTRL_OP.RECV_ACK,e)},h.prototype._isVersionSupported=function(e,t){if(r.MAJOR_VER==e&&r.MINOR_VER==t)return!0;for(let i=0;i<r.SUPPORTED_VER.length;++i)if(r.SUPPORTED_VER[i].MAJOR==e&&r.SUPPORTED_VER[i].MINOR==t)return!0;return!1},h.prototype._onInit=function(e,t){let i,s,n,o;const a=[];if(!this._checkErrorMinimumSize(t,e))return!1;if(!this._checkErrorSessionState(t,r.SESSION_STATE.INIT))return!1;if(i=e.readUint16(),s=e.readUint16(),n=e.readUint32(),o=e.readUint32(),i>=2){let i;if(!this._checkErrorRemainingSize(t,e,4))return!1;if(i=e.readUint32(),!this._checkErrorRemainingSize(t,e,i))return!1;for(;e.bytesRemaining()>=8;){var c,h,d,u,S,l,_,C;if(c=e.readUint16(),h=e.readUint16(),d=e.readUint32(),u=h&r.INIT_EXT_FLAG.EDAT?d:0,!this._checkErrorRemainingSize(t,e,u))return!1;switch(_=e.bytesRemaining(),c){case r.INIT_EXT_TYPE.VERSION:if(!this._checkErrorRemainingSize(t,e,8))return!1;S=e.readUint16(),l=e.readUint16(),e.readUint32(),a.push({major:S,minor:l});break;case r.INIT_EXT_TYPE.PROBE:d&r.INIT_EXT_PROBE_FLAG.SUPPORTED&&this._session.createProbeChannel()}(C=_-e.bytesRemaining())<u&&e.readArray(u-C)}}if(this.versionMajor=0,this.versionMinor=0,this._isVersionSupported(i,s))this.versionMajor=i,this.versionMinor=s;else for(let e=0;e<a.length;e++)S=a[e].major,l=a[e].minor,this._isVersionSupported(S,l)&&S>=this.versionMajor&&l>=this.versionMinor&&(this.versionMajor=S,this.versionMinor=l);return 0==this.versionMajor&&0==this.versionMinor?(this._vvcInstance.setLastError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel._onInit","Failed to negotiate compatible protocol  version."),!1):(t===r.CTRL_OP.INIT&&this.sendInit(r.CTRL_OP.INIT_ACK),this._session.onConnect(),!0)},h.prototype._onOpenChannel=function(e){if(!this._checkErrorMinimumSize(r.CTRL_OP.OPEN_CHAN,e))return!1;let t,i,s;const n=e.readUint32(),o=e.readUint32(),a=e.readUint32(),c=e.readUint32(),h=(e.readUint16(),e.readUint8(),e.readUint8()),d=e.readUint32();return!!this._checkErrorMinimumSize(r.CTRL_OP.OPEN_CHAN,e,h+d)&&(t=e.readStringASCII(h),i=e.readArray(d),(s=this._session.createChannel(n,t,o,a,c)).initialData=i,this._session.onPeerOpen(s),!0)},h.prototype._onOpenChannelAck=function(e){let t,i,s,n;return!!this._checkErrorMinimumSize(r.CTRL_OP.OPEN_CHAN_ACK,e)&&(t=e.readUint32(),i=e.readUint32(),s=e.readUint32(),!!this._checkErrorMinimumSize(r.CTRL_OP.OPEN_CHAN_ACK,e,s)&&(n=e.readArray(s),!!this._checkErrorValidChannel(r.CTRL_OP.OPEN_CHAN_ACK,t,r.CHANNEL_STATE.INIT)&&(this._session.onChannelOpen(this._session.getChannel(t),i,n),!0)))},h.prototype._onCloseChannel=function(e){let t,i;return!!this._checkErrorMinimumSize(r.CTRL_OP.CLOSE_CHAN,e)&&(t=e.readUint32(),i=e.readUint32(),!!this._checkErrorValidChannel(r.CTRL_OP.CLOSE_CHAN,t)&&(this._session.onChannelClose(this._session.getChannel(t),i),!0))},h.prototype._onCloseChannelAck=function(e){let t,i;return!!this._checkErrorMinimumSize(r.CTRL_OP.CLOSE_CHAN_ACK,e)&&(t=e.readUint32(),i=e.readUint32(),!!this._checkErrorValidChannel(r.CTRL_OP.CLOSE_CHAN_ACK,t,r.CHANNEL_STATE.CLOSING)&&(this._session.onChannelClose(this._session.getChannel(t),i),!0))},h.prototype._checkErrorMinimumSize=function(e,t,i){const s=t.length-4,n=r.CTRL_OP.SIZE[e];if(s<n+(i=i||0)){const t=r.CTRL_OP.NAME[e];return this._session.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel._checkErrorMinimumSize","Received invalid "+t+" message, message too small, received "+s+" bytes, expected "+n+" + "+i),!1}return!0},h.prototype._checkErrorRemainingSize=function(e,t,i){const s=t.bytesRemaining();if(s<i){const t=r.CTRL_OP.NAME[e];return this._session.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel._checkErrorRemainingSize","Received invalid "+t+" message, message too small, expected "+(i-s)+" more bytes."),!1}return!0},h.prototype._checkErrorSessionState=function(e,t){const i=r.CTRL_OP.NAME[e];return this._session.state===t||(this._session.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel._checkErrorSessionState","Received invalid "+i+" message, invaild session state, found "+this._session.state+" expected "+t),!1)},h.prototype._checkErrorValidChannel=function(e,t,i){const s=r.CTRL_OP.NAME[e],n=this._session.getChannel(t);return t===r.CONTROL_CHANNEL_ID?(this._session.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel._checkErrorValidChannel","Received invalid "+s+" message, unexpected use of control channel id"),!1):n?void 0===i||n.state===i||(this._session.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel._checkErrorValidChannel","Received invalid "+s+" message, unexpected channel state, found "+n.state+"  expected "+i),!1):(this._session.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCControlChannel._checkErrorValidChannel","Received invalid "+s+" message, unknown channel "+t),!1)},h.prototype._createControlPacket=function(e,t,i){const s=WMKS.Packet.createNewPacket();return i=i||0,t=t||0,s.control={code:e,flags:t,param:i},s.writeUint8(e),s.writeUint8(t),s.writeUint16(i),s},h.prototype._sendControlPacket=function(e){return e.length>r.CTRL_HEADER_SIZE&&(e.control.flags|=r.CTRL_FLAG.ODAT,e.control.param=e.length-r.CTRL_HEADER_SIZE),e.setUint8(1,e.control.flags),e.setUint16(2,e.control.param),this.send(e.getData())};var d=function(e,t,i){return this.name=i,this.session=t,this.state=r.LISTENER_STATE.ACTIVE,this.onconnect=null,this.onpeeropen=null,this.onclose=null,this._vvcInstance=e,this};r.LISTENER_STATE={INIT:0,ACTIVE:1,CLOSING:2},d.prototype.close=function(){return this._vvcInstance.closeListener(this)},d.prototype.matchName=function(e){const t=this.name.indexOf("*");return-1!==t?this.name.substr(0,t)===e.substring(0,t):this.name===e};const u=function(e){c.call(this,e,r.PROBE_CHANNEL_ID,r.PROBE_CHANNEL_NAME,0,0,0),this.state=r.CHANNEL_STATE.OPEN};u.prototype=Object.create(c.prototype),r.PROBE_CHANNEL_ID=1,r.PROBE_CHANNEL_NAME="vvcprobe";var S=function(e,t){let i=!1;return t&&"server"in t&&(i=t.server),this.state=r.SESSION_STATE.INIT,this.onerror=null,this.ontransportclose=null,this.ontransporterror=null,this._vvcInstance=e,this._server=i,this._channels=[],this._channelIdCtrl=this._server?3:2,this._bytesRead=0,this._bytesRequested=r.CHUNK_COMMON_HEADER_SIZE,this._rttHistory=[],this._rttHistoryIndex=0,this._chunk={},this._chunk.channel=0,this._chunk.flags=0,this._chunk.length=0,this._chunk.ext={},this._chunk.ext.code=0,this._chunk.ext.flags=0,this._chunk.ext.param=0,this._chunk.ext.length=0,this._buffers={},this._buffers.ext=null,this._buffers.data=[],this._buffers.send=WMKS.Packet.createNewPacket(32),this._buffers.header=WMKS.Packet.createNewPacket(r.CHUNK_COMMON_HEADER_SIZE+r.CHUNK_LARGE_HEADER_SIZE+r.CHUNK_EXTENSION_HEADER_SIZE),this._receiveState=r.SESSION_RECEIVE_STATE.COMMON_HEADER,this._setReceiveState(r.SESSION_RECEIVE_STATE.COMMON_HEADER),this};r.CHUNK_COMMON_HEADER_SIZE=4,r.CHUNK_LARGE_HEADER_SIZE=4,r.CHUNK_EXTENSION_HEADER_SIZE=4,r.CHUNK_MAX_LEN=65536,r.CHUNK_LARGE_MAX_LEN=4294966272,r.SESSION_STATE={INIT:0,ESTABLISHED:1,ERROR:2,CLOSING:3},r.SESSION_RECEIVE_STATE={COMMON_HEADER:0,LARGE_HEADER:1,EXTENSION_HEADER:2,EXTENSION_DATA:3,DATA:4},r.CHUNK_FLAG={PAD:16,EXT:32,LC:64,FIN:128},r.CHUNK_EXT_FLAG={ELST:64,EDAT:128},r.CHUNK_EXT_CODE={LARGE_CHANNEL_ID:1},S.prototype.close=function(){return this._vvcInstance.closeSession(this)},S.prototype.openChannel=function(e,t,i,s,n){let o;return t=t||0,i=i||0,s=s||0,n=n||null,this._checkErrorNameLength("openChannel",e)&&this._checkErrorSessionState("openChannel",r.SESSION_STATE.ESTABLISHED)&&this._checkErrorInitialData("openChannel",n)?(o=this.createChannel(this._nextChannelId(),e,t,i,s),this.controlChannel.sendOpenChannel(o,n),o):null},S.prototype.acceptChannel=function(e,t,i){return t=t||0,i=i||null,this._checkErrorSessionState("acceptChannel",r.SESSION_STATE.ESTABLISHED)&&this._checkErrorInitialData("acceptChannel",i)&&this._checkErrorIsChannel("acceptChannel",e)?(this.controlChannel.sendOpenChannelAck(e,r.OPEN_CHAN_STATUS.SUCCESS,i),this.onChannelOpen(e,r.OPEN_CHAN_STATUS.SUCCESS,e.initialData),delete e.initialData,e):null},S.prototype.rejectChannel=function(e,t){return t=t||null,!!this._checkErrorSessionState("rejectChannel",r.SESSION_STATE.ESTABLISHED)&&(!!this._checkErrorInitialData("rejectChannel",t)&&(!!this._checkErrorIsChannel("rejectChannel",e)&&(this.controlChannel.sendOpenChannelAck(e,r.OPEN_CHAN_STATUS.REJECT,t),e.state=r.CHANNEL_STATE.CLOSED,this._releaseChannel(e),!0)))},S.prototype.closeChannel=function(e){return!!this._checkErrorSessionState("closeChannel",r.SESSION_STATE.ESTABLISHED)&&(!!this._checkErrorIsChannel("closeChannel",e)&&(!!this._checkErrorChannelState("closeChannel",e,r.CHANNEL_STATE.OPEN)&&(e.state=r.CHANNEL_STATE.CLOSING,this.controlChannel.sendCloseChannel(e,r.CLOSE_CHAN_REASON.NORMAL),!0)))},S.prototype.addRttTime=function(e){this._rttHistory[this._rttHistoryIndex]=e,this._rttHistoryIndex++,this._rttHistoryIndex>=r.RTT_HISTORY_SIZE&&(this._rttHistoryIndex=0)},S.prototype.attachToWebSocket=function(e){const t=this;return this.socket=e,e.onopen=function(e){this.binaryType="arraybuffer",t._onTransportOpen()},e.onclose=function(e){t._onTransportClose(e)},e.onerror=function(e){t._onTransportError(e)},e.onmessage=function(e){if(!(e.data instanceof ArrayBuffer))throw"Expected ArrayBuffer from websocket";t._onTransportRecv(new Uint8Array(e.data))},e.readyState&&e.onopen({}),!0},S.prototype._nextChannelId=function(){const e=this._channelIdCtrl;return this._channelIdCtrl+=2,e},S.prototype.createChannel=function(e,t,i,s,n){let o;return o=new c(this,e,t,i=i||0,s=s||0,n=n||0),this._channels[e]=o,this._buffers.data[e]=[],o},S.prototype._releaseChannel=function(e){e.state===r.CHANNEL_STATE.OPEN&&this._vvcInstance.setLastError(r.STATUS.PROTOCOL_ERROR,"VVCSession._releaseChannel","Releasing an open channel!"),delete this._channels[e.id],delete this._buffers.data[e.id]},S.prototype.getChannel=function(e){return this._channels[e]?this._channels[e]:null},S.prototype.onSessionError=function(e,t,i){this.state=r.SESSION_STATE.ERROR,this._vvcInstance.setLastError(e,t,i),this.onerror&&this.onerror(e)},S.prototype.onSessionClose=function(){let e,t,i;t=this.state===r.SESSION_STATE.ERROR?r.CLOSE_CHAN_REASON.ERROR:r.CLOSE_CHAN_REASON.NORMAL,this.state=r.SESSION_STATE.CLOSING;try{this.socket.close()}catch(e){this._onTransportException(e)}for(i=0;i<this._channels.length;++i)(e=this._channels[i])&&(e.state===r.CHANNEL_STATE.INIT?this.onChannelOpen(e,r.STATUS.ERROR):e.state!==r.CHANNEL_STATE.OPEN&&e.state!==r.CHANNEL_STATE.CLOSING||(e.state=r.CHANNEL_STATE.CLOSING,this.onChannelClose(e,t)))},S.prototype.onConnect=function(){let e,t,i;for(i=this._vvcInstance._findSessionListeners(this),this.state=r.SESSION_STATE.ESTABLISHED,e=0;e<i.length;++e)(t=i[e]).onconnect&&t.onconnect(this)},S.prototype.onPeerOpen=function(e){let t,i,s;for(s=this._vvcInstance._findSessionListeners(this),t=0;t<s.length;++t)(i=s[t]).matchName(e.name)&&i.onpeeropen&&i.onpeeropen(this,e)},S.prototype.onChannelOpen=function(e,t,i){t===r.OPEN_CHAN_STATUS.SUCCESS?(e.state=r.CHANNEL_STATE.OPEN,e.onopen&&e.onopen(this._createEvent("open",{data:i}))):(e.state=r.CHANNEL_STATE.OPEN_FAILED,this._releaseChannel(e),this.onChannelError(e))},S.prototype.onChannelError=function(e){e.onerror&&e.onerror(this._createEvent("error"))},S.prototype.onChannelMessage=function(e,t){e?e.onmessage&&e.onmessage(this._createEvent("message",{data:t})):this.socket.readyState===WebSocket.OPEN&&this.onSessionError(r.STATUS.PROTOCOL_ERROR,"VVCSession.onChannelMessage","Unknown channel in chunk")},S.prototype.onChannelClose=function(e,t){let i;t===r.CLOSE_CHAN_REASON.NORMAL?(i=1e3,e.state===r.CHANNEL_STATE.CLOSING?e.state=r.CHANNEL_STATE.PEER_CLOSED:(e.state=r.CHANNEL_STATE.PEER_CLOSING,this.controlChannel.sendCloseChannelAck(e,r.CLOSE_CHAN_STATUS.SUCCESS))):i=1002,e.onclose&&e.onclose(this._createEvent("close",{wasClean:t===r.CLOSE_CHAN_REASON.NORMAL,reason:t,code:i})),e.state=r.CHANNEL_STATE.CLOSED,this._releaseChannel(e)},S.prototype.createProbeChannel=function(){this.probeChannel=new u(this),this._channels[this.probeChannel.id]=this.probeChannel,this._buffers.data[this.probeChannel.id]=[]},S.prototype._createControlChannel=function(){this.controlChannel=new h(this),this._channels[this.controlChannel.id]=this.controlChannel,this._buffers.data[this.controlChannel.id]=[]},S.prototype._onTransportOpen=function(){this._createControlChannel(),this._server||this.controlChannel.sendInit(r.CTRL_OP.INIT)},S.prototype._onTransportClose=function(e){this.state===r.SESSION_STATE.ESTABLISHED&&this.onSessionError(r.TRANSPORT_ERROR,"VVCSession._onTransportClose","The WebSocket closed whilst the session was open."),this.ontransportclose&&this.ontransportclose(e)},S.prototype._onTransportError=function(e){this.onSessionError(r.TRANSPORT_ERROR,"VVCSession._onTransportError","An error occurred in the WebSocket."),this.ontransporterror&&this.ontransporterror(e)},S.prototype._onTransportException=function(e){this.onSessionError(r.TRANSPORT_ERROR,"VVCSession._onTransportException","An exception occurred in the WebSocket: "+e.message),this.ontransporterror&&this.ontransporterror(this._createEvent("error"))},S.prototype._combineBuffers=function(e){let t,i,s,n;if(0===e.length)return null;for(n=0,s=0;s<e.length;++s)n+=e[s].length;for(i=new ArrayBuffer(n),t=new Uint8Array(i),n=0,s=0;s<e.length;++s)t.set(e[s],n),n+=e[s].length;return i},S.prototype._setReceiveState=function(e){switch(this._receiveState=e,e){case r.SESSION_RECEIVE_STATE.COMMON_HEADER:this._bytesRequested=r.CHUNK_COMMON_HEADER_SIZE,this._bytesRead=0,this._buffers.header.reset();break;case r.SESSION_RECEIVE_STATE.LARGE_HEADER:this._bytesRequested+=r.CHUNK_LARGE_HEADER_SIZE;break;case r.SESSION_RECEIVE_STATE.EXTENSION_HEADER:this._bytesRequested+=r.CHUNK_EXTENSION_HEADER_SIZE;break;case r.SESSION_RECEIVE_STATE.EXTENSION_DATA:this._bytesRequested+=this._chunk.ext.length;break;case r.SESSION_RECEIVE_STATE.DATA:this._bytesRequested+=this._chunk.length}},S.prototype._onTransportRecv=function(e){let t,i,s,n;switch(i=this._bytesRequested-this._bytesRead,s=Math.min(e.length,i),n=e.subarray(0,s),t=null,this._receiveState){case r.SESSION_RECEIVE_STATE.COMMON_HEADER:case r.SESSION_RECEIVE_STATE.LARGE_HEADER:case r.SESSION_RECEIVE_STATE.EXTENSION_HEADER:t=this._buffers.header;break;case r.SESSION_RECEIVE_STATE.EXTENSION_DATA:t=this._buffers.ext;break;case r.SESSION_RECEIVE_STATE.DATA:this._buffers.data[this._chunk.channel].push(n),this._chunk.channel!==r.CONTROL_CHANNEL_ID&&s&&this.controlChannel.sendRecvAck(s)}if(t&&t.writeArray(n),this._bytesRead+=s,!(e.length<i)){switch(this._receiveState){case r.SESSION_RECEIVE_STATE.COMMON_HEADER:this._chunk.channel=t.readUint8(),this._chunk.flags=t.readUint8(),this._chunk.length=t.readUint16()+1,this._chunk.flags&r.CHUNK_FLAG.LC?this._setReceiveState(r.SESSION_RECEIVE_STATE.LARGE_HEADER):this._chunk.flags&r.CHUNK_FLAG.EXT?this._setReceiveState(r.SESSION_RECEIVE_STATE.EXTENSION_HEADER):this._setReceiveState(r.SESSION_RECEIVE_STATE.DATA);break;case r.SESSION_RECEIVE_STATE.LARGE_HEADER:this._chunk.length=t.readUint32()+1,this._chunk.flags&r.CHUNK_FLAG.EXT?this._setReceiveState(r.SESSION_RECEIVE_STATE.EXTENSION_HEADER):this._setReceiveState(r.SESSION_RECEIVE_STATE.DATA);break;case r.SESSION_RECEIVE_STATE.EXTENSION_HEADER:this._chunk.ext.code=t.readUint8(),this._chunk.ext.flags=t.readUint8(),this._chunk.ext.param=t.readUint16(),this._chunk.ext.flags&r.CHUNK_EXT_FLAG.EDAT?(this._chunk.ext.length=this._chunk.ext.param+1,this._buffers.ext=new WMKS.Packet.createNewPacket(this._chunk.ext.length),this._setReceiveState(r.SESSION_RECEIVE_STATE.EXTENSION_DATA)):(this._chunk.ext.length=0,this._chunk.ext.flags&r.CHUNK_EXT_FLAG.ELST?this._setReceiveState(r.SESSION_RECEIVE_STATE.DATA):this._setReceiveState(r.SESSION_RECEIVE_STATE.EXTENSION_HEADER));break;case r.SESSION_RECEIVE_STATE.EXTENSION_DATA:this._chunk.ext.code==r.CHUNK_EXT_CODE.LARGE_CHANNEL_ID&&t.bytesRemaining()>=4&&(this._chunk.channel=t.readUint32()),this._buffers.ext=null,this._chunk.ext.flags&r.CHUNK_EXT_FLAG.ELST?this._setReceiveState(r.SESSION_RECEIVE_STATE.DATA):this._setReceiveState(r.SESSION_RECEIVE_STATE.EXTENSION_HEADER);break;case r.SESSION_RECEIVE_STATE.DATA:this._chunk.flags&r.CHUNK_FLAG.FIN&&(t=this._combineBuffers(this._buffers.data[this._chunk.channel]),this.onChannelMessage(this._channels[this._chunk.channel],t),this._buffers.data[this._chunk.channel]=[]),this._setReceiveState(r.SESSION_RECEIVE_STATE.COMMON_HEADER)}e.length>s&&this._onTransportRecv(e.subarray(s))}},S.prototype.send=function(e,t){let i,s,n;if(!this._checkErrorIsChannel("send",e))return!1;if(!this._checkErrorChannelState("send",e,r.CHANNEL_STATE.OPEN))return!1;if(t instanceof Uint8Array||t instanceof ArrayBuffer){(i=this._buffers.send).reset(),i.writeUint8(e.id),n=t.byteLength,s=r.CHUNK_FLAG.FIN,n>r.CHUNK_MAX_LEN?(i.writeUint8(r.CHUNK_FLAG.LC|s),i.writeUint16(0),i.writeUint32(n-1)):(i.writeUint8(s),i.writeUint16(n-1));try{this.socket.send(i.getData()),this.socket.send(t)}catch(e){this._onTransportException(e)}return!0}return this._vvcInstance.setLastError(r.STATUS.INVALID_ARGS,"VVCSession.send","Invalid data, must be Uint8Array or ArrayBuffer"),!1},S.prototype._createEvent=function(e,t){const i=document.createEvent("Event");i.initEvent(e,!1,!1);for(const e in t)i[e]=t[e];return i},S.prototype._checkErrorIsChannel=function(e,t){return t instanceof c||(this._vvcInstance.setLastError(r.STATUS.INVALID_ARGS,"VVCSession."+e,"Invalid channel, must be instanceof VVCChannel"),!1)},S.prototype._checkErrorSessionState=function(e,t){return this.state===t||(this._vvcInstance.setLastError(r.STATUS.INVALID_STATE,"VVCSession."+e,"Invalid state "+this.state+" expected "+t),!1)},S.prototype._checkErrorChannelState=function(e,t,i){return t.state===i||(this._vvcInstance.setLastError(r.STATUS.INVALID_STATE,"VVCSession."+e,"Invalid state "+t.state+" expected "+i),!1)},S.prototype._checkErrorNameLength=function(e,t){return!(t.length<r.MIN_CHANNEL_NAME_LEN||t.length>r.MAX_CHANNEL_NAME_LEN)||(this._vvcInstance.setLastError(r.STATUS.INVALID_ARGS,"VVCSession."+e,"Invalid name "+t+" length must be between "+r.MIN_CHANNEL_NAME_LEN+" and "+r.MAX_CHANNEL_NAME_LEN+" bytes"),!1)},S.prototype._checkErrorInitialData=function(e,t){return!t||t instanceof Uint8Array?!(t&&t.length>r.MAX_INITIAL_DATA_LEN)||(this._vvcInstance.setLastError(r.STATUS.INVALID_ARGS,"VVCSession."+e,"Invalid initial data, must be smaller than "+r.MAX_INITIAL_DATA_LEN+" bytes"),!1):(this._vvcInstance.setLastError(r.STATUS.INVALID_ARGS,"VVCSession."+e,"Invalid initial data, must be instanceof Uint8Array"),!1)},WMKS.RelativeMouseHandler=function(e){"use strict";if(!e||!e.canvas||!e.widgetProto)return WMKS.LOGGER.warn("Invalid params set for RelativeMouseHandler."),null;let t=e.widgetProto,i=e.canvas;const s=e.onToggle;let n={inputProxy:null,cursorIcon:null,clickFeedback:null,dragFeedback:null,pulseFeedback:null,scrollFeedback:null,keypad:null,relativePad:null};this.toggleRelativePad=function(e){n.relativePad&&(e=$.extend({},e,{toggleCallback:s}),n.relativePad.toggle(e))},this.installMouseHandlers=function(){const e=i.parent();i.css({"-webkit-user-select":"none","-webkit-touch-callout":"none"}),n.cursorIcon=$("<div/>").addClass("feedback-container cursor-icon").appendTo(e),n.clickFeedback=$("<div/>").addClass("feedback-container tap-icon").appendTo(e),n.dragFeedback=$("<div/>").addClass("feedback-container drag-icon").appendTo(e),n.pulseFeedback=$("<div/>").addClass("feedback-container pulse-icon").appendTo(e),n.scrollFeedback=$("<div/>").addClass("feedback-container scroll-icon").appendTo(e)},this.initializeRelativeMouseFeature=function(){n.relativePad=new WMKS.relativePadManager(t,i),n.relativePad.initialize()},this.moveCursor=function(e,t){n.cursorIcon&&n.cursorIcon.css({left:e,top:t})},this.setCursorVisibility=function(e){n.cursorIcon&&(e?n.cursorIcon.show():n.cursorIcon.hide())},this.destroy=function(){t=null,i=null,n=null}},WMKS.CONST.RELATIVEPAD={STATE:{idle:0,click:1,move:3,scroll:4}},WMKS.relativePadManager=function(e,t){WMKS.dialogManager.call(this),this._widget=e,this._canvas=t,this.state=WMKS.CONST.RELATIVEPAD.STATE.idle,this.history=[],$.extend(this.options,{name:"RELATIVEPAD",speedControlMinMovePx:5,accelerator:10,minSpeed:1,maxSpeed:10}),WMKS.LOGGER.warn("relativepad : "+this.options.name)},WMKS.relativePadManager.prototype=new WMKS.dialogManager,WMKS.relativePadManager.prototype.getTrackpadHtml=function(){return'<div id="relativePad" class="relativepad-container">                   <div class="left-border"></div>                   <div id="relativePadSurface" style="height:200px; border:1px solid black;"></div>                   <div class="right-border"></div>                   <div class="bottom-border">                      <div class="button-container">                         <div id="relativepadLeft" class="button-left"></div>                         <div id="relativepadRight" class="button-right"></div>                      </div>                   </div>               </div>'},WMKS.relativePadManager.prototype.create=function(){let e;const t=this;return this._widget&&this._canvas?((e=$(this.getTrackpadHtml())).dialog({autoOpen:!1,closeOnEscape:!0,resizable:!1,position:{my:"center",at:"center",of:this._canvas},zIndex:1e3,draggable:!0,dialogClass:"relativepad-wrapper",close:function(e){t.sendUpdatedState(!1)},create:function(e){t.layout($(this).parent())}}),e):(WMKS.LOGGER.debug("Trackpad dialog creation has been aborted. Widget or Canvas is not ready."),null)},WMKS.relativePadManager.prototype.init=function(){const e=this.dialog,t=this;let i;e?(this._widget.requestElementReposition(e.parent(),!0),i=e.find("#relativePadSurface").on("mousemove",function(e){return t.relativepadMouseMove(e.originalEvent)}).on("mouseup",function(e){return t.relativepadMouseClick(e,0)}).on("mousedown",function(e){return t.relativepadMouseClick(e,1)}).on("contextmenu",function(){return!1})):WMKS.LOGGER.debug("Relativepad init aborted. Dialog is not created successfully.")},WMKS.relativePadManager.prototype.disconnect=function(){const e=this.dialog;let t;e&&(t=e.find("#relativepadSurface").off("mousemove").off("mouseup").off("mousedown"))},WMKS.relativePadManager.prototype.layout=function(e){const t=this._canvas;let i,s;e&&t&&(i=e.parent())!==(s=t.parent())&&s.append(e)},WMKS.relativePadManager.prototype.relativepadMouseMove=function(e){let t,i,s,n;const o=$(e.target),r=this._widget;return this.state!==WMKS.CONST.RELATIVEPAD.STATE.idle&&(t=e.pageX,(i=e.pageY)<o.offset().top||i>o.offset().top+o.height()||t<o.offset().left||t>o.offset().left+o.width()?(this.state===WMKS.CONST.RELATIVEPAD.STATE.move&&(this.state=WMKS.CONST.RELATIVEPAD.STATE.idle,this.history.length=0),!1):(this.state===WMKS.CONST.RELATIVEPAD.STATE.move&&(s=this.computeNewCursorLocation(t,i),WMKS.VNCDecoder.cursorPosition&&(n=this._widget.getRelativeMouseCanvasPosition(WMKS.VNCDecoder.cursorPosition),r._relativeMouseHandler.moveCursor(n.x,n.y)),r.sendMouseMoveMessage(s),this.history.shift(),this.history.push({x:t,y:i})),this.state===WMKS.CONST.RELATIVEPAD.STATE.click&&(this.state=WMKS.CONST.RELATIVEPAD.STATE.move,this.history.push({x:t,y:i},{x:t,y:i},{x:t,y:i})),!1))},WMKS.relativePadManager.prototype.computeNewCursorLocation=function(e,t){let i;const s={x:0,y:0};return i=WMKS.UTIL.getLineLength(e-this.history[2].x,t-this.history[2].y),isNaN(i)||0===i?s:(i<this.options.speedControlMinMovePx?(s.x=e-this.history[2].x,s.y=t-this.history[2].y):(i=this.computeMovingDistance(e,t),s.x=Math.floor(i[0]),s.y=Math.floor(i[1])),s)},WMKS.relativePadManager.prototype.computeMovingDistance=function(e,t){let i,s,n,o;return i=this.getTrackpadSpeed(e,this.history[0].x,this.history[1].x,this.history[2].x),s=this.getTrackpadSpeed(t,this.history[0].y,this.history[1].y,this.history[2].y),(o=(n=WMKS.UTIL.getLineLength(i,s))*this.options.accelerator)>this.options.maxSpeed?o=this.options.maxSpeed:o<this.options.minSpeed&&(o=this.options.minSpeed),[i*o,s*o]},WMKS.relativePadManager.prototype.getTrackpadSpeed=function(e,t,i,s){return.3*e+.1*t-.1*i-.3*s},WMKS.relativePadManager.prototype.relativepadMouseClick=function(e,t){if(this.state==WMKS.CONST.RELATIVEPAD.STATE.idle)return this.state=WMKS.CONST.RELATIVEPAD.STATE.click,!1;this.state=WMKS.CONST.RELATIVEPAD.STATE.click;const i=e||window.event;let s;return i.which?1==i.which?s=1:2==i.which?s=4:3==i.which&&(s=2):0==i.button?s=1:1==i.button?s=4:2==i.button&&(s=2),this._widget.sendMouseButtonMessage({x:0,y:0},t,s),this.resetRelativepadState(),!1},WMKS.relativePadManager.prototype.resetRelativepadState=function(){this.history.length=0},$.widget("wmks.wmks",WMKS.widgetProto)}(),$.extend(WMKS.CONST,{Position:{CENTER:0,LEFT_TOP:1},ConnectionState:{CONNECTING:"connecting",CONNECTED:"connected",DISCONNECTED:"disconnected"},Events:{CONNECTION_STATE_CHANGE:"connectionstatechange",REMOTE_SCREEN_SIZE_CHANGE:"screensizechange",FULL_SCREEN_CHANGE:"fullscreenchange",ERROR:"error",KEYBOARD_LEDS_CHANGE:"keyboardledschanged",HEARTBEAT:"heartbeat",AUDIO:"audio",COPY:"copy",TOGGLE:"toggle"},ErrorType:{AUTHENTICATION_FAILED:"authenticationfailed",WEBSOCKET_ERROR:"websocketerror",PROTOCOL_ERROR:"protocolerror"},AudioEncodeType:{VORBIS:"vorbis",OPUS:"opus",AAC:"aac"},InputDeviceType:{KEYBOARD:0,EXTENDED_KEYBOARD:1,TRACKPAD:2}}),WMKS.CONST.KB.VScanMap["ja-JP_106/109"]={32:57,49:2,33:2,50:3,34:3,51:4,35:4,52:5,36:5,53:6,37:6,54:7,38:7,55:8,39:8,56:9,40:9,57:10,41:10,48:11,45:12,61:12,94:13,126:13,157:125,124:61565,113:16,81:16,119:17,87:17,101:18,69:18,114:19,82:19,116:20,84:20,121:21,89:21,117:22,85:22,105:23,73:23,111:24,79:24,112:25,80:25,64:26,96:26,91:27,123:27,93:43,125:43,97:30,65:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,59:39,43:39,58:40,42:40,122:44,90:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,60:51,46:52,62:52,47:53,63:53,95:115,92:125,13:28,165:125,124:125,226:115,29:123,28:121,242:112,243:41,244:41},WMKS.CONST.KB.VScanMap["de-DE"]={32:57,176:41,94:41,160:41,192:41,180:13,96:13,49:2,33:2,50:3,34:3,51:4,167:4,52:5,36:5,53:6,37:6,54:7,38:7,55:8,47:8,56:9,40:9,57:10,41:10,48:11,61:11,223:12,63:12,187:13,113:16,81:16,119:17,87:17,101:18,69:18,114:19,82:19,116:20,84:20,122:21,90:21,117:22,85:22,105:23,73:23,111:24,79:24,112:25,80:25,252:26,220:26,43:27,42:27,35:43,39:43,97:30,65:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,246:39,214:39,228:40,196:40,121:44,89:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,59:51,46:52,58:52,45:53,95:53,60:86,62:86,13:28,226:30,225:30,224:30,234:18,233:18,232:18,238:23,237:23,236:23,244:24,243:24,242:24,251:22,250:22,249:22,253:44,8220:3,178:3,182:4,179:4,124:8,123:9,91:9,125:10,93:10,8800:11,191:12,92:12,64:16,8364:18,5:18,177:27,126:27,181:50,188:86,8804:86},WMKS.CONST.KB.VScanMap["it-IT"]={32:57,92:41,124:41,94:13,180:13,49:2,33:2,50:3,34:3,51:4,163:4,52:5,36:5,53:6,37:6,54:7,38:7,55:8,47:8,56:9,40:9,57:10,41:10,48:11,61:11,39:12,63:12,236:13,113:16,81:16,119:17,87:17,101:18,69:18,114:19,82:19,116:20,84:20,121:21,89:21,117:22,85:22,105:23,73:23,111:24,79:24,112:25,80:25,232:26,233:26,43:27,42:27,249:43,167:43,97:30,65:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,242:39,231:39,224:40,1224:40,176:40,122:44,90:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,59:51,46:52,58:52,45:53,95:53,60:86,62:86,5:18,1037:40,30:26,29:27,171:27,1109:39,186:39,64:39,8364:18,35:40,91:26,93:27,123:26,125:27,13:28},WMKS.CONST.KB.VScanMap["es-ES"]={32:57,161:13,191:13,186:41,170:41,49:2,124:2,33:2,50:3,64:3,34:3,51:4,1035:4,183:4,52:5,36:5,53:6,8364:6,37:6,54:7,172:7,38:7,55:8,47:8,56:9,40:9,57:10,41:10,48:11,61:11,39:12,63:12,236:13,113:16,81:16,119:17,87:17,101:18,5:18,69:18,114:19,82:19,116:20,84:20,121:21,89:21,117:22,85:22,105:23,73:23,111:24,79:24,112:25,80:25,219:26,221:26,43:27,42:27,29:27,93:27,171:27,231:43,199:43,125:43,28:43,97:30,65:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,209:39,241:39,222:40,122:44,90:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,59:51,46:52,58:52,45:53,95:53,60:86,62:86,13:28,226:30,225:30,224:30,227:30,228:30,234:18,233:18,232:18,235:18,238:23,237:23,236:23,239:23,244:24,243:24,242:24,245:24,246:24,251:22,250:22,249:22,252:22,255:21,1034:40,1048:41,91:26,92:41,35:4,126:5,192:26,123:40},WMKS.CONST.KB.VScanMap["pt-BR"]={32:57,176:115,186:43,170:27,49:2,33:2,50:3,64:3,34:41,51:4,1035:4,183:4,52:5,36:5,53:6,37:6,54:7,172:7,38:8,55:8,56:9,40:10,57:10,41:11,48:11,61:13,39:41,63:115,47:115,236:13,113:16,81:16,119:17,87:17,101:18,5:18,69:18,114:19,82:19,116:20,84:20,121:21,89:21,117:22,85:22,105:23,73:23,111:24,79:24,112:25,80:25,219:26,43:13,42:9,29:27,93:43,171:27,231:39,199:39,125:43,28:43,97:30,65:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,209:39,241:39,222:40,122:44,90:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,59:53,46:52,58:53,45:12,95:12,60:51,62:52,13:28,226:30,225:30,224:30,227:30,228:30,234:18,233:18,232:18,235:18,238:23,237:23,236:23,239:23,244:24,243:24,242:24,245:24,246:24,251:22,250:22,249:22,252:22,255:21,1034:40,1048:41,91:27,92:86,124:86,35:4,126:40,192:26,123:27,185:2,8220:3,178:3,182:4,179:4,163:5,162:6,167:13},WMKS.CONST.KB.VScanMap["pt-PT"]={32:57,167:41,177:41,49:2,33:2,50:3,64:3,34:3,51:4,35:4,163:4,52:5,36:5,53:6,8364:6,37:6,54:7,38:7,55:8,47:8,56:9,40:9,93:10,57:10,41:10,48:11,125:11,61:11,39:12,63:12,43:26,42:26,168:26,171:13,187:13,113:16,81:16,119:17,87:17,101:18,69:18,114:19,82:19,116:20,84:20,121:21,89:21,117:22,85:22,105:23,73:23,111:24,79:24,112:25,80:25,186:40,170:40,221:27,192:27,333:30,180:27,96:27,97:30,65:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,231:39,199:39,222:43,126:43,94:43,176:43,92:41,124:41,60:86,62:86,122:44,90:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,59:51,46:52,58:52,45:53,95:53,13:28,226:30,194:30,225:30,224:30,227:30,228:30,234:18,202:18,233:18,232:18,200:18,235:18,238:23,206:23,237:23,236:23,204:23,239:23,244:24,212:24,243:24,242:24,210:24,245:24,246:24,251:22,219:22,250:22,249:22,217:22,252:22,241:49,5:6,29:10,91:9,123:88},WMKS.CONST.KB.VScanMap["fr-FR"]={32:57,97:16,65:16,226:16,227:16,228:16,122:17,90:17,101:18,69:18,234:18,235:18,114:19,82:19,116:20,84:20,121:21,89:21,255:21,117:22,85:22,251:22,252:22,105:23,73:23,238:23,239:23,111:24,79:24,244:24,245:24,246:24,112:25,80:25,113:30,81:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,109:39,77:39,49:2,38:2,50:3,233:3,201:3,51:4,34:4,52:5,39:5,53:6,40:6,54:7,45:7,55:8,232:8,56:9,95:9,295:7,57:10,231:10,48:11,224:11,60:86,62:86,119:44,87:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,44:50,63:50,59:51,46:51,47:52,58:52,36:27,29:27,163:27,94:26,221:26,168:26,219:26,160:26,249:40,37:40,42:43,181:43,178:41,41:12,176:12,61:13,43:13,33:53,167:53,35:4,64:11,91:6,93:12,169:12,31:13,173:13,123:5,125:13,8364:18,5:18,124:7,164:27,126:3,92:9,94:10,28:10,96:8,13:28},WMKS.CONST.KB.VScanMap["fr-CH"]={32:57,49:2,43:2,166:2,50:3,34:3,64:3,51:4,42:4,35:4,52:5,231:5,53:6,37:6,54:7,38:7,172:7,55:8,47:8,124:8,56:9,40:9,162:9,57:10,41:10,48:11,61:11,39:12,63:12,222:12,31:12,219:12,180:12,187:13,160:13,126:13,94:13,113:16,81:16,119:17,87:17,101:18,69:18,8364:18,5:18,234:18,235:18,114:19,82:19,116:20,84:20,122:21,90:21,117:22,85:22,251:22,250:22,249:22,105:23,73:23,238:23,239:23,237:23,236:23,111:24,79:24,245:24,244:24,243:24,242:24,112:25,80:25,97:30,65:30,226:30,227:30,225:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,60:86,62:86,96:86,92:86,121:44,89:44,255:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,59:51,46:52,58:52,45:53,95:53,226:30,194:30,196:30,193:30,225:30,224:30,227:30,228:30,195:30,234:18,202:18,201:18,203:18,233:18,232:18,200:18,235:18,238:23,206:23,205:23,207:23,237:23,236:23,204:23,239:23,244:24,212:24,211:24,214:24,243:24,242:24,210:24,245:24,246:24,213:24,251:22,218:22,220:22,250:22,249:22,217:22,252:22,233:39,232:26,91:26,224:40,123:40,1224:40,246:39,252:26,228:40,221:27,161:27,192:27,168:27,29:27,33:27,93:27,36:43,125:43,28:43,164:43,163:43,167:41,176:41,13:28},WMKS.CONST.KB.VScanMap["de-CH"]={32:57,49:2,43:2,166:2,50:3,34:3,64:3,51:4,42:4,35:4,52:5,231:5,53:6,37:6,54:7,38:7,172:7,55:8,47:8,124:8,56:9,40:9,162:9,57:10,41:10,48:11,61:11,39:12,63:12,222:12,31:12,219:12,180:12,187:13,160:13,126:13,94:13,113:16,81:16,119:17,87:17,101:18,69:18,8364:18,5:18,234:18,235:18,114:19,82:19,116:20,84:20,122:21,90:21,117:22,85:22,251:22,250:22,249:22,105:23,73:23,238:23,239:23,237:23,236:23,111:24,79:24,245:24,244:24,243:24,242:24,112:25,80:25,97:30,65:30,226:30,227:30,225:30,115:31,83:31,100:32,68:32,102:33,70:33,103:34,71:34,104:35,72:35,106:36,74:36,107:37,75:37,108:38,76:38,60:86,62:86,96:86,92:86,121:44,89:44,255:44,120:45,88:45,99:46,67:46,118:47,86:47,98:48,66:48,110:49,78:49,109:50,77:50,44:51,59:51,46:52,58:52,45:53,95:53,226:30,194:30,196:40,193:30,225:30,224:30,227:30,228:30,195:30,234:18,202:18,201:39,203:18,233:18,232:18,200:26,235:18,238:23,206:23,205:23,207:23,237:23,236:23,204:23,239:23,244:24,212:24,211:24,214:39,243:24,242:24,210:24,245:24,246:24,213:24,251:22,218:22,220:26,250:22,249:22,217:22,252:22,233:39,232:26,91:26,224:40,123:40,1224:40,246:39,252:26,228:40,221:27,161:27,192:27,168:27,29:27,33:27,93:27,36:43,125:43,28:43,164:43,163:43,167:41,176:41,1167:41,1176:41,13:28},$.widget("wmks.nwmks",$.wmks.wmks,{options:{rescale:!0,position:WMKS.CONST.Position.CENTER,changeResolution:!0,audioEncodeType:null,useNativePixels:!1,useUnicodeKeyboardInput:!1,useVNCHandshake:!0,sendProperMouseWheelDeltas:!1,reverseScrollY:!1,retryConnectionInterval:-1,ignoredRawKeyCodes:[],fixANSIEquivalentKeys:!1,disableVscanKeyboard:!1},_create:function(){if(this.options.changeResolution&&(this.options.fitGuest=!0),this.options.audioEncodeType){const e=WMKS.CONST.AudioEncodeType;switch(this.options.audioEncodeType){case e.AAC:this.options.enableAacAudioClips=!0;break;case e.OPUS:this.options.enableOpusAudioClips=!0;break;case e.VORBIS:this.options.enableVorbisAudioClips=!0}}this.element.unbind(),WMKS.widgetProto._create.apply(this)},_init:function(){const e=this,t=function(t){return void 0!==e._canvas[0].style[t]?t:null};this.transformOrigin=t("transformOrigin")||t("WebkitTransformOrigin")||t("MozTransformOrigin")||t("msTransformOrigin")||t("OTransformOrigin")},rescaleOrResize:function(e){let t=1,i=0,s=0,n="center center";const o=this.element.width(),r=this.element.height();this._canvas.css({width:this._guestWidth/this._pixelRatio,height:this._guestHeight/this._pixelRatio});const a=this._canvas.width(),c=this._canvas.height();if(e&&this.options.changeResolution&&this.updateFitGuestSize(!0),null!==this.transform){if(this.options.rescale){const e=o/a,i=r/c;t=Math.max(.1,Math.min(e,i))}if(null!==this.options.position)switch(this.options.position){case WMKS.CONST.Position.CENTER:i=(o-a)/2,s=(r-c)/2;break;case WMKS.CONST.Position.LEFT_TOP:n="left top"}t!==this._scale&&(this._scale=t,this._canvas.css(this.transform,"scale("+this._scale+")"),this._canvas.css(this.transformOrigin,n)),i===this._x&&s===this._y||(this._x=i,this._y=s,this._canvas.css({top:s,left:i}))}else WMKS.LOGGER.warn("No scaling support")},_setOption:function(e,t){switch($.Widget.prototype._setOption.apply(this,arguments),e){case"rescale":case"position":case"changeResolution":this.rescaleOrResize(!0);break;case"useNativePixels":if(t&&!WMKS.UTIL.isHighResolutionSupported())return void WMKS.LOGGER.warn("Browser/device does not support this feature.");this._updatePixelRatio(),this.rescaleOrResize(!0);break;case"fixANSIEquivalentKeys":this._keyboardManager.fixANSIEquivalentKeys=t;break;case"keyboardLayoutId":this._keyboardManager.keyboardLayoutId=t,this._keyboardManager.UnicodeToVScanMap=WMKS.CONST.KB.VScanMap[t];break;case"sendRelativeMouseEvent":this._vncDecoder.options.sendRelativeMouseEvent=t}},setRemoteScreenSize:function(e,t){const i=e*this._pixelRatio,s=t*this._pixelRatio;!this.options.changeResolution||this._guestWidth===i&&this._guestHeight===s||this._vncDecoder.onRequestResolution(i,s)}}),WMKS.CoreWMKS=function(e){this.wmks=e,this.wmksData=e.data("nwmks")||e.data("wmks-nwmks"),this.oldCssText="",this.connectionState=WMKS.CONST.ConnectionState.DISCONNECTED,this.eventHandlers={};const t=this.wmksData.widgetEventPrefix,i=this,s=function(t,s,n){const o=i.eventHandlers[t];if(o&&o.length>0){const t=o.length;for(let i=0;i<t;i++)o[i].apply(e,[s,n])}},n=[t+"connecting",t+"connected",t+"disconnected"].join(" ");e.bind(n,function(e,n){n=n||{};const o=e.type;i.connectionState=o.substring(t.length,o.length),n.state=i.connectionState,s(WMKS.CONST.Events.CONNECTION_STATE_CHANGE,e,n)});const o=[t+"authenticationfailed",t+"error",t+"protocolerror"].join(" ");e.bind(o,function(e,i){let n;const o=WMKS.CONST.ErrorType;switch(type=e.type.substring(t.length,e.type.length),i=i||{},type){case"authenticationfailed":n=o.AUTHENTICATION_FAILED;break;case"error":n=o.WEBSOCKET_ERROR;break;case"protocolerror":n=o.PROTOCOL_ERROR}n&&(i.errorType=n,s(WMKS.CONST.Events.ERROR,e,i))}),e.bind(t+"resolutionchanged",function(e,t){s(WMKS.CONST.Events.REMOTE_SCREEN_SIZE_CHANGE,e,t)});const r=[t+"keyboardledschanged",t+"heartbeat",t+"copy",t+"audio",t+"toggle"].join(" ");e.bind(r,function(e,i){const n=e.type.substring(t.length,e.type.length);"toggle"==n&&(i={type:arguments[1],visibility:arguments[2]}),s(n,e,i)});const a=function(e){WMKS.UTIL.isFullscreenNow()&&(i.wmks[0].style.cssText="position:fixed; margin:0px; left:0px; top:0px; height:"+window.innerHeight+"px;width:"+window.innerWidth+"px;",i.wmksData.rescaleOrResize(!0),s(WMKS.CONST.Events.FULL_SCREEN_CHANGE,e,{isFullScreen:!0}))};var c=function(e){$(window).off("resize.wmks",a),i.wmks[0].style.cssText=i.oldCssText,i.wmksData.rescaleOrResize(!0),$(window).off("resize.wmks",c),s(WMKS.CONST.Events.FULL_SCREEN_CHANGE,e,{isFullScreen:!1})};this.fullScreenChangeEventStr=["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"].join(" "),this.fullScreenChangeHandler=function(e){WMKS.UTIL.isFullscreenNow()||c(e)},$(document).on(this.fullScreenChangeEventStr,this.fullScreenChangeHandler),WMKS.CoreWMKS.prototype.enterFullScreen=function(){!WMKS.UTIL.isFullscreenNow()&&WMKS.UTIL.isFullscreenEnabled()&&(this.oldCssText=e[0].style.cssText,console.log("old css is "+this.oldCssText),$(window).off("resize.wmks",a),$(window).on("resize.wmks",a),WMKS.UTIL.toggleFullScreen(!0,e[0]))},WMKS.CoreWMKS.prototype.exitFullScreen=function(){WMKS.UTIL.isFullscreenNow()&&($(window).on("resize.wmks",c),WMKS.UTIL.toggleFullScreen(!1))}},WMKS.CoreWMKS.prototype.register=function(e,t){if(!e||!t)return;let i=this.eventHandlers[e];return i||(i=this.eventHandlers[e]=[]),i.push(t),this},WMKS.CoreWMKS.prototype.unregister=function(e,t){if(!e&&!t)return this.eventHandlers={},this;if(e&&!t)return delete this.eventHandlers[e],this;const i=this.eventHandlers[e];if(i&&i.length>0){const s=i.length;for(let e=0;e<s;e++)if(i[e]===t){i.splice(e,1);break}0===i.length&&delete this.eventHandlers[e]}return this},WMKS.CoreWMKS.prototype.getVersion=function(){return WMKS.version},WMKS.CoreWMKS.prototype.getConnectionState=function(){return this.connectionState},WMKS.CoreWMKS.prototype.connect=function(e){this.wmksData.connect(e)},WMKS.CoreWMKS.prototype.disconnect=function(){this.wmksData.disconnect()},WMKS.CoreWMKS.prototype.destroy=function(){this.wmksData&&(clearTimeout(this.wmksData._vncDecoder.resolutionTimer),this.wmksData.destroy()),$(document).off(this.fullScreenChangeEventStr,this.fullScreenChangeHandler),$(window).off("resize.wmks"),this.wmksData=null,this.wmks=null},WMKS.CoreWMKS.prototype.setRemoteScreenSize=function(e,t){this.wmksData.setRemoteScreenSize(e,t)},WMKS.CoreWMKS.prototype.getRemoteScreenSize=function(){return{width:this.wmksData._guestWidth,height:this.wmksData._guestHeight}},WMKS.CoreWMKS.prototype.updateScreen=function(){this.wmksData.rescaleOrResize(!0)},WMKS.CoreWMKS.prototype.canFullScreen=function(){return WMKS.UTIL.isFullscreenEnabled()},WMKS.CoreWMKS.prototype.isFullScreen=function(){return WMKS.UTIL.isFullscreenNow()},WMKS.CoreWMKS.prototype.sendInputString=function(e){this.wmksData.sendInputString(e)},WMKS.CoreWMKS.prototype.sendKeyCodes=function(e,t){this.wmksData.sendKeyCodes(e,t)},WMKS.CoreWMKS.prototype.sendCAD=function(){this.wmksData.sendKeyCodes([17,18,46],[29,56,339])},WMKS.CoreWMKS.prototype.showKeyboard=function(){this.wmksData.showKeyboard()},WMKS.CoreWMKS.prototype.hideKeyboard=function(){this.wmksData.hideKeyboard()},WMKS.CoreWMKS.prototype.toggleExtendedKeypad=function(e){this.wmksData.toggleExtendedKeypad(e)},WMKS.CoreWMKS.prototype.toggleTrackpad=function(e){this.wmksData.toggleTrackpad(e)},WMKS.CoreWMKS.prototype.toggleRelativePad=function(e){this.wmksData.toggleRelativePad(e)},WMKS.CoreWMKS.prototype.enableInputDevice=function(e){const t=WMKS.CONST.InputDeviceType;switch(innerType=null,e){case t.KEYBOARD:this.wmksData.options.allowMobileKeyboardInput=!0,innerType=WMKS.CONST.TOUCH.FEATURE.SoftKeyboard;break;case t.EXTENDED_KEYBOARD:this.wmksData.options.allowMobileExtendedKeypad=!0,innerType=WMKS.CONST.TOUCH.FEATURE.ExtendedKeypad;break;case t.TRACKPAD:this.wmksData.options.allowMobileTrackpad=!0,innerType=WMKS.CONST.TOUCH.FEATURE.Trackpad}null!==innerType&&(this.wmksData._updateMobileFeature(!1,innerType),this.wmksData._updateMobileFeature(!0,innerType))},WMKS.CoreWMKS.prototype.disableInputDevice=function(e){const t=WMKS.CONST.InputDeviceType;switch(e){case t.KEYBOARD:this.wmksData.options.allowMobileKeyboardInput=!1,this.wmksData._updateMobileFeature(!1,WMKS.CONST.TOUCH.FEATURE.SoftKeyboard);break;case t.EXTENDED_KEYBOARD:this.wmksData.options.allowMobileExtendedKeypad=!1,this.wmksData._updateMobileFeature(!1,WMKS.CONST.TOUCH.FEATURE.ExtendedKeypad);break;case t.TRACKPAD:this.wmksData.options.allowMobileTrackpad=!1,this.wmksData._updateMobileFeature(!1,WMKS.CONST.TOUCH.FEATURE.Trackpad)}},WMKS.CoreWMKS.prototype.setOption=function(e,t){this.wmksData._setOption(e,t)},WMKS.createWMKS=function(e,t){if(!e||!$("#"+e))throw new Error("Invalid parameter");const i=$("#"+e).nwmks(t);return new WMKS.CoreWMKS(i)},WMKS.buildNumber="11613346",WMKS.version="2.1.0";export{WMKS};